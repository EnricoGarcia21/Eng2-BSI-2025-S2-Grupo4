<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DOARC - Cadastro de Volunt√°rio</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        /* Estilos para garantir funcionamento */
        .login-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; background: #f5f5f5; padding: 1rem; }
        .login-card { background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); width: 100%; }
        .login-header { text-align: center; margin-bottom: 2rem; }
        .login-title { margin: 0; color: #333; }
        .login-subtitle { margin: 0.5rem 0 0 0; color: #666; }
        .form-row { display: flex; gap: 1rem; margin-bottom: 1rem; }
        .form-group { flex: 1; }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: #333; }
        .required::after { content: " *"; color: red; }
        .form-control { width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .form-error { color: red; font-size: 0.875rem; margin-top: 0.25rem; display: none; }
        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-primary:hover { background-color: #0056b3; }
        .text-center { text-align: center; }
    </style>
</head>
<body>
    <div class="login-container">
        <div class="login-card" style="max-width: 600px;">
            <div class="login-header">
                <h1 class="login-title">Cadastro de Volunt√°rio</h1>
                <p class="login-subtitle">Preencha os dados para criar sua conta</p>
            </div>

            <form id="registerForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="nome" class="form-label required">Nome Completo</label>
                        <input
                            type="text"
                            id="nome"
                            class="form-control"
                            placeholder="Digite seu nome completo"
                            required
                        >
                        <div class="form-error">Nome √© obrigat√≥rio</div>
                    </div>

                    <div class="form-group">
                        <label for="cpf" class="form-label required">CPF</label>
                        <input
                            type="text"
                            id="cpf"
                            class="form-control"
                            placeholder="000.000.000-00"
                            required
                        >
                        <div class="form-error">CPF inv√°lido</div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="email" class="form-label required">E-mail</label>
                        <input
                            type="email"
                            id="email"
                            class="form-control"
                            placeholder="seu@email.com"
                            required
                        >
                        <div class="form-error">E-mail inv√°lido</div>
                    </div>

                    <div class="form-group">
                        <label for="telefone" class="form-label required">Telefone</label>
                        <input
                            type="tel"
                            id="telefone"
                            class="form-control"
                            placeholder="(00) 00000-0000"
                            required
                        >
                        <div class="form-error">Telefone inv√°lido</div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="dataNascimento" class="form-label required">Data de Nascimento</label>
                        <input
                            type="date"
                            id="dataNascimento"
                            class="form-control"
                            required
                        >
                        <div class="form-error">Data de nascimento √© obrigat√≥ria</div>
                    </div>

                    <div class="form-group">
                        <label for="sexo" class="form-label required">Sexo</label>
                        <select id="sexo" class="form-control" required>
                            <option value="">Selecione</option>
                            <option value="M">Masculino</option>
                            <option value="F">Feminino</option>
                        </select>
                        <div class="form-error">Sexo √© obrigat√≥rio</div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="rua" class="form-label">Rua</label>
                        <input
                            type="text"
                            id="rua"
                            class="form-control"
                            placeholder="Nome da rua"
                        >
                    </div>

                    <div class="form-group">
                        <label for="numero" class="form-label">N√∫mero</label>
                        <input
                            type="text"
                            id="numero"
                            class="form-control"
                            placeholder="N√∫mero"
                        >
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="bairro" class="form-label">Bairro</label>
                        <input
                            type="text"
                            id="bairro"
                            class="form-control"
                            placeholder="Bairro"
                        >
                    </div>

                    <div class="form-group">
                        <label for="cidade" class="form-label">Cidade</label>
                        <input
                            type="text"
                            id="cidade"
                            class="form-control"
                            placeholder="Cidade"
                        >
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="cep" class="form-label">CEP</label>
                        <input
                            type="text"
                            id="cep"
                            class="form-control"
                            placeholder="00000-000"
                        >
                    </div>

                    <div class="form-group">
                        <label for="uf" class="form-label">UF</label>
                        <select id="uf" class="form-control">
                            <option value="">Selecione</option>
                            <option value="SP">SP</option>
                            <option value="RJ">RJ</option>
                            <option value="MG">MG</option>
                            <!-- outros estados -->
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="password" class="form-label required">Senha</label>
                        <input
                            type="password"
                            id="password"
                            class="form-control"
                            placeholder="M√≠nimo 6 caracteres"
                            required
                        >
                        <div class="form-error">Senha deve ter no m√≠nimo 6 caracteres</div>
                    </div>

                    <div class="form-group">
                        <label for="confirmPassword" class="form-label required">Confirmar Senha</label>
                        <input
                            type="password"
                            id="confirmPassword"
                            class="form-control"
                            placeholder="Digite a senha novamente"
                            required
                        >
                        <div class="form-error">As senhas n√£o coincidem</div>
                    </div>
                </div>

                <div class="form-group">
                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        Cadastrar
                    </button>
                </div>

                <div class="text-center">
                    <p style="margin-top: 1rem; color: #666;">
                        J√° tem uma conta?
                        <a href="index.html" style="color: #007bff; text-decoration: none; font-weight: 500;">
                            Fa√ßa login aqui
                        </a>
                    </p>
                </div>
            </form>
        </div>
    </div>

    <script>
    // Simula√ß√£o das fun√ß√µes UI e Validator
    const UI = {
        showAlert: (message, type) => {
            // Se estiver em um ambiente web real, voc√™ usaria uma notifica√ß√£o mais amig√°vel
            console.log(`${type.toUpperCase()}: ${message}`);
            alert(`${type.toUpperCase()}: ${message}`);
        }
    };

    const Validator = {
        isEmpty: (value) => !value || value.trim() === '',
        isValidCPF: (cpf) => {
            const cleanCPF = cpf.replace(/[^\d]/g, '');
            return cleanCPF.length === 11;
        },
        isValidEmail: (email) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email),
        isValidPhone: (phone) => {
            const cleanPhone = phone.replace(/[^\d]/g, '');
            return cleanPhone.length >= 10 && cleanPhone.length <= 11;
        },
        
        // üö® NOVO M√âTODO: Valida√ß√£o de maior de 18 anos
        isOver18: (dateString) => {
            if (!dateString) return false;

            const today = new Date();
            const birthDate = new Date(dateString);
            
            // Calcula a diferen√ßa de anos
            let age = today.getFullYear() - birthDate.getFullYear();
            
            // Ajusta se o anivers√°rio deste ano ainda n√£o ocorreu
            const m = today.getMonth() - birthDate.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            return age >= 18;
        },
        
        showError: (input, message) => {
            let errorElement = input.nextElementSibling;
            if (!errorElement || !errorElement.classList.contains('form-error')) {
                errorElement = document.createElement('div');
                errorElement.className = 'form-error';
                errorElement.style.color = 'red'; // Para garantir a visibilidade do erro
                input.parentNode.insertBefore(errorElement, input.nextSibling);
            }
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            input.style.borderColor = 'red';
        },
        clearAllErrors: (form) => {
            const errors = form.querySelectorAll('.form-error');
            const inputs = form.querySelectorAll('input, select');
            errors.forEach(error => error.style.display = 'none');
            inputs.forEach(input => input.style.borderColor = '');
        }
    };

    document.getElementById('registerForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        // üö® Obtendo refer√™ncias aos inputs (mantido)
        const nome = document.getElementById('nome');
        const cpf = document.getElementById('cpf');
        const email = document.getElementById('email');
        const telefone = document.getElementById('telefone');
        const dataNascimento = document.getElementById('dataNascimento');
        const sexo = document.getElementById('sexo');
        const rua = document.getElementById('rua');
        const numero = document.getElementById('numero');
        const bairro = document.getElementById('bairro');
        const cidade = document.getElementById('cidade');
        const cep = document.getElementById('cep');
        const uf = document.getElementById('uf');
        const password = document.getElementById('password');
        const confirmPassword = document.getElementById('confirmPassword');

        // Limpa erros anteriores
        Validator.clearAllErrors(this);

        // Valida√ß√µes
        let isValid = true;

        // --- Valida√ß√µes Existentes ---
        if (Validator.isEmpty(nome.value)) { Validator.showError(nome, 'Nome √© obrigat√≥rio'); isValid = false; }
        if (Validator.isEmpty(cpf.value)) { Validator.showError(cpf, 'CPF √© obrigat√≥rio'); isValid = false; } else if (!Validator.isValidCPF(cpf.value)) { Validator.showError(cpf, 'CPF inv√°lido'); isValid = false; }
        if (Validator.isEmpty(email.value)) { Validator.showError(email, 'E-mail √© obrigat√≥rio'); isValid = false; } else if (!Validator.isValidEmail(email.value)) { Validator.showError(email, 'E-mail inv√°lido'); isValid = false; }
        if (Validator.isEmpty(telefone.value)) { Validator.showError(telefone, 'Telefone √© obrigat√≥rio'); isValid = false; } else if (!Validator.isValidPhone(telefone.value)) { Validator.showError(telefone, 'Telefone inv√°lido'); isValid = false; }
        
        // üö® VALIDA√á√ÉO DE DATA DE NASCIMENTO E IDADE (CORRIGIDO)
        if (Validator.isEmpty(dataNascimento.value)) {
            Validator.showError(dataNascimento, 'Data de nascimento √© obrigat√≥ria');
            isValid = false;
        } else if (!Validator.isOver18(dataNascimento.value)) {
            Validator.showError(dataNascimento, '√â necess√°rio ter 18 anos ou mais para se registrar.');
            isValid = false;
        }
        
        if (Validator.isEmpty(sexo.value)) { Validator.showError(sexo, 'Sexo √© obrigat√≥rio'); isValid = false; }
        
        // --- Valida√ß√µes de Endere√ßo (adicionando para garantir campos no envio) ---
        if (Validator.isEmpty(rua.value)) { Validator.showError(rua, 'Rua √© obrigat√≥ria'); isValid = false; }
        if (Validator.isEmpty(bairro.value)) { Validator.showError(bairro, 'Bairro √© obrigat√≥rio'); isValid = false; }
        if (Validator.isEmpty(cidade.value)) { Validator.showError(cidade, 'Cidade √© obrigat√≥ria'); isValid = false; }
        if (Validator.isEmpty(cep.value)) { Validator.showError(cep, 'CEP √© obrigat√≥rio'); isValid = false; }
        if (Validator.isEmpty(uf.value)) { Validator.showError(uf, 'UF √© obrigat√≥ria'); isValid = false; }


        // --- Valida√ß√µes de Senha ---
        if (Validator.isEmpty(password.value)) { Validator.showError(password, 'Senha √© obrigat√≥ria'); isValid = false; } 
        else if (password.value.length < 6) { Validator.showError(password, 'Senha deve ter no m√≠nimo 6 caracteres'); isValid = false; }

        if (password.value !== confirmPassword.value) { Validator.showError(confirmPassword, 'As senhas n√£o coincidem'); isValid = false; }

        if (!isValid) return;

        try {
            // üö® CORRE√á√ÉO NA FETCH API
            const response = await fetch('http://localhost:8080/apis/acesso/registrar', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json' // O Spring no backend espera JSON
                },
                body: JSON.stringify({
                    // Dados do Volunt√°rio (com dados limpos)
                    nome: nome.value,
                    cpf: cpf.value.replace(/[^\d]/g, ''),
                    email: email.value,
                    telefone: telefone.value.replace(/[^\d]/g, ''),
                    dataNascimento: dataNascimento.value,
                    sexo: sexo.value,
                    rua: rua.value,
                    numero: numero.value,
                    bairro: bairro.value,
                    cidade: cidade.value,
                    cep: cep.value.replace(/[^\d]/g, ''), // Limpa o CEP
                    uf: uf.value,
                    
                    // Dados de Acesso (Login/Credenciais)
                    login: email.value, // üö® Adicionamos o campo 'login' usando o email
                    senha: password.value 
                })
            });

            const resultado = await response.json();

            if (response.ok) {
                UI.showAlert(resultado.mensagem || 'Cadastro realizado com sucesso!', 'success');

                // Redireciona ap√≥s 2 segundos
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);
            } else {
                UI.showAlert('Erro: ' + (resultado.mensagem || 'Erro desconhecido ao realizar cadastro'), 'error');
            }

        } catch (error) {
            console.error('Erro na requisi√ß√£o:', error);
            UI.showAlert('Erro ao realizar cadastro. Verifique a conex√£o com a API.', 'error');
        }
    });

    // --- M√°scaras Simples (Mantidas) ---
    
    document.getElementById('cpf').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length <= 11) {
            value = value.replace(/(\d{3})(\d)/, '$1.$2')
                        .replace(/(\d{3})(\d)/, '$1.$2')
                        .replace(/(\d{3})(\d{1,2})$/, '$1-$2');
        }
        e.target.value = value;
    });

    document.getElementById('telefone').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length <= 11) {
            value = value.replace(/(\d{2})(\d)/, '($1) $2')
                        .replace(/(\d{5})(\d)/, '$1-$2');
        }
        e.target.value = value;
    });

    document.getElementById('cep').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length <= 8) {
            value = value.replace(/(\d{5})(\d)/, '$1-$2');
        }
        e.target.value = value;
    });
</script>
</body>
</html>