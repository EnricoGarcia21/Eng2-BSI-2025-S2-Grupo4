<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DOARC - Gerenciar Categorias</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <header class="header">
        <div class="header-content">
            <a href="dashboard.html" class="logo">DOARC</a>
            <div class="user-menu">
                <span class="user-name" id="userName">Volunt√°rio</span>
                <button class="btn-logout" id="logoutBtn">Sair</button>
            </div>
        </div>
    </header>

    <nav class="nav">
        <ul class="nav-list">
            <li class="nav-item"><a href="dashboard.html" class="nav-link">Dashboard</a></li>
            <li class="nav-item">
                <a href="#" class="nav-link active">Gerenciar</a>
                <ul class="submenu">
                    <li class="submenu-item"><a href="gerenciar-doadores.html" class="submenu-link">Doadores</a></li>
                    <li class="submenu-item"><a href="gerenciar-donatarios.html" class="submenu-link">Donat√°rios</a></li>
                    <li class="submenu-item"><a href="gerenciar-produtos.html" class="submenu-link">Produtos</a></li>
                    <li class="submenu-item"><a href="gerenciar-categorias.html" class="submenu-link">Categorias</a></li>
                    <li class="submenu-item"><a href="gerenciar-voluntarios.html" class="submenu-link">Volunt√°rios</a></li>
                    <li class="submenu-item"><a href="gerenciar-campanhas.html" class="submenu-link">Campanhas</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link">Doa√ß√µes</a>
                <ul class="submenu">
                    <li class="submenu-item"><a href="receber-doacoes.html" class="submenu-link">Receber Doa√ß√µes</a></li>
                    <li class="submenu-item"><a href="efetuar-doacoes.html" class="submenu-link">Efetuar Doa√ß√µes</a></li>
                    <li class="submenu-item"><a href="agendar-doacao.html" class="submenu-link">Agendar Doa√ß√£o</a></li>
                    <li class="submenu-item"><a href="agendar-retirada.html" class="submenu-link">Agendar Retirada</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link">Estoque</a>
                <ul class="submenu">
                    <li class="submenu-item"><a href="visualizar-estoque.html" class="submenu-link">Visualizar Estoque</a></li>
                    <li class="submenu-item"><a href="registrar-acerto.html" class="submenu-link">Acerto de Estoque</a></li>
                    <li class="submenu-item"><a href="lancar-compra.html" class="submenu-link">Lan√ßar Compra/Arrecada√ß√£o</a></li>
                    <li class="submenu-item"><a href="agendar-higienizacao.html" class="submenu-link">Agendar Higieniza√ß√£o</a></li>
                </ul>
            </li>
            <li class="nav-item"><a href="relatorios.html" class="nav-link">Relat√≥rios</a></li>
        </ul>
    </nav>

    <main class="container">
        <div class="breadcrumb">
            <div class="breadcrumb-item"><a href="dashboard.html">Dashboard</a></div>
            <div class="breadcrumb-item">Gerenciar</div>
            <div class="breadcrumb-item active">Categorias</div>
        </div>

        <div class="card">
            <div class="card-header">
                <h1 class="card-title">Gerenciar Categorias</h1>
                <p class="card-subtitle">Organize os produtos em categorias</p>
            </div>
            <div class="card-body">
                <div style="display: flex; justify-content: space-between; margin-bottom: 1.5rem;">
                    <input type="text" id="searchInput" class="form-control" placeholder="Buscar categoria..." style="max-width: 400px;">
                    <button class="btn btn-primary" onclick="openModal('modalCategoria')">‚ûï Nova Categoria</button>
                </div>

                <div class="table-container">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nome</th>
                                <th>Especifica√ß√£o</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaCategorias">
                            <!-- Dados carregados via API -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <div id="modalCategoria" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Nova Categoria</h2>
                <button class="modal-close" onclick="closeModal('modalCategoria')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="formCategoria">
                    <input type="hidden" id="categoriaId">
                    <div class="form-group">
                        <label for="nome" class="form-label required">Nome da Categoria</label>
                        <input type="text" id="nome" class="form-control" required>
                        <div class="form-error">Nome √© obrigat√≥rio</div>
                    </div>
                    <div class="form-group">
                        <label for="especificacao" class="form-label">Especifica√ß√£o</label>
                        <textarea id="especificacao" class="form-control" rows="3" placeholder="Descreva os detalhes da categoria (opcional)"></textarea>
                        <div class="form-error">Especifica√ß√£o muito longa (m√°ximo 130 caracteres)</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('modalCategoria')">Cancelar</button>
                <button class="btn btn-primary" onclick="salvarCategoria()">Salvar</button>
            </div>
        </div>
    </div>

    <script src="../js/app.js"></script>
    <script>
        // API Base URL - Backend Spring Boot
        const API_BASE = 'http://localhost:8080/apis/categoria';

        // Carrega as categorias ao iniciar a p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            carregarCategorias();
        });

        // Busca em tempo real
        document.getElementById('searchInput').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('#tabelaCategorias tr');
            rows.forEach(row => {
                row.style.display = row.textContent.toLowerCase().includes(searchTerm) ? '' : 'none';
            });
        });

        async function carregarCategorias() {
            try {
                console.log('Carregando categorias de:', API_BASE);
                const response = await fetch(API_BASE);

                if (!response.ok) {
                    console.error('Status da resposta:', response.status);
                    throw new Error(`Erro HTTP: ${response.status}`);
                }

                const categorias = await response.json();
                console.log('Categorias recebidas:', categorias);

                const tbody = document.getElementById('tabelaCategorias');
                tbody.innerHTML = '';

                if (!categorias || categorias.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">Nenhuma categoria cadastrada</td></tr>';
                    return;
                }

                categorias.forEach(cat => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${cat.id}</td>
                        <td>${cat.nome}</td>
                        <td>${cat.especificacao || '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="editarCategoria(${cat.id})">‚úèÔ∏è</button>
                            <button class="btn btn-sm btn-danger" onclick="excluirCategoria(${cat.id})">üóëÔ∏è</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (error) {
                console.error('Erro completo ao carregar:', error);
                alert('Erro ao carregar categorias. Verifique se o backend est√° rodando na porta 8080.');
            }
        }

        function openModal(modalId) {
            document.getElementById('formCategoria').reset();
            document.getElementById('categoriaId').value = '';
            document.getElementById('modalTitle').textContent = 'Nova Categoria';
            UI.openModal(modalId);
        }

        function closeModal(modalId) {
            UI.closeModal(modalId);
        }

        async function editarCategoria(id) {
            try {
                const response = await fetch(`${API_BASE}/${id}`);

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('Erro na resposta:', errorData);
                    throw new Error(errorData.mensagem || errorData.erro || 'Erro ao buscar categoria');
                }

                const categoria = await response.json();
                console.log('Categoria carregada:', categoria);

                // Verifica se h√° erro na resposta
                if (categoria.erro) {
                    throw new Error(categoria.erro);
                }

                document.getElementById('categoriaId').value = categoria.id;
                document.getElementById('modalTitle').textContent = 'Editar Categoria';
                document.getElementById('nome').value = categoria.nome || '';
                document.getElementById('especificacao').value = categoria.especificacao || '';
                UI.openModal('modalCategoria');
            } catch (error) {
                console.error('Erro completo:', error);
                alert('Erro ao carregar categoria: ' + error.message);
            }
        }

        async function excluirCategoria(id) {
            if (confirm('Tem certeza que deseja excluir esta categoria?')) {
                try {
                    const response = await fetch(`${API_BASE}/${id}`, {
                        method: 'DELETE'
                    });

                    const data = await response.json();

                    if (response.ok) {
                        alert(data.mensagem || 'Categoria exclu√≠da com sucesso!');
                        carregarCategorias();
                    } else {
                        // Mostra o erro espec√≠fico retornado pelo backend (vem no campo "mensagem")
                        alert(data.mensagem || 'Erro ao excluir categoria');
                    }
                } catch (error) {
                    console.error('Erro:', error);
                    alert('Erro ao excluir categoria: ' + error.message);
                }
            }
        }

        async function salvarCategoria() {
            const form = document.getElementById('formCategoria');
            const nome = document.getElementById('nome');
            const especificacao = document.getElementById('especificacao');

            Validator.clearAllErrors(form);

            if (Validator.isEmpty(nome.value)) {
                Validator.showError(nome, 'Nome √© obrigat√≥rio');
                return;
            }

            if (especificacao.value && especificacao.value.length > 130) {
                Validator.showError(especificacao, 'Especifica√ß√£o muito longa (m√°ximo 130 caracteres)');
                return;
            }

            try {
                const categoriaId = document.getElementById('categoriaId').value;

                let url = API_BASE;
                let method = 'POST';
                let params = new URLSearchParams();
                params.append('cat_nome', nome.value);
                params.append('cat_especificacao', especificacao.value || '');

                if (categoriaId) {
                    method = 'PUT';
                    params.append('cat_id', categoriaId);
                }

                const response = await fetch(`${url}?${params.toString()}`, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                });

                if (response.ok) {
                    alert(categoriaId ? 'Categoria atualizada com sucesso!' : 'Categoria cadastrada com sucesso!');
                    closeModal('modalCategoria');
                    carregarCategorias();
                } else {
                    const error = await response.json();
                    throw new Error(error.mensagem || 'Erro ao salvar categoria');
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao salvar categoria: ' + error.message);
            }
        }
    </script>
</body>
</html>
