<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DOARC - Gerenciar Campanhas</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <header class="header">
        <div class="header-content">
            <a href="dashboard.html" class="logo">DOARC</a>
            <div class="user-menu">
                <span class="user-name" id="userName">Volunt√°rio</span>
                <button class="btn-logout" id="logoutBtn">Sair</button>
            </div>
        </div>
    </header>

    <nav class="nav">
        <ul class="nav-list">
            <li class="nav-item"><a href="dashboard.html" class="nav-link">Dashboard</a></li>
            <li class="nav-item">
                <a href="#" class="nav-link active">Gerenciar</a>
                <ul class="submenu">
                    <li class="submenu-item"><a href="gerenciar-doadores.html" class="submenu-link">Doadores</a></li>
                    <li class="submenu-item"><a href="gerenciar-donatarios.html" class="submenu-link">Donat√°rios</a></li>
                    <li class="submenu-item"><a href="gerenciar-produtos.html" class="submenu-link">Produtos</a></li>
                    <li class="submenu-item"><a href="gerenciar-categorias.html" class="submenu-link">Categorias</a></li>
                    <li class="submenu-item"><a href="gerenciar-voluntarios.html" class="submenu-link">Volunt√°rios</a></li>
                    <li class="submenu-item"><a href="gerenciar-campanhas.html" class="submenu-link">Campanhas</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link">Doa√ß√µes</a>
                <ul class="submenu">
                    <li class="submenu-item"><a href="receber-doacoes.html" class="submenu-link">Receber Doa√ß√µes</a></li>
                    <li class="submenu-item"><a href="efetuar-doacoes.html" class="submenu-link">Efetuar Doa√ß√µes</a></li>
                    <li class="submenu-item"><a href="agendar-doacao.html" class="submenu-link">Agendar Doa√ß√£o</a></li>
                    <li class="submenu-item"><a href="agendar-retirada.html" class="submenu-link">Agendar Retirada</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link">Estoque</a>
                <ul class="submenu">
                    <li class="submenu-item"><a href="visualizar-estoque.html" class="submenu-link">Visualizar Estoque</a></li>
                    <li class="submenu-item"><a href="registrar-acerto.html" class="submenu-link">Acerto de Estoque</a></li>
                    <li class="submenu-item"><a href="lancar-compra.html" class="submenu-link">Lan√ßar Compra/Arrecada√ß√£o</a></li>
                    <li class="submenu-item"><a href="agendar-higienizacao.html" class="submenu-link">Agendar Higieniza√ß√£o</a></li>
                </ul>
            </li>
            <li class="nav-item"><a href="relatorios.html" class="nav-link">Relat√≥rios</a></li>
        </ul>
    </nav>

    <main class="container">
        <div class="breadcrumb">
            <div class="breadcrumb-item"><a href="dashboard.html">Dashboard</a></div>
            <div class="breadcrumb-item">Gerenciar</div>
            <div class="breadcrumb-item active">Campanhas</div>
        </div>

        <div class="card">
            <div class="card-header">
                <h1 class="card-title">Gerenciar Campanhas</h1>
                <p class="card-subtitle">Crie e gerencie campanhas de arrecada√ß√£o</p>
            </div>
            <div class="card-body">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        <input type="text" id="searchInput" class="form-control" placeholder="Buscar campanha..." style="max-width: 300px;">
                        <select id="filtroStatus" class="form-control form-select" style="max-width: 150px;" onchange="filtrarPorStatus()">
                            <option value="">Todos Status</option>
                            <option value="ativa">Ativa</option>
                            <option value="encerrada">Encerrada</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="openModal('modalCampanha')">‚ûï Nova Campanha</button>
                </div>

                <div class="table-container">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Nome/Descri√ß√£o</th>
                                <th>Per√≠odo</th>
                                <th>Respons√°vel (ID)</th>
                                <th>Meta</th>
                                <th>Progresso</th>
                                <th>Status</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaCampanhas">
<<<<<<< HEAD
                            <tr><td colspan="7" class="text-center">Carregando...</td></tr>
=======
                            <!-- As campanhas ser√£o carregadas via JavaScript -->
>>>>>>> f920d7edf7db4e47bf74d5fa54468951ca65c13a
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <div id="modalCampanha" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Nova Campanha</h2>
                <button class="modal-close" onclick="closeModal('modalCampanha')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="formCampanha">
                    <input type="hidden" id="campanhaId">
                    
                    <div class="form-group">
                        <label for="descricao" class="form-label required">Nome/Descri√ß√£o da Campanha</label>
                        <input type="text" id="descricao" class="form-control" required>
                        <div class="form-error">Descri√ß√£o √© obrigat√≥ria</div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="dataInicio" class="form-label required">Data In√≠cio</label>
                            <input type="date" id="dataInicio" class="form-control" required>
                            <div class="form-error">Data √© obrigat√≥ria</div>
                        </div>
                        <div class="form-group">
                            <label for="dataFim" class="form-label required">Data Fim</label>
                            <input type="date" id="dataFim" class="form-control" required>
                            <div class="form-error">Data √© obrigat√≥ria</div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="meta" class="form-label">Meta de Arrecada√ß√£o (R$)</label>
                            <input type="number" id="meta" class="form-control" step="0.01" min="0" placeholder="0,00">
                        </div>
                        <div class="form-group">
                            <label for="responsavel" class="form-label required">Volunt√°rio Respons√°vel</label>
                            <select id="responsavel" class="form-control form-select" required>
<<<<<<< HEAD
                                <option value="">Carregando...</option>
=======
                                <option value="">Selecione</option>
                                <!-- Os volunt√°rios ser√£o carregados via JavaScript -->
>>>>>>> f920d7edf7db4e47bf74d5fa54468951ca65c13a
                            </select>
                            <div class="form-error">Respons√°vel √© obrigat√≥rio</div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('modalCampanha')">Cancelar</button>
                <button class="btn btn-primary" onclick="salvarCampanha()">Salvar</button>
            </div>
        </div>
    </div>

    <div id="modalVoluntarios" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Equipe da Campanha</h2>
                <button class="modal-close" onclick="closeModal('modalVoluntarios')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="campanhaVoluntariosId">
<<<<<<< HEAD
                
=======
>>>>>>> f920d7edf7db4e47bf74d5fa54468951ca65c13a
                <div class="form-group">
                    <label for="addVoluntario" class="form-label">Adicionar Volunt√°rio √† Equipe</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <select id="addVoluntario" class="form-control form-select" style="flex: 1;">
                            <option value="">Selecione um volunt√°rio</option>
<<<<<<< HEAD
=======
                            <!-- Os volunt√°rios ser√£o carregados via JavaScript -->
>>>>>>> f920d7edf7db4e47bf74d5fa54468951ca65c13a
                        </select>
                        <button class="btn btn-success" onclick="adicionarVoluntario()">‚ûï Adicionar</button>
                    </div>
                </div>
                
                <h4 style="margin-top: 1.5rem; margin-bottom: 1rem; color: var(--primary-color);">Membros Atuais</h4>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ID Volunt√°rio</th>
                                <th>Observa√ß√£o</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaVoluntariosCampanha">
<<<<<<< HEAD
                            </tbody>
=======
                            <!-- Volunt√°rios ser√£o carregados dinamicamente -->
                        </tbody>
>>>>>>> f920d7edf7db4e47bf74d5fa54468951ca65c13a
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('modalVoluntarios')">Fechar</button>
            </div>
        </div>
    </div>

    <script src="../js/app.js"></script>
<<<<<<< HEAD
<script>
    // Configura√ß√£o da API
    const API_BASE_URL = 'http://localhost:8080/apis';

    // CACHE GLOBAL PARA CRUZAMENTO DE DADOS
    let listaVoluntariosCache = []; 
    let listaCampanhasCache = [];

    // ==========================================
    // üõ†Ô∏è FUN√á√ÉO FETCH API (COM AUTH)
    // ==========================================
    async function fetchAPI(endpoint, options = {}) {
        const token = localStorage.getItem('jwtToken') || localStorage.getItem('token');
        
        const defaultHeaders = {
            'Content-Type': 'application/json'
        };

        if (token) {
            defaultHeaders['Authorization'] = `Bearer ${token}`;
        } else {
            console.warn("‚ö†Ô∏è Sem token de autentica√ß√£o!");
        }

        const config = {
            ...options,
            headers: {
                ...defaultHeaders,
                ...options.headers
            }
        };

        try {
            const response = await fetch(`${API_BASE_URL}${endpoint}`, config);

            if (!response.ok) {
                const errorText = await response.text();
                let errorMsg = errorText;
                try {
                    const errorJson = JSON.parse(errorText);
                    errorMsg = errorJson.erro || errorJson.message || errorText;
                } catch(e) {}
                
                if (response.status === 401) {
                    UI.showAlert('Sess√£o expirada. Fa√ßa login novamente.', 'danger');
                    setTimeout(() => window.location.href = '../index.html', 2000);
                }
                
                throw new Error(errorMsg);
            }

            return await response.json();
        } catch (error) {
            console.error(`Erro na requisi√ß√£o ${endpoint}:`, error);
            throw error;
        }
    }

    // ==========================================
    // INICIALIZA√á√ÉO (COM PROTE√á√ÉO)
    // ==========================================
    document.addEventListener('DOMContentLoaded', async function() {
        // üîí PROTE√á√ÉO: Apenas Admin pode acessar esta p√°gina
        // Se n√£o for admin, a fun√ß√£o redireciona e retorna false
        if (!Auth.guardAdminRoute()) {
            return; 
        }

        // Nome do usu√°rio no header
        const user = Auth.getUser();
        if(user) document.getElementById('userName').textContent = user.nome || "Volunt√°rio";

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', (e) => {
            e.preventDefault();
            if (confirm('Deseja realmente sair?')) Auth.logout();
        });

        // 1. Carrega Volunt√°rios PRIMEIRO (para ter os nomes no cache)
        await carregarVoluntarios();
        
        // 2. Depois carrega as campanhas
        await carregarCampanhas();
        
        // Busca na tabela
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.addEventListener('input', function(e) {
                const term = e.target.value.toLowerCase();
                const rows = document.querySelectorAll('#tabelaCampanhas tr');
                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(term) ? '' : 'none';
                });
=======
   <script>
    // Configura√ß√£o da API
    const API_BASE_URL = 'http://localhost:8080/apis';
    
    // Headers padr√£o para as requisi√ß√µes
    const defaultHeaders = {
        'Content-Type': 'application/json',
    };

async function fetchAPI(endpoint, options = {}) {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 segundos timeout

    try {
        //console.log(`üåê Fazendo requisi√ß√£o para: ${API_BASE_URL}${endpoint}`);
        
        const response = await fetch(`${API_BASE_URL}${endpoint}`, {
            headers: { 
                'Content-Type': 'application/json',
                ...options.headers 
            },
            signal: controller.signal,
            ...options
        });

        clearTimeout(timeoutId);

       // console.log(`üì° Resposta recebida - Status: ${response.status}`);

        if (!response.ok) {
            const errorText = await response.text();
           // console.error(`‚ùå Erro HTTP ${response.status}:`, errorText);
            throw new Error(`Erro HTTP: ${response.status} - ${errorText}`);
        }

        const data = await response.json();
       // console.log(`‚úÖ Dados recebidos:`, data);
        return data;

    } catch (error) {
        clearTimeout(timeoutId);
        
        if (error.name === 'AbortError') {
            //console.error('‚è∞ Timeout na requisi√ß√£o:', error);
            UI.showAlert('Timeout na conex√£o com o servidor', 'error');
        } else {
           // console.error('üí• Erro na requisi√ß√£o:', error);
            UI.showAlert('Erro ao conectar com o servidor: ' + error.message, 'error');
        }
        throw error;
    }
}
    // Carregar dados iniciais quando a p√°gina carregar
    document.addEventListener('DOMContentLoaded', function() {
        carregarCampanhas();
        carregarVoluntarios();
    });

    // Fun√ß√£o para carregar campanhas
    async function carregarCampanhas() {
        try {
            const campanhas = await fetchAPI('/campanha');
            renderizarCampanhas(campanhas);
        } catch (error) {
            console.error('Erro ao carregar campanhas:', error);
        }
    }
    // FUN√á√ÉO PARA EXCLUIR CAMPANHA
async function excluirCampanha(id) {
    UI.confirm('Tem certeza que deseja EXCLUIR permanentemente esta campanha?', async function() {
        try {
            await fetchAPI(`/campanha/${id}`, {
                method: 'DELETE'
>>>>>>> f920d7edf7db4e47bf74d5fa54468951ca65c13a
            });
            
            UI.showAlert('Campanha exclu√≠da!', 'success');
            carregarCampanhas(); // Recarregar a lista
        } catch (error) {
           // console.error('Erro ao excluir campanha:', error);
            UI.showAlert('Erro ao excluir campanha. Certifique-se de que n√£o h√° dados vinculados.', 'error');
        }
    });
<<<<<<< HEAD

    // ==========================================
    // VOLUNT√ÅRIOS (CACHE E DROPDOWN)
    // ==========================================
    async function carregarVoluntarios() {
        const select = document.getElementById('responsavel');
        const selectAdd = document.getElementById('addVoluntario');
        
        try {
            // Busca da rota de admin para ter a lista completa
            const lista = await fetchAPI('/admin/voluntarios');

            // ‚úÖ ATUALIZA√á√ÉO: Guarda no cache global
            listaVoluntariosCache = Array.isArray(lista) ? lista : [];

            // Preenche os selects
            let html = '<option value="">Selecione...</option>';
            
            if (Array.isArray(lista)) {
                lista.forEach(vol => {
                    const id = vol.vol_id || vol.id;
                    const nome = vol.vol_nome || vol.nome || `Volunt√°rio ${id}`;
                    html += `<option value="${id}">${nome} (ID: ${id})</option>`;
                });
            }

            if(select) select.innerHTML = html;
            if(selectAdd) selectAdd.innerHTML = html;

        } catch (error) {
            console.warn('Erro ao carregar lista de volunt√°rios:', error);
        }
    }

    // ==========================================
    // CAMPANHAS
    // ==========================================
    async function carregarCampanhas() {
        try {
            const campanhas = await fetchAPI('/campanha');
            listaCampanhasCache = campanhas; // Guarda cache
            renderizarCampanhas(campanhas);
        } catch (error) {
            document.getElementById('tabelaCampanhas').innerHTML = 
                `<tr><td colspan="7" class="text-center text-danger">Erro ao carregar: ${error.message}</td></tr>`;
        }
    }

    function renderizarCampanhas(campanhas) {
        const tbody = document.getElementById('tabelaCampanhas');
        tbody.innerHTML = '';

        if (!campanhas || campanhas.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center">Nenhuma campanha encontrada.</td></tr>';
            return;
=======
}

    // FUN√á√ÉO PARA RENDERIZAR CAMPANHAS (ATUALIZADA COM BOT√ÉO DE EXCLUIR)
function renderizarCampanhas(campanhas) {
    const tbody = document.getElementById('tabelaCampanhas');
    tbody.innerHTML = '';

    campanhas.forEach(campanha => {
        const progresso = campanha.cam_meta_arrecadacao > 0 
            ? (campanha.cam_valor_arrecadado / campanha.cam_meta_arrecadacao) * 100 
            : 0;
        
        const status = new Date(campanha.cam_data_fim) >= new Date() ? 'Ativa' : 'Encerrada';
        const badgeClass = status === 'Ativa' ? 'badge-success' : 'badge-secondary';

        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${campanha.cam_desc}</td>
            <td>${formatarData(campanha.cam_data_ini)} - ${formatarData(campanha.cam_data_fim)}</td>
            <td>${campanha.voluntario_nome || 'N√£o definido'}</td>
            <td>R$ ${campanha.cam_meta_arrecadacao?.toLocaleString('pt-BR', { minimumFractionDigits: 2 }) || '0,00'}</td>
            <td>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <div style="flex: 1; height: 8px; background: var(--border-color); border-radius: 4px; overflow: hidden;">
                        <div style="width: ${Math.min(progresso, 100)}%; height: 100%; background: var(--success-color);"></div>
                    </div>
                    <span style="font-size: 0.875rem;">${progresso.toFixed(1)}%</span>
                </div>
            </td>
            <td><span class="badge ${badgeClass}">${status}</span></td>
            <td>
                <button class="btn btn-sm btn-info" onclick="editarCampanha(${campanha.cam_id})">‚úèÔ∏è</button>
                <button class="btn btn-sm btn-warning" onclick="gerenciarVoluntarios(${campanha.cam_id})">üë•</button>
                ${status === 'Ativa' ? 
                    // Bot√£o Encerrar Campanha
                    `<button class="btn btn-sm btn-danger" onclick="encerrarCampanha(${campanha.cam_id})">üîí</button>` : 
                    `<button class="btn btn-sm btn-info" onclick="verDetalhes(${campanha.cam_id})">üëÅÔ∏è</button>`
                }
                <button class="btn btn-sm btn-danger" onclick="excluirCampanha(${campanha.cam_id})">üóëÔ∏è</button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

   // Fun√ß√£o para carregar volunt√°rios nos selects
async function carregarVoluntarios() {
    const selectResponsavel = document.getElementById('responsavel');
    const selectVoluntario = document.getElementById('addVoluntario');

    // Limpar e adicionar op√ß√£o padr√£o em ambos
    selectResponsavel.innerHTML = '<option value="">Selecione</option>';
    selectVoluntario.innerHTML = '<option value="">Selecione um volunt√°rio</option>';

    try {
        //console.log('üîç Carregando volunt√°rios...');
        
        // 1. **USAR fetchAPI** para consist√™ncia, logs e tratamento de erros
        const voluntarios = await fetchAPI('/voluntario'); 
        
        if (Array.isArray(voluntarios) && voluntarios.length > 0) {
            console.log(`üë• Encontrados ${voluntarios.length} volunt√°rios`);
        voluntarios.forEach(voluntario => {
    
    // CORRE√á√ÉO: Usamos 'nome' e 'id' porque o VoluntarioController retorna essas chaves.
    const nomeVoluntario = voluntario.nome; 
    const idVoluntario = voluntario.id; 

    // Adiciona a op√ß√£o SOMENTE se o nome for v√°lido e o ID for um n√∫mero inteiro.
    if (nomeVoluntario && typeof idVoluntario === 'number') {
        
        //console.log(`‚û°Ô∏è Adicionando: ${nomeVoluntario} (ID: ${idVoluntario})`); // Log de sucesso para debug
        
        const option1 = new Option(nomeVoluntario, idVoluntario);
        const option2 = new Option(nomeVoluntario, idVoluntario);
        
        selectResponsavel.appendChild(option1);
        selectVoluntario.appendChild(option2);
        
    } else {
        // Log de aviso se um volunt√°rio vier sem ID ou Nome (√∫til para debug)
       // console.warn('‚ö†Ô∏è Volunt√°rio com campos essenciais faltando (Nome ou ID num√©rico):', voluntario);
    }
});
            
            //console.log(`üìã Select Responsavel tem ${selectResponsavel.options.length} options`);
        } else if (voluntarios && voluntarios.message && voluntarios.message.includes("Nenhum volunt√°rio encontrado")) {
            // Caso o backend retorne uma mensagem de sucesso, mas sem dados
            //console.warn('‚ö†Ô∏è O Backend informou: Nenhum volunt√°rio encontrado.');
        } else {
           // console.warn('‚ö†Ô∏è A lista de volunt√°rios est√° vazia ou n√£o √© um array.');
            UI.showAlert('A lista de volunt√°rios recebida est√° vazia ou inv√°lida.', 'warning');
        }
        
    } catch (error) {
        //console.error('üí• Erro ao carregar volunt√°rios (CATCH):', error);
        
        // 3. **Fallback para o caso de erro de conex√£o/API**
        if (selectResponsavel.options.length <= 1) { // Verifica se s√≥ tem o 'Selecione'
             selectResponsavel.innerHTML += `
                 <option value="1">Jo√£o Silva (Fallback)</option>
                 <option value="2">Maria Santos (Fallback)</option>
             `;
             selectVoluntario.innerHTML += `
                 <option value="1">Jo√£o Silva (Fallback)</option>
                 <option value="2">Maria Santos (Fallback)</option>
             `;
        }
        
        // A fun√ß√£o fetchAPI j√° deve ter exibido um alerta, mas podemos refor√ßar
        if (error.name !== 'AbortError') {
           UI.showAlert('Falha ao carregar volunt√°rios do servidor. Tente novamente.', 'error');
        }
    }
}

    // Fun√ß√£o para formatar data para exibi√ß√£o
    function formatarData(dataString) {
        const data = new Date(dataString);
        return data.toLocaleDateString('pt-BR');
    }

    // Fun√ß√£o auxiliar para formatar data para input
    function formatarDataParaInput(dataString) {
        if (!dataString) return '';
        const data = new Date(dataString);
        return data.toISOString().split('T')[0];
    }

    // Fun√ß√µes de busca e filtro
    document.getElementById('searchInput').addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase();
        const rows = document.querySelectorAll('#tabelaCampanhas tr');
        rows.forEach(row => {
            row.style.display = row.textContent.toLowerCase().includes(searchTerm) ? '' : 'none';
        });
    });

    function filtrarPorStatus() {
        const status = document.getElementById('filtroStatus').value.toLowerCase();
        const rows = document.querySelectorAll('#tabelaCampanhas tr');
        rows.forEach(row => {
            if (!status || row.textContent.toLowerCase().includes(status)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }

    // Fun√ß√µes do modal
    function openModal(modalId) {
        if (modalId === 'modalCampanha') {
            document.getElementById('formCampanha').reset();
            document.getElementById('campanhaId').value = '';
            document.getElementById('modalTitle').textContent = 'Nova Campanha';
>>>>>>> f920d7edf7db4e47bf74d5fa54468951ca65c13a
        }
        UI.openModal(modalId);
    }

<<<<<<< HEAD
        campanhas.forEach(campanha => {
            // C√°lculos
            const meta = campanha.cam_meta_arrecadacao || 0;
            const arrecadado = campanha.cam_valor_arrecadado || 0;
            const progresso = meta > 0 ? (arrecadado / meta) * 100 : 0;
            
            // Status e Data
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);

            let dataFim = new Date();
            if (campanha.cam_data_fim) {
                const parts = campanha.cam_data_fim.split('-');
                dataFim = new Date(parts[0], parts[1] - 1, parts[2], 23, 59, 59);
            }
            
            const status = dataFim >= hoje ? 'Ativa' : 'Encerrada';
            const badgeClass = status === 'Ativa' ? 'badge-success' : 'badge-secondary';

            // Buscar Nome pelo ID usando Cache
            const idResponsavel = campanha.voluntario_vol_id;
            let nomeResponsavel = `ID: ${idResponsavel}`; 
            
            const voluntarioEncontrado = listaVoluntariosCache.find(v => (v.vol_id || v.id) === idResponsavel);
            if (voluntarioEncontrado) {
                nomeResponsavel = voluntarioEncontrado.vol_nome || voluntarioEncontrado.nome;
            }

            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${campanha.cam_desc || 'Sem descri√ß√£o'}</td>
                <td>${formatarData(campanha.cam_data_ini)} - ${formatarData(campanha.cam_data_fim)}</td>
                <td>${nomeResponsavel}</td>
                <td>R$ ${meta.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                <td>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <div style="flex: 1; height: 8px; background: var(--border-color); border-radius: 4px; overflow: hidden;">
                            <div style="width: ${Math.min(progresso, 100)}%; height: 100%; background: var(--success-color);"></div>
                        </div>
                        <span style="font-size: 0.875rem;">${progresso.toFixed(1)}%</span>
                    </div>
                </td>
                <td><span class="badge ${badgeClass}">${status}</span></td>
                <td>
                    <button class="btn btn-sm btn-info" onclick="editarCampanha(${campanha.cam_id})" title="Editar">‚úèÔ∏è</button>
                    <button class="btn btn-sm btn-warning" onclick="gerenciarEquipe(${campanha.cam_id})" title="Equipe">üë•</button>
                    <button class="btn btn-sm btn-danger" onclick="excluirCampanha(${campanha.cam_id})" title="Excluir">üóëÔ∏è</button>
                </td>
            `;
            tbody.appendChild(row);
        });
        
        filtrarPorStatus();
    }

    async function salvarCampanha() {
        const form = document.getElementById('formCampanha');
        
        const descricao = document.getElementById('descricao').value;
        const dataInicio = document.getElementById('dataInicio').value;
        const dataFim = document.getElementById('dataFim').value;
        const responsavel = document.getElementById('responsavel').value;

        if(!descricao || !dataInicio || !dataFim || !responsavel) {
            UI.showAlert('Preencha todos os campos obrigat√≥rios.', 'warning');
            return;
        }

        const id = document.getElementById('campanhaId').value;
        
        const data = {
            cam_desc: descricao,
            cam_data_ini: dataInicio,
            cam_data_fim: dataFim,
            voluntario_vol_id: parseInt(responsavel),
            cam_meta_arrecadacao: parseFloat(document.getElementById('meta').value) || 0,
            cam_valor_arrecadado: 0
        };

        try {
            if (id) {
                await fetchAPI(`/campanha/${id}`, { method: 'PUT', body: JSON.stringify(data) });
                UI.showAlert('Campanha atualizada!', 'success');
            } else {
                await fetchAPI('/campanha', { method: 'POST', body: JSON.stringify(data) });
                UI.showAlert('Campanha criada!', 'success');
            }
            closeModal('modalCampanha');
            carregarCampanhas();
        } catch (error) {
            UI.showAlert('Erro ao salvar: ' + error.message, 'danger');
        }
    }

    async function excluirCampanha(id) {
        UI.confirm('Deseja excluir esta campanha permanentemente?', async () => {
            try {
                await fetchAPI(`/campanha/${id}`, { method: 'DELETE' });
                UI.showAlert('Campanha exclu√≠da.', 'success');
                carregarCampanhas();
            } catch (error) {
                UI.showAlert('Erro ao excluir: ' + error.message, 'danger');
            }
        });
    }

    async function editarCampanha(id) {
        try {
            const camp = await fetchAPI(`/campanha/${id}`);
            
            document.getElementById('campanhaId').value = camp.cam_id;
            document.getElementById('descricao').value = camp.cam_desc;
            document.getElementById('dataInicio').value = formatarDataInput(camp.cam_data_ini);
            document.getElementById('dataFim').value = formatarDataInput(camp.cam_data_fim);
            document.getElementById('meta').value = camp.cam_meta_arrecadacao;
            
            // Tenta setar o respons√°vel
            document.getElementById('responsavel').value = camp.voluntario_vol_id;
            
            document.getElementById('modalTitle').textContent = 'Editar Campanha';
            UI.openModal('modalCampanha');
        } catch (error) {
            UI.showAlert('Erro ao carregar: ' + error.message, 'danger');
        }
    }

    // ==========================================
    // EQUIPE DA CAMPANHA
    // ==========================================
    async function gerenciarEquipe(id) {
        document.getElementById('campanhaVoluntariosId').value = id;
        try {
            const lista = await fetchAPI(`/campresponsavel/campanha/${id}`);
            renderizarEquipe(lista);
            UI.openModal('modalVoluntarios');
        } catch (error) {
            renderizarEquipe([]);
=======
    function closeModal(modalId) { 
        UI.closeModal(modalId); 
    }

    async function editarCampanha(id) {
    try {
        const campanha = await fetchAPI(`/campanha/${id}`);
        
        // 1. Armazena o valor arrecadado atual para ser usado no PUT/salvarCampanha
        valorArrecadadoCampanhaEditando = campanha.cam_valor_arrecadado || 0; 
        
        document.getElementById('campanhaId').value = campanha.cam_id;
        document.getElementById('modalTitle').textContent = 'Editar Campanha';
        
        // 2. Corrigido: Usar cam_nome se existir, sen√£o cam_desc
        document.getElementById('nome').value = campanha.cam_nome || campanha.cam_desc; 
        
        document.getElementById('descricao').value = campanha.cam_desc;
        document.getElementById('dataInicio').value = formatarDataParaInput(campanha.cam_data_ini);
        document.getElementById('dataFim').value = formatarDataParaInput(campanha.cam_data_fim);
        document.getElementById('meta').value = campanha.cam_meta_arrecadacao || '';
        document.getElementById('responsavel').value = campanha.voluntario_vol_id || '';
        document.getElementById('observacoes').value = campanha.cam_observacoes || '';
        
        UI.openModal('modalCampanha');
    } catch (error) {
        console.error('Erro ao carregar campanha:', error);
        UI.showAlert('Erro ao carregar dados da campanha', 'error');
    }
}
    // Fun√ß√£o para gerenciar volunt√°rios da campanha
    async function gerenciarVoluntarios(id) {
        document.getElementById('campanhaVoluntariosId').value = id;
        
        try {
            // Carregar volunt√°rios vinculados √† campanha
            const voluntariosCampanha = await fetchAPI(`/campanha/${id}/voluntarios`);
            renderizarVoluntariosCampanha(voluntariosCampanha);
>>>>>>> f920d7edf7db4e47bf74d5fa54468951ca65c13a
            UI.openModal('modalVoluntarios');
        } catch (error) {
            console.error('Erro ao carregar volunt√°rios da campanha:', error);
            UI.showAlert('Erro ao carregar volunt√°rios da campanha', 'error');
        }
    }

    // Fun√ß√£o para renderizar volunt√°rios da campanha
    function renderizarVoluntariosCampanha(voluntarios) {
        const tbody = document.getElementById('tabelaVoluntariosCampanha');
        tbody.innerHTML = '';

        if (voluntarios && voluntarios.length > 0) {
            voluntarios.forEach(voluntario => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${voluntario.vol_nome}</td>
                    <td>${voluntario.vol_email}</td>
                    <td><button class="btn btn-sm btn-danger" onclick="removerVoluntario(${voluntario.vol_id})">üóëÔ∏è Remover</button></td>
                `;
                tbody.appendChild(row);
            });
        } else {
            const row = document.createElement('tr');
            row.innerHTML = `<td colspan="3" class="text-center">Nenhum volunt√°rio vinculado</td>`;
            tbody.appendChild(row);
        }
    }

    // Fun√ß√£o para adicionar volunt√°rio √† campanha
    async function adicionarVoluntario() {
        const select = document.getElementById('addVoluntario');
        const campanhaId = document.getElementById('campanhaVoluntariosId').value;
        
        if (!select.value) {
            UI.showAlert('Selecione um volunt√°rio', 'warning');
            return;
        }
    }

<<<<<<< HEAD
    function renderizarEquipe(lista) {
        const tbody = document.getElementById('tabelaVoluntariosCampanha');
        tbody.innerHTML = '';

        if (!lista || lista.length === 0 || lista.mensagem) {
            tbody.innerHTML = '<tr><td colspan="3" class="text-center">Nenhum volunt√°rio vinculado.</td></tr>';
            return;
        }

        const selectVoluntarios = document.getElementById('addVoluntario');

        lista.forEach(item => {
            // Busca nome do membro da equipe no cache global ou no select
            const idMembro = item.voluntario_vol_id;
            let nomeMembro = `ID: ${idMembro}`;
            
            // Tenta cache primeiro
            const voluntarioEncontrado = listaVoluntariosCache.find(v => (v.vol_id || v.id) === idMembro);
            if (voluntarioEncontrado) {
                nomeMembro = voluntarioEncontrado.vol_nome || voluntarioEncontrado.nome;
            } 
            // Tenta select como fallback
            else if (selectVoluntarios) {
                const option = selectVoluntarios.querySelector(`option[value="${idMembro}"]`);
                if (option) nomeMembro = option.text;
            }

            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${nomeMembro}</td>
                <td>${item.Obs_texto || '-'}</td>
                <td>
                    <button class="btn btn-sm btn-danger" onclick="removerDaEquipe(${idMembro})">Remover</button>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    async function adicionarVoluntario() {
        const campanhaId = document.getElementById('campanhaVoluntariosId').value;
        const voluntarioId = document.getElementById('addVoluntario').value;

        if (!voluntarioId) {
            UI.showAlert('Selecione um volunt√°rio.', 'warning');
            return;
        }

        const hoje = new Date().toISOString().split('T')[0];
        
        const dados = {
            cam_id: parseInt(campanhaId),
            voluntario_vol_id: parseInt(voluntarioId),
            DATA_INICIO: hoje,
            DATA_FIM: hoje, 
            Obs_texto: "Adicionado via painel"
        };

        try {
            await fetchAPI('/campresponsavel/registrar', {
                method: 'POST',
                body: JSON.stringify(dados)
            });
            
            UI.showAlert('Volunt√°rio adicionado!', 'success');
            gerenciarEquipe(campanhaId);
        } catch (error) {
            UI.showAlert('Erro ao adicionar: ' + error.message, 'danger');
        }
    }

    async function removerDaEquipe(voluntarioId) {
        const campanhaId = document.getElementById('campanhaVoluntariosId').value;
        UI.confirm('Remover da equipe?', async () => {
            try {
                await fetchAPI(`/campresponsavel/${campanhaId}/${voluntarioId}`, { method: 'DELETE' });
                UI.showAlert('Removido com sucesso.', 'success');
                gerenciarEquipe(campanhaId);
            } catch (error) {
                UI.showAlert('Erro ao remover: ' + error.message, 'danger');
=======
        try {
            await fetchAPI(`/campanha/${campanhaId}/voluntarios`, {
                method: 'POST',
                body: JSON.stringify({ vol_id: parseInt(select.value) })
            });
            
            UI.showAlert('Volunt√°rio adicionado!', 'success');
            select.value = '';
            
            // Recarregar lista de volunt√°rios
            const voluntariosCampanha = await fetchAPI(`/campanha/${campanhaId}/voluntarios`);
            renderizarVoluntariosCampanha(voluntariosCampanha);
        } catch (error) {
            console.error('Erro ao adicionar volunt√°rio:', error);
            UI.showAlert('Erro ao adicionar volunt√°rio', 'error');
        }
    }

    // Fun√ß√£o para remover volunt√°rio da campanha
    async function removerVoluntario(voluntarioId) {
        const campanhaId = document.getElementById('campanhaVoluntariosId').value;
        
        UI.confirm('Remover volunt√°rio desta campanha?', async function() {
            try {
                await fetchAPI(`/campanha/${campanhaId}/voluntarios/${voluntarioId}`, {
                    method: 'DELETE'
                });
                
                UI.showAlert('Volunt√°rio removido!', 'success');
                
                // Recarregar lista de volunt√°rios
                const voluntariosCampanha = await fetchAPI(`/campanha/${campanhaId}/voluntarios`);
                renderizarVoluntariosCampanha(voluntariosCampanha);
            } catch (error) {
                console.error('Erro ao remover volunt√°rio:', error);
                UI.showAlert('Erro ao remover volunt√°rio', 'error');
>>>>>>> f920d7edf7db4e47bf74d5fa54468951ca65c13a
            }
        });
    }

<<<<<<< HEAD
    // ==========================================
    // HELPERS
    // ==========================================
    function formatarData(data) {
        if(!data) return '-';
        if(data.includes('-')) {
            const p = data.split('-');
            if(p.length === 3) return `${p[2]}/${p[1]}/${p[0]}`;
        }
        return new Date(data).toLocaleDateString('pt-BR');
    }

    function formatarDataInput(data) {
        if(!data) return '';
        if(data.includes('/')) {
            const p = data.split('/');
            return `${p[2]}-${p[1]}-${p[0]}`;
        }
        return data;
    }

    function filtrarPorStatus() {
        const status = document.getElementById('filtroStatus').value.toLowerCase();
        const rows = document.querySelectorAll('#tabelaCampanhas tr');
        
        rows.forEach(row => {
            const badge = row.querySelector('.badge');
            if(badge) {
                const texto = badge.textContent.toLowerCase();
                if(!status || texto.includes(status)) row.style.display = '';
                else row.style.display = 'none';
            }
        });
    }

    function openModal(id) { 
        if(id === 'modalCampanha') {
            document.getElementById('formCampanha').reset();
            document.getElementById('campanhaId').value = '';
            document.getElementById('modalTitle').textContent = 'Nova Campanha';
        }
        UI.openModal(id); 
    }
    function closeModal(id) { UI.closeModal(id); }
=======
    // Fun√ß√£o para encerrar campanha
    async function encerrarCampanha(id) {
        UI.confirm('Deseja encerrar esta campanha?', async function() {
            try {
                await fetchAPI(`/campanha/${id}/encerrar`, {
                    method: 'PUT'
                });
                
                UI.showAlert('Campanha encerrada!', 'success');
                carregarCampanhas(); // Recarregar a lista
            } catch (error) {
                console.error('Erro ao encerrar campanha:', error);
                UI.showAlert('Erro ao encerrar campanha', 'error');
            }
        });
    }

    // Fun√ß√£o para ver detalhes
    function verDetalhes(id) {
        window.location.href = `relatorios.html?campanha=${id}`;
    }

    // Fun√ß√£o para salvar campanha (criar ou editar) - CORRIGIDA
    async function salvarCampanha() {
        const form = document.getElementById('formCampanha');
        const nome = document.getElementById('nome');
        const descricao = document.getElementById('descricao');
        const dataInicio = document.getElementById('dataInicio');
        const dataFim = document.getElementById('dataFim');
        const responsavel = document.getElementById('responsavel');

        Validator.clearAllErrors(form);
        let isValid = true;

        if (Validator.isEmpty(nome.value)) {
            Validator.showError(nome, 'Nome √© obrigat√≥rio');
            isValid = false;
        }
        if (Validator.isEmpty(descricao.value)) {
            Validator.showError(descricao, 'Descri√ß√£o √© obrigat√≥ria');
            isValid = false;
        }
        if (Validator.isEmpty(dataInicio.value)) {
            Validator.showError(dataInicio, 'Data de in√≠cio √© obrigat√≥ria');
            isValid = false;
        }
        if (Validator.isEmpty(dataFim.value)) {
            Validator.showError(dataFim, 'Data de fim √© obrigat√≥ria');
            isValid = false;
        }
        if (Validator.isEmpty(responsavel.value)) {
            Validator.showError(responsavel, 'Respons√°vel √© obrigat√≥rio');
            isValid = false;
        }

        if (!isValid) return;

        try {
            const campanhaId = document.getElementById('campanhaId').value;
            const valoArrecadadoAtual = 0;
            const data = {
                cam_nome: nome.value,
                cam_desc: descricao.value,
                cam_data_ini: dataInicio.value,
                cam_data_fim: dataFim.value,
                voluntario_vol_id: parseInt(responsavel.value),
                cam_meta_arrecadacao: parseFloat(document.getElementById('meta').value) || 0,
                cam_observacoes: document.getElementById('observacoes').value,
                cam_valor_arrecadado:valoArrecadadoAtual
            };

            //console.log('Dados enviados para salvar campanha:', data); // DEBUG

            if (campanhaId) {
                // Editar campanha existente
                await fetchAPI(`/campanha/${campanhaId}`, {
                    method: 'PUT',
                    body: JSON.stringify(data)
                });
                UI.showAlert('Campanha atualizada!', 'success');
            } else {
                // Criar nova campanha
                await fetchAPI('/campanha', {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
                UI.showAlert('Campanha cadastrada!', 'success');
            }
            
            closeModal('modalCampanha');
            carregarCampanhas(); // Recarregar a lista
        } catch (error) {
            console.error('Erro ao salvar campanha:', error);
            UI.showAlert('Erro ao salvar campanha', 'error');
        }
    }

    // Fun√ß√£o de teste para debug
    async function testarVoluntarios() {
        try {
            const response = await fetch('http://localhost:8080/apis/voluntario');
            const data = await response.json();
            console.log('Resposta bruta dos volunt√°rios:', data);
            
            if (!response.ok) {
                console.error('Erro HTTP:', response.status);
                return;
            }
            
            return data;
        } catch (error) {
            console.error('Erro no teste:', error);
        }
    }
>>>>>>> f920d7edf7db4e47bf74d5fa54468951ca65c13a
</script>
</body>
</html>