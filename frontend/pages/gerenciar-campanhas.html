<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DOARC - Gerenciar Campanhas</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <header class="header">
        <div class="header-content">
            <a href="dashboard.html" class="logo">DOARC</a>
            <div class="user-menu">
                <span class="user-name" id="userName">Volunt√°rio</span>
                <button class="btn-logout" id="logoutBtn">Sair</button>
            </div>
        </div>
    </header>

    <nav class="nav">
        <ul class="nav-list">
            <li class="nav-item"><a href="dashboard.html" class="nav-link">Dashboard</a></li>
            <li class="nav-item">
                <a href="#" class="nav-link active">Gerenciar</a>
                <ul class="submenu">
                    <li class="submenu-item"><a href="gerenciar-doadores.html" class="submenu-link">Doadores</a></li>
                    <li class="submenu-item"><a href="gerenciar-donatarios.html" class="submenu-link">Donat√°rios</a></li>
                    <li class="submenu-item"><a href="gerenciar-produtos.html" class="submenu-link">Produtos</a></li>
                    <li class="submenu-item"><a href="gerenciar-categorias.html" class="submenu-link">Categorias</a></li>
                    <li class="submenu-item"><a href="gerenciar-voluntarios.html" class="submenu-link">Volunt√°rios</a></li>
                    <li class="submenu-item"><a href="gerenciar-campanhas.html" class="submenu-link">Campanhas</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link">Doa√ß√µes</a>
                <ul class="submenu">
                    <li class="submenu-item"><a href="receber-doacoes.html" class="submenu-link">Receber Doa√ß√µes</a></li>
                    <li class="submenu-item"><a href="efetuar-doacoes.html" class="submenu-link">Efetuar Doa√ß√µes</a></li>
                    <li class="submenu-item"><a href="agendar-doacao.html" class="submenu-link">Agendar Doa√ß√£o</a></li>
                    <li class="submenu-item"><a href="agendar-retirada.html" class="submenu-link">Agendar Retirada</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link">Estoque</a>
                <ul class="submenu">
                    <li class="submenu-item"><a href="visualizar-estoque.html" class="submenu-link">Visualizar Estoque</a></li>
                    <li class="submenu-item"><a href="registrar-acerto.html" class="submenu-link">Acerto de Estoque</a></li>
                    <li class="submenu-item"><a href="lancar-compra.html" class="submenu-link">Lan√ßar Compra/Arrecada√ß√£o</a></li>
                    <li class="submenu-item"><a href="agendar-higienizacao.html" class="submenu-link">Agendar Higieniza√ß√£o</a></li>
                </ul>
            </li>
            <li class="nav-item"><a href="relatorios.html" class="nav-link">Relat√≥rios</a></li>
        </ul>
    </nav>

    <main class="container">
        <div class="breadcrumb">
            <div class="breadcrumb-item"><a href="dashboard.html">Dashboard</a></div>
            <div class="breadcrumb-item">Gerenciar</div>
            <div class="breadcrumb-item active">Campanhas</div>
        </div>

        <div class="card">
            <div class="card-header">
                <h1 class="card-title">Gerenciar Campanhas</h1>
                <p class="card-subtitle">Crie e gerencie campanhas de arrecada√ß√£o</p>
            </div>
            <div class="card-body">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        <input type="text" id="searchInput" class="form-control" placeholder="Buscar campanha..." style="max-width: 300px;">
                        <select id="filtroStatus" class="form-control form-select" style="max-width: 150px;" onchange="filtrarPorStatus()">
                            <option value="">Todos Status</option>
                            <option value="ativa">Ativa</option>
                            <option value="encerrada">Encerrada</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="openModal('modalCampanha')">‚ûï Nova Campanha</button>
                </div>

                <div class="table-container">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Per√≠odo</th>
                                <th>Respons√°vel</th>
                                <th>Meta</th>
                                <th>Progresso</th>
                                <th>Status</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaCampanhas">
                            <!-- As campanhas ser√£o carregadas via JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <div id="modalCampanha" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Nova Campanha</h2>
                <button class="modal-close" onclick="closeModal('modalCampanha')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="formCampanha">
                    <input type="hidden" id="campanhaId">
                    <div class="form-group">
                        <label for="nome" class="form-label required">Nome da Campanha</label>
                        <input type="text" id="nome" class="form-control" required>
                        <div class="form-error">Nome √© obrigat√≥rio</div>
                    </div>
                    <div class="form-group">
                        <label for="descricao" class="form-label required">Descri√ß√£o</label>
                        <textarea id="descricao" class="form-control" rows="3" required></textarea>
                        <div class="form-error">Descri√ß√£o √© obrigat√≥ria</div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="dataInicio" class="form-label required">Data In√≠cio</label>
                            <input type="date" id="dataInicio" class="form-control" required>
                            <div class="form-error">Data √© obrigat√≥ria</div>
                        </div>
                        <div class="form-group">
                            <label for="dataFim" class="form-label required">Data Fim</label>
                            <input type="date" id="dataFim" class="form-control" required>
                            <div class="form-error">Data √© obrigat√≥ria</div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="meta" class="form-label">Meta (R$)</label>
                            <input type="number" id="meta" class="form-control" step="0.01" min="0">
                        </div>
                        <div class="form-group">
                            <label for="responsavel" class="form-label required">Respons√°vel</label>
                            <select id="responsavel" class="form-control form-select" required>
                                <option value="">Selecione</option>
                                <!-- Os volunt√°rios ser√£o carregados via JavaScript -->
                            </select>
                            <div class="form-error">Respons√°vel √© obrigat√≥rio</div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="observacoes" class="form-label">Observa√ß√µes</label>
                        <textarea id="observacoes" class="form-control" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('modalCampanha')">Cancelar</button>
                <button class="btn btn-primary" onclick="salvarCampanha()">Salvar</button>
            </div>
        </div>
    </div>

    <div id="modalVoluntarios" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Gerenciar Volunt√°rios da Campanha</h2>
                <button class="modal-close" onclick="closeModal('modalVoluntarios')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="campanhaVoluntariosId">
                <div class="form-group">
                    <label for="addVoluntario" class="form-label">Adicionar Volunt√°rio</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <select id="addVoluntario" class="form-control form-select" style="flex: 1;">
                            <option value="">Selecione um volunt√°rio</option>
                            <!-- Os volunt√°rios ser√£o carregados via JavaScript -->
                        </select>
                        <button class="btn btn-success" onclick="adicionarVoluntario()">‚ûï Adicionar</button>
                    </div>
                </div>
                <h4 style="margin-top: 1.5rem; margin-bottom: 1rem;">Volunt√°rios Vinculados</h4>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>E-mail</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaVoluntariosCampanha">
                            <!-- Volunt√°rios ser√£o carregados dinamicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('modalVoluntarios')">Fechar</button>
            </div>
        </div>
    </div>

    <script src="../js/app.js"></script>
    <script>
        // Configura√ß√£o da API
       const API_BASE_URL = 'http://localhost:8080/apis';
        
        // Headers padr√£o para as requisi√ß√µes
        const defaultHeaders = {
            'Content-Type': 'application/json',
        };

        // Fun√ß√£o utilit√°ria para fazer requisi√ß√µes HTTP
        async function fetchAPI(endpoint, options = {}) {
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    headers: { ...defaultHeaders, ...options.headers },
                    ...options
                });

                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }

                return await response.json();
            } catch (error) {
                console.error('Erro na requisi√ß√£o:', error);
                UI.showAlert('Erro ao conectar com o servidor', 'error');
                throw error;
            }
        }

        // Carregar dados iniciais quando a p√°gina carregar
        document.addEventListener('DOMContentLoaded', function() {
            carregarCampanhas();
            carregarVoluntarios();
        });

        // Fun√ß√£o para carregar campanhas
        async function carregarCampanhas() {
            try {
                const campanhas = await fetchAPI('/campanha');
                renderizarCampanhas(campanhas);
            } catch (error) {
                console.error('Erro ao carregar campanhas:', error);
            }
        }

        // Fun√ß√£o para renderizar campanhas na tabela
        function renderizarCampanhas(campanhas) {
            const tbody = document.getElementById('tabelaCampanhas');
            tbody.innerHTML = '';

            campanhas.forEach(campanha => {
                const progresso = campanha.cam_meta_arrecadacao > 0 
                    ? (campanha.cam_valor_arrecadado / campanha.cam_meta_arrecadacao) * 100 
                    : 0;
                
                const status = new Date(campanha.cam_data_fim) >= new Date() ? 'Ativa' : 'Encerrada';
                const badgeClass = status === 'Ativa' ? 'badge-success' : 'badge-secondary';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${campanha.cam_desc}</td>
                    <td>${formatarData(campanha.cam_data_ini)} - ${formatarData(campanha.cam_data_fim)}</td>
                    <td>${campanha.voluntario_nome || 'N√£o definido'}</td>
                    <td>R$ ${campanha.cam_meta_arrecadacao?.toLocaleString('pt-BR', { minimumFractionDigits: 2 }) || '0,00'}</td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="flex: 1; height: 8px; background: var(--border-color); border-radius: 4px; overflow: hidden;">
                                <div style="width: ${Math.min(progresso, 100)}%; height: 100%; background: var(--success-color);"></div>
                            </div>
                            <span style="font-size: 0.875rem;">${progresso.toFixed(1)}%</span>
                        </div>
                    </td>
                    <td><span class="badge ${badgeClass}">${status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="editarCampanha(${campanha.cam_id})">‚úèÔ∏è</button>
                        <button class="btn btn-sm btn-warning" onclick="gerenciarVoluntarios(${campanha.cam_id})">üë•</button>
                        ${status === 'Ativa' ? 
                            `<button class="btn btn-sm btn-danger" onclick="encerrarCampanha(${campanha.cam_id})">üîí</button>` : 
                            `<button class="btn btn-sm btn-info" onclick="verDetalhes(${campanha.cam_id})">üëÅÔ∏è</button>`
                        }
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Fun√ß√£o para carregar volunt√°rios nos selects
        async function carregarVoluntarios() {
            try {
                const voluntarios = await fetchAPI('/voluntario');
                const selectResponsavel = document.getElementById('responsavel');
                const selectVoluntario = document.getElementById('addVoluntario');
                
                // Limpar options existentes (exceto a primeira)
                selectResponsavel.innerHTML = '<option value="">Selecione</option>';
                selectVoluntario.innerHTML = '<option value="">Selecione um volunt√°rio</option>';
                
                voluntarios.forEach(voluntario => {
                    const option1 = new Option(voluntario.vol_nome, voluntario.vol_id);
                    const option2 = new Option(voluntario.vol_nome, voluntario.vol_id);
                    selectResponsavel.add(option1);
                    selectVoluntario.add(option2);
                });
            } catch (error) {
                console.error('Erro ao carregar volunt√°rios:', error);
            }
        }

        // Fun√ß√£o para formatar data
        function formatarData(dataString) {
            const data = new Date(dataString);
            return data.toLocaleDateString('pt-BR');
        }

        // Fun√ß√µes de busca e filtro
        document.getElementById('searchInput').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('#tabelaCampanhas tr');
            rows.forEach(row => {
                row.style.display = row.textContent.toLowerCase().includes(searchTerm) ? '' : 'none';
            });
        });

        function filtrarPorStatus() {
            const status = document.getElementById('filtroStatus').value.toLowerCase();
            const rows = document.querySelectorAll('#tabelaCampanhas tr');
            rows.forEach(row => {
                if (!status || row.textContent.toLowerCase().includes(status)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // Fun√ß√µes do modal
        function openModal(modalId) {
            if (modalId === 'modalCampanha') {
                document.getElementById('formCampanha').reset();
                document.getElementById('campanhaId').value = '';
                document.getElementById('modalTitle').textContent = 'Nova Campanha';
            }
            UI.openModal(modalId);
        }

        function closeModal(modalId) { 
            UI.closeModal(modalId); 
        }

        // Fun√ß√£o para editar campanha
        async function editarCampanha(id) {
            try {
                const campanha = await fetchAPI(`/campanha/${id}`);
                
                document.getElementById('campanhaId').value = campanha.cam_id;
                document.getElementById('modalTitle').textContent = 'Editar Campanha';
                document.getElementById('nome').value = campanha.cam_desc;
                document.getElementById('descricao').value = campanha.cam_desc;
                document.getElementById('dataInicio').value = campanha.cam_data_ini;
                document.getElementById('dataFim').value = campanha.cam_data_fim;
                document.getElementById('meta').value = campanha.cam_meta_arrecadacao || '';
                document.getElementById('responsavel').value = campanha.voluntario_vol_id || '';
                document.getElementById('observacoes').value = campanha.cam_observacoes || '';
                
                UI.openModal('modalCampanha');
            } catch (error) {
                console.error('Erro ao carregar campanha:', error);
            }
        }

        // Fun√ß√£o para gerenciar volunt√°rios da campanha
        async function gerenciarVoluntarios(id) {
            document.getElementById('campanhaVoluntariosId').value = id;
            
            try {
                // Carregar volunt√°rios vinculados √† campanha
                const voluntariosCampanha = await fetchAPI(`/campanha/${id}/voluntarios`);
                renderizarVoluntariosCampanha(voluntariosCampanha);
                UI.openModal('modalVoluntarios');
            } catch (error) {
                console.error('Erro ao carregar volunt√°rios da campanha:', error);
            }
        }

        // Fun√ß√£o para renderizar volunt√°rios da campanha
        function renderizarVoluntariosCampanha(voluntarios) {
            const tbody = document.getElementById('tabelaVoluntariosCampanha');
            tbody.innerHTML = '';

            voluntarios.forEach(voluntario => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${voluntario.vol_nome}</td>
                    <td>${voluntario.vol_email}</td>
                    <td><button class="btn btn-sm btn-danger" onclick="removerVoluntario(${voluntario.vol_id})">üóëÔ∏è Remover</button></td>
                `;
                tbody.appendChild(row);
            });
        }

        // Fun√ß√£o para adicionar volunt√°rio √† campanha
        async function adicionarVoluntario() {
            const select = document.getElementById('addVoluntario');
            const campanhaId = document.getElementById('campanhaVoluntariosId').value;
            
            if (!select.value) {
                UI.showAlert('Selecione um volunt√°rio', 'warning');
                return;
            }

            try {
                await fetchAPI(`/campanha/${campanhaId}/voluntarios`, {
                    method: 'POST',
                    body: JSON.stringify({ vol_id: parseInt(select.value) })
                });
                
                UI.showAlert('Volunt√°rio adicionado!', 'success');
                select.value = '';
                
                // Recarregar lista de volunt√°rios
                const voluntariosCampanha = await fetchAPI(`/campanha/${campanhaId}/voluntarios`);
                renderizarVoluntariosCampanha(voluntariosCampanha);
            } catch (error) {
                console.error('Erro ao adicionar volunt√°rio:', error);
            }
        }

        // Fun√ß√£o para remover volunt√°rio da campanha
        async function removerVoluntario(voluntarioId) {
            const campanhaId = document.getElementById('campanhaVoluntariosId').value;
            
            UI.confirm('Remover volunt√°rio desta campanha?', async function() {
                try {
                    await fetchAPI(`/campanha/${campanhaId}/voluntarios/${voluntarioId}`, {
                        method: 'DELETE'
                    });
                    
                    UI.showAlert('Volunt√°rio removido!', 'success');
                    
                    // Recarregar lista de volunt√°rios
                    const voluntariosCampanha = await fetchAPI(`/campanha/${campanhaId}/voluntarios`);
                    renderizarVoluntariosCampanha(voluntariosCampanha);
                } catch (error) {
                    console.error('Erro ao remover volunt√°rio:', error);
                }
            });
        }

        // Fun√ß√£o para encerrar campanha
        async function encerrarCampanha(id) {
            UI.confirm('Deseja encerrar esta campanha?', async function() {
                try {
                    await fetchAPI(`/campanha/${id}/encerrar`, {
                        method: 'PUT'
                    });
                    
                    UI.showAlert('Campanha encerrada!', 'success');
                    carregarCampanhas(); // Recarregar a lista
                } catch (error) {
                    console.error('Erro ao encerrar campanha:', error);
                }
            });
        }

        // Fun√ß√£o para ver detalhes
        function verDetalhes(id) {
            window.location.href = `relatorios.html?campanha=${id}`;
        }

        // Fun√ß√£o para salvar campanha (criar ou editar)
        async function salvarCampanha() {
            const form = document.getElementById('formCampanha');
            const nome = document.getElementById('nome');
            const descricao = document.getElementById('descricao');
            const dataInicio = document.getElementById('dataInicio');
            const dataFim = document.getElementById('dataFim');
            const responsavel = document.getElementById('responsavel');

            Validator.clearAllErrors(form);
            let isValid = true;

            if (Validator.isEmpty(nome.value)) {
                Validator.showError(nome, 'Nome √© obrigat√≥rio');
                isValid = false;
            }
            if (Validator.isEmpty(descricao.value)) {
                Validator.showError(descricao, 'Descri√ß√£o √© obrigat√≥ria');
                isValid = false;
            }
            if (Validator.isEmpty(dataInicio.value)) {
                Validator.showError(dataInicio, 'Data √© obrigat√≥ria');
                isValid = false;
            }
            if (Validator.isEmpty(dataFim.value)) {
                Validator.showError(dataFim, 'Data √© obrigat√≥ria');
                isValid = false;
            }
            if (Validator.isEmpty(responsavel.value)) {
                Validator.showError(responsavel, 'Respons√°vel √© obrigat√≥rio');
                isValid = false;
            }

            if (!isValid) return;

            try {
                const campanhaId = document.getElementById('campanhaId').value;
                const data = {
                    cam_desc: nome.value,
                    cam_data_ini: dataInicio.value,
                    cam_data_fim: dataFim.value,
                    voluntario_vol_id: parseInt(responsavel.value),
                    cam_meta_arrecadacao: parseFloat(document.getElementById('meta').value) || 0,
                    cam_observacoes: document.getElementById('observacoes').value
                };

                if (campanhaId) {
                    // Editar campanha existente
                    await fetchAPI(`/campanha/${campanhaId}`, {
                        method: 'PUT',
                        body: JSON.stringify(data)
                    });
                    UI.showAlert('Campanha atualizada!', 'success');
                } else {
                    // Criar nova campanha
                    await fetchAPI('/campanha', {
                        method: 'POST',
                        body: JSON.stringify(data)
                    });
                    UI.showAlert('Campanha cadastrada!', 'success');
                }
                
                closeModal('modalCampanha');
                carregarCampanhas(); // Recarregar a lista
            } catch (error) {
                console.error('Erro ao salvar campanha:', error);
            }
        }
    </script>
</body>
</html>