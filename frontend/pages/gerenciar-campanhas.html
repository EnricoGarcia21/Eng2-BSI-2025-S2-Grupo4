<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DOARC - Gerenciar Campanhas</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <header class="header">
        <div class="header-content">
            <a href="dashboard.html" class="logo">DOARC</a>
            <div class="user-menu">
                <span class="user-name" id="userName">Volunt√°rio</span>
                <button class="btn-logout" id="logoutBtn">Sair</button>
            </div>
        </div>
    </header>

    <nav class="nav">
        <ul class="nav-list">
            <li class="nav-item"><a href="dashboard.html" class="nav-link">Dashboard</a></li>
            <li class="nav-item">
                <a href="#" class="nav-link active">Gerenciar</a>
                <ul class="submenu">
                    <li class="submenu-item"><a href="gerenciar-doadores.html" class="submenu-link">Doadores</a></li>
                    <li class="submenu-item"><a href="gerenciar-donatarios.html" class="submenu-link">Donat√°rios</a></li>
                    <li class="submenu-item"><a href="gerenciar-produtos.html" class="submenu-link">Produtos</a></li>
                    <li class="submenu-item"><a href="gerenciar-categorias.html" class="submenu-link">Categorias</a></li>
                    <li class="submenu-item"><a href="gerenciar-voluntarios.html" class="submenu-link">Volunt√°rios</a></li>
                    <li class="submenu-item"><a href="gerenciar-campanhas.html" class="submenu-link">Campanhas</a></li>
                </ul>
            </li>
            <li class="nav-item"><a href="#" class="nav-link">Doa√ß√µes</a>
                <ul class="submenu">
                    <li class="submenu-item"><a href="receber-doacoes.html" class="submenu-link">Receber Doa√ß√µes</a></li>
                    <li class="submenu-item"><a href="efetuar-doacoes.html" class="submenu-link">Efetuar Doa√ß√µes</a></li>
                </ul>
            </li>
             <li class="nav-item"><a href="relatorios.html" class="nav-link">Relat√≥rios</a></li>
        </ul>
    </nav>

    <main class="container">
        <div class="breadcrumb">
            <div class="breadcrumb-item"><a href="dashboard.html">Dashboard</a></div>
            <div class="breadcrumb-item">Gerenciar</div>
            <div class="breadcrumb-item active">Campanhas</div>
        </div>

        <div class="card">
            <div class="card-header">
                <h1 class="card-title">Gerenciar Campanhas</h1>
                <p class="card-subtitle">Crie e gerencie campanhas de arrecada√ß√£o</p>
            </div>
            <div class="card-body">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        <input type="text" id="searchInput" class="form-control" placeholder="Buscar campanha..." style="max-width: 300px;">
                        <select id="filtroStatus" class="form-control form-select" style="max-width: 150px;" onchange="filtrarPorStatus()">
                            <option value="">Todos Status</option>
                            <option value="ativa">Ativa</option>
                            <option value="encerrada">Encerrada</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="openModal('modalCampanha')">‚ûï Nova Campanha</button>
                </div>

                <div class="table-container">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Nome/Descri√ß√£o</th>
                                <th>Per√≠odo</th>
                                <th>Respons√°vel (ID)</th>
                                <th>Meta</th>
                                <th>Progresso</th>
                                <th>Status</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaCampanhas">
                            <tr><td colspan="7" class="text-center">Carregando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <div id="modalCampanha" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Nova Campanha</h2>
                <button class="modal-close" onclick="closeModal('modalCampanha')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="formCampanha">
                    <input type="hidden" id="campanhaId">
                    
                    <div class="form-group">
                        <label for="descricao" class="form-label required">Nome/Descri√ß√£o da Campanha</label>
                        <input type="text" id="descricao" class="form-control" required>
                        <div class="form-error">Descri√ß√£o √© obrigat√≥ria</div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="dataInicio" class="form-label required">Data In√≠cio</label>
                            <input type="date" id="dataInicio" class="form-control" required>
                            <div class="form-error">Data √© obrigat√≥ria</div>
                        </div>
                        <div class="form-group">
                            <label for="dataFim" class="form-label required">Data Fim</label>
                            <input type="date" id="dataFim" class="form-control" required>
                            <div class="form-error">Data √© obrigat√≥ria</div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="meta" class="form-label">Meta de Arrecada√ß√£o (R$)</label>
                            <input type="number" id="meta" class="form-control" step="0.01" min="0" placeholder="0,00">
                        </div>
                        <div class="form-group">
                            <label for="responsavel" class="form-label required">Volunt√°rio Respons√°vel</label>
                            <select id="responsavel" class="form-control form-select" required>
                                <option value="">Carregando...</option>
                            </select>
                            <div class="form-error">Respons√°vel √© obrigat√≥rio</div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('modalCampanha')">Cancelar</button>
                <button class="btn btn-primary" onclick="salvarCampanha()">Salvar</button>
            </div>
        </div>
    </div>

    <div id="modalVoluntarios" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Equipe da Campanha</h2>
                <button class="modal-close" onclick="closeModal('modalVoluntarios')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="campanhaVoluntariosId">
                
                <div id="areaAdicionarMembro">
                    <div class="form-group">
                        <label for="addVoluntario" class="form-label">Adicionar Volunt√°rio √† Equipe</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <select id="addVoluntario" class="form-control form-select" style="flex: 1;">
                                <option value="">Selecione um volunt√°rio</option>
                            </select>
                            <button class="btn btn-success" onclick="adicionarVoluntario()">‚ûï Adicionar</button>
                        </div>
                    </div>
                </div>
                <div id="avisoCampanhaEncerrada" style="display:none; padding: 10px; background-color: #f8d7da; color: #721c24; border-radius: 4px; margin-bottom: 15px;">
                    ‚ö†Ô∏è Esta campanha est√° encerrada. N√£o √© poss√≠vel adicionar novos membros.
                </div>
                
                <h4 style="margin-top: 1.5rem; margin-bottom: 1rem; color: var(--primary-color);">Membros Atuais</h4>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Volunt√°rio</th>
                                <th>Fun√ß√£o/Obs</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaVoluntariosCampanha">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('modalVoluntarios')">Fechar</button>
            </div>
        </div>
    </div>

    <script src="../js/app.js"></script>
<script>
    // Configura√ß√£o da API
    const API_BASE_URL = 'http://localhost:8080/apis';

    // CACHE GLOBAL
    let listaVoluntariosCache = []; 
    let listaCampanhasCache = [];

    // ==========================================
    // üõ†Ô∏è FUN√á√ÉO FETCH API (Customizada para ler erros JSON)
    // ==========================================
    async function fetchAPI(endpoint, options = {}) {
        const token = localStorage.getItem('jwtToken') || localStorage.getItem('token');
        
        const defaultHeaders = {
            'Content-Type': 'application/json'
        };

        if (token) {
            defaultHeaders['Authorization'] = `Bearer ${token}`;
        }

        const config = {
            ...options,
            headers: {
                ...defaultHeaders,
                ...options.headers
            }
        };

        try {
            const response = await fetch(`${API_BASE_URL}${endpoint}`, config);

            if (!response.ok) {
                // Tenta ler o JSON de erro do backend
                const errorText = await response.text();
                let errorMsg = errorText;
                try {
                    const errorJson = JSON.parse(errorText);
                    errorMsg = errorJson.erro || errorJson.message || errorText;
                } catch(e) {}
                
                if (response.status === 401) {
                    UI.showAlert('Sess√£o expirada. Fa√ßa login novamente.', 'danger');
                    setTimeout(() => window.location.href = '../index.html', 2000);
                }
                
                throw new Error(errorMsg);
            }

            // Se o corpo estiver vazio (ex: delete), retorna null
            const text = await response.text();
            return text ? JSON.parse(text) : {};
        } catch (error) {
            console.error(`Erro na requisi√ß√£o ${endpoint}:`, error);
            throw error;
        }
    }

    // ==========================================
    // HELPER: VERIFICAR SE EST√Å ENCERRADA
    // ==========================================
    function isCampanhaEncerrada(campanha) {
        if (!campanha || !campanha.cam_data_fim) return false;
        const hoje = new Date();
        hoje.setHours(0,0,0,0);
        
        // Ajuste o parse conforme o formato que vem do cache (yyyy-MM-dd ou ISO)
        const dataFim = new Date(campanha.cam_data_fim + "T23:59:59");
        
        return dataFim < hoje;
    }

    // ==========================================
    // INICIALIZA√á√ÉO
    // ==========================================
    document.addEventListener('DOMContentLoaded', async function() {
        // Verifica se tem Auth e se √© Admin (se necess√°rio)
        if (typeof Auth !== 'undefined' && !Auth.guardAdminRoute()) return; 

        const user = Auth ? Auth.getUser() : null;
        if(user) document.getElementById('userName').textContent = user.nome || "Volunt√°rio";

        const logoutBtn = document.getElementById('logoutBtn');
        if(logoutBtn) {
            logoutBtn.addEventListener('click', (e) => {
                e.preventDefault();
                if (confirm('Deseja realmente sair?')) Auth.logout();
            });
        }

        await carregarVoluntarios();
        await carregarCampanhas();
        
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.addEventListener('input', function(e) {
                const term = e.target.value.toLowerCase();
                const rows = document.querySelectorAll('#tabelaCampanhas tr');
                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(term) ? '' : 'none';
                });
            });
        }
    });

    // ==========================================
    // VOLUNT√ÅRIOS
    // ==========================================
    async function carregarVoluntarios() {
        const select = document.getElementById('responsavel');
        const selectAdd = document.getElementById('addVoluntario');
        
        try {
            const lista = await fetchAPI('/admin/voluntarios');
            listaVoluntariosCache = Array.isArray(lista) ? lista : [];

            let html = '<option value="">Selecione...</option>';
            
            if (Array.isArray(lista)) {
                lista.forEach(vol => {
                    const id = vol.vol_id || vol.id;
                    const nome = vol.vol_nome || vol.nome || `Volunt√°rio ${id}`;
                    html += `<option value="${id}">${nome} (ID: ${id})</option>`;
                });
            }

            if(select) select.innerHTML = html;
            if(selectAdd) selectAdd.innerHTML = html;

        } catch (error) {
            console.warn('Erro ao carregar lista de volunt√°rios:', error);
        }
    }

    // ==========================================
    // CAMPANHAS
    // ==========================================
    async function carregarCampanhas() {
        try {
            const campanhas = await fetchAPI('/campanha');
            listaCampanhasCache = campanhas; 
            renderizarCampanhas(campanhas);
        } catch (error) {
            document.getElementById('tabelaCampanhas').innerHTML = 
                `<tr><td colspan="7" class="text-center text-danger">Erro ao carregar: ${error.message}</td></tr>`;
        }
    }

    function renderizarCampanhas(campanhas) {
        const tbody = document.getElementById('tabelaCampanhas');
        tbody.innerHTML = '';

        if (!campanhas || campanhas.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center">Nenhuma campanha encontrada.</td></tr>';
            return;
        }

        campanhas.forEach(campanha => {
            const meta = campanha.cam_meta_arrecadacao || 0;
            const arrecadado = campanha.cam_valor_arrecadado || 0;
            const progresso = meta > 0 ? (arrecadado / meta) * 100 : 0;
            
            const encerrada = isCampanhaEncerrada(campanha);
            const status = encerrada ? 'Encerrada' : 'Ativa';
            const badgeClass = encerrada ? 'badge-secondary' : 'badge-success';

            const idResponsavel = campanha.voluntario_vol_id;
            let nomeResponsavel = `ID: ${idResponsavel}`; 
            
            const voluntarioEncontrado = listaVoluntariosCache.find(v => (v.vol_id || v.id) === idResponsavel);
            if (voluntarioEncontrado) {
                nomeResponsavel = voluntarioEncontrado.vol_nome || voluntarioEncontrado.nome;
            }

            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${campanha.cam_desc || 'Sem descri√ß√£o'}</td>
                <td>${formatarData(campanha.cam_data_ini)} - ${formatarData(campanha.cam_data_fim)}</td>
                <td>${nomeResponsavel}</td>
                <td>R$ ${meta.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                <td>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <div style="flex: 1; height: 8px; background: var(--border-color); border-radius: 4px; overflow: hidden;">
                            <div style="width: ${Math.min(progresso, 100)}%; height: 100%; background: var(--success-color);"></div>
                        </div>
                        <span style="font-size: 0.875rem;">${progresso.toFixed(1)}%</span>
                    </div>
                </td>
                <td><span class="badge ${badgeClass}">${status}</span></td>
                <td>
                    <button class="btn btn-sm btn-info" onclick="editarCampanha(${campanha.cam_id})" title="Editar">‚úèÔ∏è</button>
                    <button class="btn btn-sm btn-warning" onclick="gerenciarEquipe(${campanha.cam_id})" title="Equipe">üë•</button>
                    <button class="btn btn-sm btn-danger" onclick="excluirCampanha(${campanha.cam_id})" title="Excluir">üóëÔ∏è</button>
                </td>
            `;
            tbody.appendChild(row);
        });
        
        filtrarPorStatus();
    }

    // Helper para converter data do banco para input (yyyy-MM-dd)
    function formatarDataParaInput(data) {
        if (!data) return '';
        // Se o backend manda dd/MM/yyyy
        if (data.includes('/')) {
            const p = data.split('/');
            return `${p[2]}-${p[1]}-${p[0]}`;
        }
        // Se for Timestamp ou ISO
        if (data.includes('T')) {
            return data.split('T')[0];
        }
        return data;
    }

    // ==========================================
    // A√á√ïES DE CAMPANHA (SALVAR / EDITAR / EXCLUIR)
    // ==========================================
    async function salvarCampanha() {
        const form = document.getElementById('formCampanha');
        
        const descricao = document.getElementById('descricao').value;
        const dataInicioVal = document.getElementById('dataInicio').value;
        const dataFimVal = document.getElementById('dataFim').value;
        const responsavel = document.getElementById('responsavel').value;
        const id = document.getElementById('campanhaId').value; // Se tiver ID, √© edi√ß√£o

        if(!descricao || !dataInicioVal || !dataFimVal || !responsavel) {
            UI.showAlert('Preencha todos os campos obrigat√≥rios.', 'warning');
            return;
        }

        // --- VALIDA√á√ÉO CR√çTICA (REGRA DA PROFESSORA) ---
        const hoje = new Date();
        hoje.setHours(0, 0, 0, 0);

        // Adiciona T00:00:00 para garantir que o JS considere a data local
        const dataInicio = new Date(dataInicioVal + 'T00:00:00');
        const dataFim = new Date(dataFimVal + 'T00:00:00');

        // Regra 1: Se for NOVO cadastro (id vazio), data in√≠cio >= hoje
        if (!id && dataInicio < hoje) {
            UI.showAlert('A data de in√≠cio deve ser igual ou posterior √† data de hoje.', 'warning');
            return;
        }

        // Regra 2: Data Fim deve ser >= Data In√≠cio
        if (dataFim < dataInicio) {
            UI.showAlert('A data final n√£o pode ser anterior √† data de in√≠cio.', 'warning');
            return;
        }
        // -----------------------------------------------

        const data = {
            cam_desc: descricao,
            cam_data_ini: dataInicioVal,
            cam_data_fim: dataFimVal,
            voluntario_vol_id: parseInt(responsavel),
            cam_meta_arrecadacao: parseFloat(document.getElementById('meta').value) || 0,
            cam_valor_arrecadado: 0
        };

        try {
            if (id) {
                // Atualizar (PUT) - Aqui a valida√ß√£o de data passada n√£o deve impedir, pois pode ser ajuste de campanha antiga
                await fetchAPI(`/campanha/${id}`, { method: 'PUT', body: JSON.stringify(data) });
                UI.showAlert('Campanha atualizada!', 'success');
            } else {
                // Criar (POST) - A valida√ß√£o de backend tamb√©m vai pegar se o JS falhar
                await fetchAPI('/campanha', { method: 'POST', body: JSON.stringify(data) });
                UI.showAlert('Campanha criada!', 'success');
            }
            closeModal('modalCampanha');
            carregarCampanhas();
        } catch (error) {
            UI.showAlert('Erro ao salvar: ' + error.message, 'danger');
        }
    }

    async function excluirCampanha(id) {
        // --- VALIDA√á√ÉO: N√ÉO EXCLUIR CAMPANHA ENCERRADA ---
        const campanha = listaCampanhasCache.find(c => c.cam_id === id);
        if (campanha && isCampanhaEncerrada(campanha)) {
            UI.showAlert('N√£o √© poss√≠vel excluir uma campanha que j√° foi encerrada.', 'warning');
            return;
        }
        // -------------------------------------------------

        UI.confirm('Deseja excluir esta campanha permanentemente?', async () => {
            try {
                await fetchAPI(`/campanha/${id}`, { method: 'DELETE' });
                UI.showAlert('Campanha exclu√≠da.', 'success');
                carregarCampanhas();
            } catch (error) {
                UI.showAlert('Erro ao excluir: ' + error.message, 'danger');
            }
        });
    }

    async function editarCampanha(id) {
        try {
            const camp = await fetchAPI(`/campanha/${id}`);
            
            document.getElementById('campanhaId').value = camp.cam_id;
            document.getElementById('descricao').value = camp.cam_desc;
            
            // Formata as datas para o input aceitar (yyyy-MM-dd)
            document.getElementById('dataInicio').value = formatarDataParaInput(camp.cam_data_ini);
            document.getElementById('dataFim').value = formatarDataParaInput(camp.cam_data_fim);
            
            document.getElementById('meta').value = camp.cam_meta_arrecadacao;
            document.getElementById('responsavel').value = camp.voluntario_vol_id;
            
            // Fallback se o respons√°vel n√£o estiver na lista (ex: inativo)
            if (!document.getElementById('responsavel').value && camp.voluntario_vol_id) {
                 const sel = document.getElementById('responsavel');
                 const opt = document.createElement("option");
                 opt.value = camp.voluntario_vol_id;
                 opt.text = `Volunt√°rio ID: ${camp.voluntario_vol_id} (N√£o listado)`;
                 opt.selected = true;
                 sel.add(opt);
            }
            
            document.getElementById('modalTitle').textContent = 'Editar Campanha';
            UI.openModal('modalCampanha');
        } catch (error) {
            UI.showAlert('Erro ao carregar: ' + error.message, 'danger');
        }
    }

    // ==========================================
    // EQUIPE DA CAMPANHA
    // ==========================================
    async function gerenciarEquipe(id) {
        document.getElementById('campanhaVoluntariosId').value = id;
        
        // Verificar status da campanha para exibi√ß√£o do aviso
        const campanha = listaCampanhasCache.find(c => c.cam_id === id);
        const encerrada = campanha && isCampanhaEncerrada(campanha);
        
        const areaAdd = document.getElementById('areaAdicionarMembro');
        const aviso = document.getElementById('avisoCampanhaEncerrada');
        
        // Bloqueia adi√ß√£o se estiver encerrada
        if (encerrada) {
            if(areaAdd) areaAdd.style.display = 'none';
            if(aviso) aviso.style.display = 'block';
        } else {
            if(areaAdd) areaAdd.style.display = 'block';
            if(aviso) aviso.style.display = 'none';
        }

        try {
            const lista = await fetchAPI(`/campresponsavel/campanha/${id}`);
            renderizarEquipe(lista, encerrada); 
            UI.openModal('modalVoluntarios');
        } catch (error) {
            renderizarEquipe([], encerrada);
            UI.openModal('modalVoluntarios');
        }
    }

    function renderizarEquipe(lista, encerrada) {
        const tbody = document.getElementById('tabelaVoluntariosCampanha');
        tbody.innerHTML = '';

        if (!lista || lista.length === 0 || lista.mensagem) {
            tbody.innerHTML = '<tr><td colspan="3" class="text-center">Nenhum volunt√°rio vinculado.</td></tr>';
            return;
        }

        lista.forEach(item => {
            const idMembro = item.voluntario_vol_id;
            let nomeMembro = `ID: ${idMembro}`;
            
            // Busca nome no cache
            const voluntarioEncontrado = listaVoluntariosCache.find(v => (v.vol_id || v.id) === idMembro);
            if (voluntarioEncontrado) {
                nomeMembro = voluntarioEncontrado.vol_nome || voluntarioEncontrado.nome;
            } 

            // Se a campanha estiver encerrada, desabilita o bot√£o de exclus√£o
            const btnRemover = encerrada 
                ? `<button class="btn btn-sm btn-secondary" disabled title="Campanha Encerrada">üîí</button>`
                : `<button class="btn btn-sm btn-danger" onclick="removerDaEquipe(${idMembro})">Remover</button>`;

            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${nomeMembro}</td>
                <td>${item.Obs_texto || '-'}</td>
                <td>${btnRemover}</td>
            `;
            tbody.appendChild(row);
        });
    }

    async function adicionarVoluntario() {
        const campanhaId = document.getElementById('campanhaVoluntariosId').value;
        const voluntarioId = document.getElementById('addVoluntario').value;

        // --- VALIDA√á√ÉO: N√ÉO ASSOCIAR EM CAMPANHA ENCERRADA ---
        const campanha = listaCampanhasCache.find(c => c.cam_id == campanhaId);
        if (campanha && isCampanhaEncerrada(campanha)) {
            UI.showAlert('N√£o √© poss√≠vel associar volunt√°rios a uma campanha encerrada.', 'warning');
            return;
        }

        if (!voluntarioId) {
            UI.showAlert('Selecione um volunt√°rio.', 'warning');
            return;
        }

        const hoje = new Date().toISOString().split('T')[0];
        
        const dados = {
            cam_id: parseInt(campanhaId),
            voluntario_vol_id: parseInt(voluntarioId),
            DATA_INICIO: hoje,
            DATA_FIM: hoje, // Pode ajustar se quiser pegar a data fim da campanha
            Obs_texto: "Adicionado via painel"
        };

        try {
            await fetchAPI('/campresponsavel/registrar', {
                method: 'POST',
                body: JSON.stringify(dados)
            });
            
            UI.showAlert('Volunt√°rio adicionado!', 'success');
            gerenciarEquipe(campanhaId);
        } catch (error) {
            UI.showAlert('Erro ao adicionar: ' + error.message, 'danger');
        }
    }

    async function removerDaEquipe(voluntarioId) {
        const campanhaId = document.getElementById('campanhaVoluntariosId').value;
        
        const campanha = listaCampanhasCache.find(c => c.cam_id == campanhaId);
        if (campanha && isCampanhaEncerrada(campanha)) {
            UI.showAlert('N√£o √© poss√≠vel alterar equipe de campanha encerrada.', 'warning');
            return;
        }

        UI.confirm('Remover da equipe?', async () => {
            try {
                await fetchAPI(`/campresponsavel/${campanhaId}/${voluntarioId}`, { method: 'DELETE' });
                UI.showAlert('Removido com sucesso.', 'success');
                gerenciarEquipe(campanhaId);
            } catch (error) {
                UI.showAlert('Erro ao remover: ' + error.message, 'danger');
            }
        });
    }

    // ==========================================
    // HELPERS GERAIS
    // ==========================================
    function formatarData(data) {
        if(!data) return '-';
        // Se j√° for dd/MM/yyyy ou yyyy-MM-dd
        if(data.includes('-')) {
            const p = data.split('-');
            if(p.length === 3 && p[0].length === 4) return `${p[2]}/${p[1]}/${p[0]}`; // De ISO para BR
        }
        return new Date(data).toLocaleDateString('pt-BR');
    }

    function filtrarPorStatus() {
        const status = document.getElementById('filtroStatus').value.toLowerCase();
        const rows = document.querySelectorAll('#tabelaCampanhas tr');
        
        rows.forEach(row => {
            const badge = row.querySelector('.badge');
            if(badge) {
                const texto = badge.textContent.toLowerCase();
                if(!status || (status === 'ativa' && texto === 'ativa') || (status === 'encerrada' && texto === 'encerrada')) {
                    row.style.display = '';
                } else if (!status) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            }
        });
    }

    function openModal(id) { 
        if(id === 'modalCampanha') {
            document.getElementById('formCampanha').reset();
            document.getElementById('campanhaId').value = '';
            document.getElementById('modalTitle').textContent = 'Nova Campanha';
        }
        UI.openModal(id); 
    }
    function closeModal(id) { UI.closeModal(id); }
</script>
</body>
</html>