<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DOARC - Gerenciar Donat√°rios</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <a href="dashboard.html" class="logo">DOARC</a>
            <div class="user-menu">
                <span class="user-name" id="userName">Volunt√°rio</span>
                <button class="btn-logout" id="logoutBtn">Sair</button>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="nav">
        <ul class="nav-list">
            <li class="nav-item">
                <a href="dashboard.html" class="nav-link">Dashboard</a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link active">Gerenciar</a>
                <ul class="submenu">
                    <li class="submenu-item"><a href="gerenciar-doadores.html" class="submenu-link">Doadores</a></li>
                    <li class="submenu-item"><a href="gerenciar-donatarios.html" class="submenu-link">Donat√°rios</a></li>
                    <li class="submenu-item"><a href="gerenciar-produtos.html" class="submenu-link">Produtos</a></li>
                    <li class="submenu-item"><a href="gerenciar-categorias.html" class="submenu-link">Categorias</a></li>
                    <li class="submenu-item"><a href="gerenciar-voluntarios.html" class="submenu-link">Volunt√°rios</a></li>
                    <li class="submenu-item"><a href="gerenciar-campanhas.html" class="submenu-link">Campanhas</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link">Doa√ß√µes</a>
                <ul class="submenu">
                    <li class="submenu-item"><a href="receber-doacoes.html" class="submenu-link">Receber Doa√ß√µes</a></li>
                    <li class="submenu-item"><a href="efetuar-doacoes.html" class="submenu-link">Efetuar Doa√ß√µes</a></li>
                    <li class="submenu-item"><a href="agendar-doacao.html" class="submenu-link">Agendar Doa√ß√£o</a></li>
                    <li class="submenu-item"><a href="agendar-retirada.html" class="submenu-link">Agendar Retirada</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link">Estoque</a>
                <ul class="submenu">
                    <li class="submenu-item"><a href="visualizar-estoque.html" class="submenu-link">Visualizar Estoque</a></li>
                    <li class="submenu-item"><a href="registrar-acerto.html" class="submenu-link">Acerto de Estoque</a></li>
                    <li class="submenu-item"><a href="lancar-compra.html" class="submenu-link">Lan√ßar Compra/Arrecada√ß√£o</a></li>
                    <li class="submenu-item"><a href="agendar-higienizacao.html" class="submenu-link">Agendar Higieniza√ß√£o</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <a href="relatorios.html" class="nav-link">Relat√≥rios</a>
            </li>
        </ul>
    </nav>

    <!-- Main Content -->
    <main class="container">
        <div class="breadcrumb">
            <div class="breadcrumb-item"><a href="dashboard.html">Dashboard</a></div>
            <div class="breadcrumb-item">Gerenciar</div>
            <div class="breadcrumb-item active">Donat√°rios</div>
        </div>

        <div class="card">
            <div class="card-header">
                <h1 class="card-title">Gerenciar Donat√°rios</h1>
                <p class="card-subtitle">Cadastre, edite e consulte informa√ß√µes dos benefici√°rios</p>
            </div>
            <div class="card-body">
                <!-- Search and Actions -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">
                    <input
                        type="text"
                        id="searchInput"
                        class="form-control"
                        placeholder="Buscar por nome, CPF ou endere√ßo..."
                        style="max-width: 400px;"
                    >
                    <button class="btn btn-primary" onclick="openModal('modalDonatario')">
                        ‚ûï Novo Donat√°rio
                    </button>
                </div>

                <!-- Table -->
                <div class="table-container">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>CPF</th>
                                <th>Telefone</th>
                                <th>Endere√ßo</th>
                                <th>Status</th>
                                <th>√öltima Doa√ß√£o</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaDonatarios">
                            <tr>
                                <td>Fam√≠lia Silva</td>
                                <td>123.456.789-00</td>
                                <td>(18) 99999-9999</td>
                                <td>Rua A, 123 - Centro</td>
                                <td><span class="badge badge-success">Ativo</span></td>
                                <td>05/10/2025</td>
                                <td>
                                    <button class="btn btn-sm btn-info" onclick="editarDonatario(1)">‚úèÔ∏è</button>
                                    <button class="btn btn-sm btn-warning" onclick="verificarNecessidade(1)">üìã</button>
                                    <button class="btn btn-sm btn-danger" onclick="excluirDonatario(1)">üóëÔ∏è</button>
                                </td>
                            </tr>
                            <tr>
                                <td>Jos√© Santos</td>
                                <td>987.654.321-00</td>
                                <td>(18) 98888-8888</td>
                                <td>Rua B, 456 - Jardim</td>
                                <td><span class="badge badge-success">Ativo</span></td>
                                <td>01/10/2025</td>
                                <td>
                                    <button class="btn btn-sm btn-info" onclick="editarDonatario(2)">‚úèÔ∏è</button>
                                    <button class="btn btn-sm btn-warning" onclick="verificarNecessidade(2)">üìã</button>
                                    <button class="btn btn-sm btn-danger" onclick="excluirDonatario(2)">üóëÔ∏è</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal Cadastro/Edi√ß√£o -->
    <div id="modalDonatario" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Novo Donat√°rio</h2>
                <button class="modal-close" onclick="closeModal('modalDonatario')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="formDonatario">
                    <input type="hidden" id="donatarioId">

                    <div class="form-row">
                        <div class="form-group">
                            <label for="nome" class="form-label required">Nome/Respons√°vel</label>
                            <input type="text" id="nome" class="form-control" required>
                            <div class="form-error">Nome √© obrigat√≥rio</div>
                        </div>

                        <div class="form-group">
                            <label for="cpf" class="form-label required">CPF</label>
                            <input type="text" id="cpf" class="form-control" data-mask="cpf" required>
                            <div class="form-error">CPF inv√°lido</div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="telefone" class="form-label required">Telefone</label>
                            <input type="tel" id="telefone" class="form-control" data-mask="phone" required>
                            <div class="form-error">Telefone inv√°lido</div>
                        </div>

                        <div class="form-group">
                            <label for="email" class="form-label">E-mail</label>
                            <input type="email" id="email" class="form-control">
                            <div class="form-error">E-mail inv√°lido</div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="endereco" class="form-label required">Endere√ßo Completo</label>
                        <input type="text" id="endereco" class="form-control" required>
                        <div class="form-error">Endere√ßo √© obrigat√≥rio</div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="numeroFamiliares" class="form-label">N√∫mero de Familiares</label>
                            <input type="number" id="numeroFamiliares" class="form-control" min="1" value="1">
                        </div>

                        <div class="form-group">
                            <label for="rendaFamiliar" class="form-label">Renda Familiar (R$)</label>
                            <input type="number" id="rendaFamiliar" class="form-control" step="0.01" min="0">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="necessidadesEspecificas" class="form-label">Necessidades Espec√≠ficas</label>
                        <textarea id="necessidadesEspecificas" class="form-control" rows="3" placeholder="Ex: fraldas, rem√©dios, alimentos espec√≠ficos..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="observacoes" class="form-label">Observa√ß√µes</label>
                        <textarea id="observacoes" class="form-control" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('modalDonatario')">Cancelar</button>
                <button class="btn btn-primary" onclick="salvarDonatario()">Salvar</button>
            </div>
        </div>
    </div>

    <!-- Modal Verificar Necessidade -->
    <div id="modalVerificarNecessidade" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Verificar Necessidade de Doa√ß√£o</h2>
                <button class="modal-close" onclick="closeModal('modalVerificarNecessidade')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="formVerificarNecessidade">
                    <input type="hidden" id="verificacaoDonatarioId">

                    <div class="form-group">
                        <label class="form-label">Donat√°rio</label>
                        <input type="text" id="verificacaoNome" class="form-control" readonly>
                    </div>

                    <div class="form-group">
                        <label for="necessidadesVerificadas" class="form-label required">Necessidades Identificadas</label>
                        <textarea id="necessidadesVerificadas" class="form-control" rows="4" required placeholder="Descreva as necessidades identificadas durante a verifica√ß√£o..."></textarea>
                        <div class="form-error">Descreva as necessidades</div>
                    </div>

                    <div class="form-group">
                        <label for="precisaDoacaoAgora" class="form-label required">Status da Necessidade</label>
                        <select id="precisaDoacaoAgora" class="form-control form-select" required>
                            <option value="">Selecione</option>
                            <option value="sim_urgente">Sim - Urgente</option>
                            <option value="sim_normal">Sim - Normal</option>
                            <option value="nao">N√£o precisa mais</option>
                        </select>
                        <div class="form-error">Selecione o status</div>
                    </div>

                    <div class="form-group">
                        <label for="dataVerificacao" class="form-label required">Data da Verifica√ß√£o</label>
                        <input type="date" id="dataVerificacao" class="form-control" required>
                        <div class="form-error">Data √© obrigat√≥ria</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('modalVerificarNecessidade')">Cancelar</button>
                <button class="btn btn-primary" onclick="salvarVerificacao()">Salvar Verifica√ß√£o</button>
            </div>
        </div>
    </div>

    <script src="../js/app.js"></script>
    <script>
        // Definir data de hoje
        document.getElementById('dataVerificacao').valueAsDate = new Date();

        // Busca em tempo real
        document.getElementById('searchInput').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('#tabelaDonatarios tr');

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        });

        function openModal(modalId) {
            if (modalId === 'modalDonatario') {
                document.getElementById('formDonatario').reset();
                document.getElementById('donatarioId').value = '';
                document.getElementById('modalTitle').textContent = 'Novo Donat√°rio';
            }
            UI.openModal(modalId);
        }

        function closeModal(modalId) {
            UI.closeModal(modalId);
        }

        function editarDonatario(id) {
            // TODO: Carregar dados do donat√°rio da API
            document.getElementById('donatarioId').value = id;
            document.getElementById('modalTitle').textContent = 'Editar Donat√°rio';
            document.getElementById('nome').value = 'Fam√≠lia Silva';
            document.getElementById('cpf').value = '123.456.789-00';
            document.getElementById('telefone').value = '(18) 99999-9999';
            document.getElementById('endereco').value = 'Rua A, 123 - Centro';

            UI.openModal('modalDonatario');
        }

        function verificarNecessidade(id) {
            // TODO: Carregar dados do donat√°rio
            document.getElementById('verificacaoDonatarioId').value = id;
            document.getElementById('verificacaoNome').value = 'Fam√≠lia Silva';
            document.getElementById('necessidadesVerificadas').value = '';
            document.getElementById('precisaDoacaoAgora').value = '';

            UI.openModal('modalVerificarNecessidade');
        }

        function excluirDonatario(id) {
            UI.confirm('Tem certeza que deseja excluir este donat√°rio?', async function() {
                try {
                    // TODO: Integrar com API
                    // await API.delete(`/donatarios/${id}`);
                    UI.showAlert('Donat√°rio exclu√≠do com sucesso!', 'success');
                } catch (error) {
                    console.error('Erro ao excluir donat√°rio:', error);
                }
            });
        }

        async function salvarDonatario() {
            const form = document.getElementById('formDonatario');
            const nome = document.getElementById('nome');
            const cpf = document.getElementById('cpf');
            const telefone = document.getElementById('telefone');
            const endereco = document.getElementById('endereco');
            const email = document.getElementById('email');

            // Limpa erros
            Validator.clearAllErrors(form);

            // Valida√ß√µes
            let isValid = true;

            if (Validator.isEmpty(nome.value)) {
                Validator.showError(nome, 'Nome √© obrigat√≥rio');
                isValid = false;
            }

            if (Validator.isEmpty(cpf.value)) {
                Validator.showError(cpf, 'CPF √© obrigat√≥rio');
                isValid = false;
            } else if (!Validator.isValidCPF(cpf.value)) {
                Validator.showError(cpf, 'CPF inv√°lido');
                isValid = false;
            }

            if (Validator.isEmpty(telefone.value)) {
                Validator.showError(telefone, 'Telefone √© obrigat√≥rio');
                isValid = false;
            } else if (!Validator.isValidPhone(telefone.value)) {
                Validator.showError(telefone, 'Telefone inv√°lido');
                isValid = false;
            }

            if (Validator.isEmpty(endereco.value)) {
                Validator.showError(endereco, 'Endere√ßo √© obrigat√≥rio');
                isValid = false;
            }

            if (!Validator.isEmpty(email.value) && !Validator.isValidEmail(email.value)) {
                Validator.showError(email, 'E-mail inv√°lido');
                isValid = false;
            }

            if (!isValid) return;

            try {
                const donatarioId = document.getElementById('donatarioId').value;
                const data = {
                    nome: nome.value,
                    cpf: cpf.value.replace(/[^\d]/g, ''),
                    telefone: telefone.value.replace(/[^\d]/g, ''),
                    email: email.value,
                    endereco: endereco.value,
                    numeroFamiliares: document.getElementById('numeroFamiliares').value,
                    rendaFamiliar: document.getElementById('rendaFamiliar').value,
                    necessidadesEspecificas: document.getElementById('necessidadesEspecificas').value,
                    observacoes: document.getElementById('observacoes').value
                };

                if (donatarioId) {
                    // TODO: Atualizar
                    // await API.put(`/donatarios/${donatarioId}`, data);
                    UI.showAlert('Donat√°rio atualizado com sucesso!', 'success');
                } else {
                    // TODO: Criar
                    // await API.post('/donatarios', data);
                    UI.showAlert('Donat√°rio cadastrado com sucesso!', 'success');
                }

                closeModal('modalDonatario');
            } catch (error) {
                console.error('Erro ao salvar donat√°rio:', error);
            }
        }

        async function salvarVerificacao() {
            const form = document.getElementById('formVerificarNecessidade');
            const necessidades = document.getElementById('necessidadesVerificadas');
            const status = document.getElementById('precisaDoacaoAgora');
            const data = document.getElementById('dataVerificacao');

            Validator.clearAllErrors(form);
            let isValid = true;

            if (Validator.isEmpty(necessidades.value)) {
                Validator.showError(necessidades, 'Descreva as necessidades');
                isValid = false;
            }

            if (Validator.isEmpty(status.value)) {
                Validator.showError(status, 'Selecione o status');
                isValid = false;
            }

            if (Validator.isEmpty(data.value)) {
                Validator.showError(data, 'Data √© obrigat√≥ria');
                isValid = false;
            }

            if (!isValid) return;

            try {
                const verificacaoData = {
                    donatarioId: document.getElementById('verificacaoDonatarioId').value,
                    necessidades: necessidades.value,
                    status: status.value,
                    dataVerificacao: data.value
                };

                // TODO: Integrar com API
                // await API.post('/donatarios/verificacao', verificacaoData);

                UI.showAlert('Verifica√ß√£o registrada com sucesso!', 'success');
                closeModal('modalVerificarNecessidade');
            } catch (error) {
                console.error('Erro ao salvar verifica√ß√£o:', error);
            }
        }
    </script>
</body>
</html>
