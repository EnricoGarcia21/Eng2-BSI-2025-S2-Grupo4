<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DOARC - Efetuar Doa√ß√µes</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <a href="dashboard.html" class="logo">DOARC</a>
            <div class="user-menu">
                <span class="user-name" id="userName">Volunt√°rio</span>
                <button class="btn-logout" id="logoutBtn">Sair</button>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="nav">
        <ul class="nav-list">
            <li class="nav-item">
                <a href="dashboard.html" class="nav-link">Dashboard</a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link">Gerenciar</a>
                <ul class="submenu">
                    <li class="submenu-item"><a href="gerenciar-doadores.html" class="submenu-link">Doadores</a></li>
                    <li class="submenu-item"><a href="gerenciar-donatarios.html" class="submenu-link">Donat√°rios</a></li>
                    <li class="submenu-item"><a href="gerenciar-produtos.html" class="submenu-link">Produtos</a></li>
                    <li class="submenu-item"><a href="gerenciar-categorias.html" class="submenu-link">Categorias</a></li>
                    <li class="submenu-item"><a href="gerenciar-voluntarios.html" class="submenu-link">Volunt√°rios</a></li>
                    <li class="submenu-item"><a href="gerenciar-campanhas.html" class="submenu-link">Campanhas</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link active">Doa√ß√µes</a>
                <ul class="submenu">
                    <li class="submenu-item"><a href="receber-doacoes.html" class="submenu-link">Receber Doa√ß√µes</a></li>
                    <li class="submenu-item"><a href="efetuar-doacoes.html" class="submenu-link">Efetuar Doa√ß√µes</a></li>
                    <li class="submenu-item"><a href="agendar-doacao.html" class="submenu-link">Agendar Doa√ß√£o</a></li>
                    <li class="submenu-item"><a href="agendar-retirada.html" class="submenu-link">Agendar Retirada</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link">Estoque</a>
                <ul class="submenu">
                    <li class="submenu-item"><a href="visualizar-estoque.html" class="submenu-link">Visualizar Estoque</a></li>
                    <li class="submenu-item"><a href="registrar-acerto.html" class="submenu-link">Acerto de Estoque</a></li>
                    <li class="submenu-item"><a href="lancar-compra.html" class="submenu-link">Lan√ßar Compra/Arrecada√ß√£o</a></li>
                    <li class="submenu-item"><a href="agendar-higienizacao.html" class="submenu-link">Agendar Higieniza√ß√£o</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <a href="relatorios.html" class="nav-link">Relat√≥rios</a>
            </li>
        </ul>
    </nav>

    <!-- Main Content -->
    <main class="container">
        <div class="breadcrumb">
            <div class="breadcrumb-item"><a href="dashboard.html">Dashboard</a></div>
            <div class="breadcrumb-item">Doa√ß√µes</div>
            <div class="breadcrumb-item active">Efetuar Doa√ß√µes</div>
        </div>

        <div class="card">
            <div class="card-header">
                <h1 class="card-title">Efetuar Doa√ß√µes</h1>
                <p class="card-subtitle">Registre a distribui√ß√£o de produtos para donat√°rios</p>
            </div>
            <div class="card-body">
                <form id="formEfetuarDoacao">
                    <!-- Informa√ß√µes do Donat√°rio -->
                    <h3 style="color: var(--primary-color); margin-bottom: 1rem;">Informa√ß√µes do Donat√°rio</h3>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="donatario" class="form-label required">Donat√°rio</label>
                            <select id="donatario" class="form-control form-select" required>
                                <option value="">Selecione um donat√°rio</option>
                                <option value="1">Ana Paula Silva - 111.222.333-44</option>
                                <option value="2">Carlos Oliveira - 555.666.777-88</option>
                                <option value="3">Fam√≠lia Santos - 999.888.777-66</option>
                            </select>
                            <div class="form-error">Selecione um donat√°rio</div>
                            <div class="form-text">
                                <a href="gerenciar-donatarios.html" style="color: var(--primary-color);">
                                    Cadastrar novo donat√°rio
                                </a>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="dataDoacao" class="form-label required">Data da Doa√ß√£o</label>
                            <input type="date" id="dataDoacao" class="form-control" required>
                            <div class="form-error">Data √© obrigat√≥ria</div>
                        </div>
                    </div>

                    <!-- Produtos Doados -->
                    <h3 style="color: var(--primary-color); margin: 2rem 0 1rem;">Produtos a Doar</h3>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="categoria" class="form-label required">Categoria</label>
                            <select id="categoria" class="form-control form-select" onchange="carregarProdutosPorCategoria()">
                                <option value="">Selecione uma categoria</option>
                                <option value="1">Alimentos</option>
                                <option value="2">Roupas</option>
                                <option value="3">Higiene</option>
                                <option value="4">M√≥veis</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="produto" class="form-label required">Produto</label>
                            <select id="produto" class="form-control form-select" onchange="verificarEstoque()">
                                <option value="">Selecione um produto</option>
                            </select>
                            <div id="avisoEstoque" class="form-text" style="display: none; color: var(--danger-color); font-weight: bold;">
                                Estoque insuficiente!
                            </div>
                        </div>
                    </div>

                    <div id="infoEstoque" style="display: none; padding: 1rem; background: #e8f4f8; border-radius: 8px; margin-bottom: 1rem;">
                        <strong>Estoque dispon√≠vel:</strong> <span id="estoqueDisponivel">0</span> <span id="unidadeEstoque">un</span>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="quantidade" class="form-label required">Quantidade</label>
                            <input type="number" id="quantidade" class="form-control" min="1">
                            <div class="form-error">Informe a quantidade</div>
                        </div>

                        <div class="form-group">
                            <label for="unidadeMedida" class="form-label required">Unidade</label>
                            <select id="unidadeMedida" class="form-control form-select" disabled>
                                <option value="un">Unidade</option>
                                <option value="kg">Kg</option>
                                <option value="l">Litro</option>
                                <option value="cx">Caixa</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="dataValidade" class="form-label">Data de Validade</label>
                            <input type="date" id="dataValidade" class="form-control" disabled>
                        </div>
                    </div>

                    <button type="button" class="btn btn-secondary" onclick="adicionarProduto()">
                        ‚ûï Adicionar Produto
                    </button>

                    <!-- Lista de Produtos Adicionados -->
                    <div id="listaProdutos" style="margin-top: 2rem; display: none;">
                        <h4>Produtos a Doar:</h4>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Produto</th>
                                        <th>Quantidade</th>
                                        <th>Validade</th>
                                        <th>A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelaProdutosAdicionados"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Campanha -->
                    <h3 style="color: var(--primary-color); margin: 2rem 0 1rem;">Informa√ß√µes Adicionais</h3>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="campanha" class="form-label">Campanha Associada</label>
                            <select id="campanha" class="form-control form-select">
                                <option value="">Nenhuma campanha</option>
                                <option value="1">Campanha de Natal 2025</option>
                                <option value="2">P√°scoa Solid√°ria 2025</option>
                                <option value="3">Inverno Solid√°rio</option>
                            </select>
                            <div class="form-text">Opcional - associe a doa√ß√£o a uma campanha</div>
                        </div>

                        <div class="form-group">
                            <label for="condicao" class="form-label">Condi√ß√£o do Item</label>
                            <select id="condicao" class="form-control form-select">
                                <option value="novo">Novo</option>
                                <option value="usado_bom">Usado - Bom Estado</option>
                                <option value="usado_regular">Usado - Estado Regular</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="observacoesDoacao" class="form-label">Observa√ß√µes</label>
                        <textarea id="observacoesDoacao" class="form-control" rows="3" placeholder="Informa√ß√µes adicionais sobre a doa√ß√£o..."></textarea>
                    </div>

                    <div class="card-footer">
                        <div class="btn-group">
                            <button type="button" class="btn btn-outline" onclick="window.location.href='dashboard.html'">
                                Cancelar
                            </button>
                            <button type="submit" class="btn btn-success">
                                ‚úì Registrar Doa√ß√£o
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <script src="../js/app.js"></script>
    <script>
        // Definir data de hoje como padr√£o
        document.getElementById('dataDoacao').valueAsDate = new Date();

        // Array para armazenar produtos adicionados
        let produtosAdicionados = [];

        // Simula√ß√£o de estoque (em produ√ß√£o, vir√° da API)
        const estoqueSimulado = {
            '1_0': { quantidade: 50, unidade: 'kg' }, // Arroz
            '1_1': { quantidade: 30, unidade: 'kg' }, // Feij√£o
            '1_2': { quantidade: 20, unidade: 'kg' }, // Macarr√£o
            '1_3': { quantidade: 15, unidade: 'l' },  // √ìleo
            '1_4': { quantidade: 25, unidade: 'kg' }, // A√ß√∫car
            '2_0': { quantidade: 40, unidade: 'un' }, // Camiseta
            '2_1': { quantidade: 35, unidade: 'un' }, // Cal√ßa
            '2_2': { quantidade: 20, unidade: 'un' }, // Agasalho
            '2_3': { quantidade: 15, unidade: 'un' }, // Sapatos
            '3_0': { quantidade: 60, unidade: 'un' }, // Sabonete
            '3_1': { quantidade: 40, unidade: 'un' }, // Shampoo
            '3_2': { quantidade: 50, unidade: 'un' }, // Pasta de Dente
            '3_3': { quantidade: 45, unidade: 'un' }, // Desodorante
            '4_0': { quantidade: 5, unidade: 'un' },  // Mesa
            '4_1': { quantidade: 8, unidade: 'un' },  // Cadeira
            '4_2': { quantidade: 3, unidade: 'un' },  // Cama
            '4_3': { quantidade: 2, unidade: 'un' }   // Guarda-roupa
        };

        function carregarProdutosPorCategoria() {
            const categoriaId = document.getElementById('categoria').value;
            const selectProduto = document.getElementById('produto');

            // Limpar produtos e resetar informa√ß√µes de estoque
            selectProduto.innerHTML = '<option value="">Selecione um produto</option>';
            document.getElementById('infoEstoque').style.display = 'none';
            document.getElementById('avisoEstoque').style.display = 'none';

            if (!categoriaId) return;

            // TODO: Carregar produtos da API baseado na categoria
            // Simula√ß√£o de produtos
            const produtos = {
                '1': ['Arroz', 'Feij√£o', 'Macarr√£o', '√ìleo', 'A√ß√∫car'],
                '2': ['Camiseta', 'Cal√ßa', 'Agasalho', 'Sapatos'],
                '3': ['Sabonete', 'Shampoo', 'Pasta de Dente', 'Desodorante'],
                '4': ['Mesa', 'Cadeira', 'Cama', 'Guarda-roupa']
            };

            if (produtos[categoriaId]) {
                produtos[categoriaId].forEach((produto, index) => {
                    const option = document.createElement('option');
                    option.value = `${categoriaId}_${index}`;
                    option.textContent = produto;
                    selectProduto.appendChild(option);
                });
            }
        }

        function verificarEstoque() {
            const produto = document.getElementById('produto');
            const produtoId = produto.value;

            if (!produtoId) {
                document.getElementById('infoEstoque').style.display = 'none';
                document.getElementById('avisoEstoque').style.display = 'none';
                return;
            }

            // TODO: Buscar estoque real da API
            const estoque = estoqueSimulado[produtoId];

            if (estoque) {
                document.getElementById('estoqueDisponivel').textContent = estoque.quantidade;
                document.getElementById('unidadeEstoque').textContent = estoque.unidade;
                document.getElementById('infoEstoque').style.display = 'block';

                // Atualizar unidade no select
                document.getElementById('unidadeMedida').value = estoque.unidade;

                // Definir max na quantidade
                document.getElementById('quantidade').max = estoque.quantidade;

                // Verificar estoque baixo
                if (estoque.quantidade < 10) {
                    document.getElementById('avisoEstoque').style.display = 'block';
                    document.getElementById('avisoEstoque').textContent = `Aten√ß√£o: Estoque baixo (${estoque.quantidade} ${estoque.unidade})`;
                    document.getElementById('avisoEstoque').style.color = 'var(--warning-color)';
                } else if (estoque.quantidade === 0) {
                    document.getElementById('avisoEstoque').style.display = 'block';
                    document.getElementById('avisoEstoque').textContent = 'Produto sem estoque!';
                    document.getElementById('avisoEstoque').style.color = 'var(--danger-color)';
                } else {
                    document.getElementById('avisoEstoque').style.display = 'none';
                }
            }
        }

        function adicionarProduto() {
            const produto = document.getElementById('produto');
            const quantidade = document.getElementById('quantidade');
            const unidade = document.getElementById('unidadeMedida');
            const dataValidade = document.getElementById('dataValidade');

            if (!produto.value || !quantidade.value) {
                UI.showAlert('Selecione um produto e informe a quantidade', 'warning');
                return;
            }

            // Verificar estoque dispon√≠vel
            const estoque = estoqueSimulado[produto.value];
            if (!estoque || parseInt(quantidade.value) > estoque.quantidade) {
                UI.showAlert('Quantidade solicitada excede o estoque dispon√≠vel!', 'danger');
                return;
            }

            const produtoTexto = produto.options[produto.selectedIndex].text;
            const unidadeTexto = unidade.options[unidade.selectedIndex].text;

            produtosAdicionados.push({
                produtoId: produto.value,
                produto: produtoTexto,
                quantidade: quantidade.value,
                unidade: unidadeTexto,
                dataValidade: dataValidade.value
            });

            atualizarTabelaProdutos();

            // Limpar campos
            produto.value = '';
            quantidade.value = '';
            dataValidade.value = '';
            document.getElementById('infoEstoque').style.display = 'none';
        }

        function atualizarTabelaProdutos() {
            const tbody = document.getElementById('tabelaProdutosAdicionados');
            const lista = document.getElementById('listaProdutos');

            if (produtosAdicionados.length === 0) {
                lista.style.display = 'none';
                return;
            }

            lista.style.display = 'block';
            tbody.innerHTML = produtosAdicionados.map((item, index) => `
                <tr>
                    <td>${item.produto}</td>
                    <td>${item.quantidade} ${item.unidade}</td>
                    <td>${item.dataValidade ? Formatter.formatDate(item.dataValidade) : 'N√£o informado'}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="removerProduto(${index})">
                            üóëÔ∏è Remover
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function removerProduto(index) {
            produtosAdicionados.splice(index, 1);
            atualizarTabelaProdutos();
        }

        // Submiss√£o do formul√°rio
        document.getElementById('formEfetuarDoacao').addEventListener('submit', async function(e) {
            e.preventDefault();

            const donatario = document.getElementById('donatario');
            const dataDoacao = document.getElementById('dataDoacao');

            // Valida√ß√µes b√°sicas
            Validator.clearAllErrors(this);
            let isValid = true;

            if (!donatario.value) {
                Validator.showError(donatario, 'Selecione um donat√°rio');
                isValid = false;
            }

            if (!dataDoacao.value) {
                Validator.showError(dataDoacao, 'Informe a data');
                isValid = false;
            }

            if (produtosAdicionados.length === 0) {
                UI.showAlert('Adicione pelo menos um produto para doar', 'warning');
                isValid = false;
            }

            if (!isValid) return;

            try {
                const data = {
                    donatarioId: donatario.value,
                    data: dataDoacao.value,
                    produtos: produtosAdicionados,
                    campanhaId: document.getElementById('campanha').value,
                    condicao: document.getElementById('condicao').value,
                    observacoes: document.getElementById('observacoesDoacao').value
                };

                // TODO: Integrar com API
                // await API.post('/doacoes/efetuar', data);

                UI.showAlert('Doa√ß√£o efetuada com sucesso! Estoque atualizado.', 'success');

                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 2000);

            } catch (error) {
                console.error('Erro ao efetuar doa√ß√£o:', error);
            }
        });
    </script>
</body>
</html>
