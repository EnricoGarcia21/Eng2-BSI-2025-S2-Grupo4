<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DOARC - Lan√ßar Compra/Arrecada√ß√£o</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <a href="dashboard.html" class="logo">DOARC</a>
            <div class="user-menu">
                <span class="user-name" id="userName">Volunt√°rio</span>
                <button class="btn-logout" id="logoutBtn">Sair</button>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="nav">
        <ul class="nav-list">
            <li class="nav-item">
                <a href="dashboard.html" class="nav-link">Dashboard</a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link">Gerenciar</a>
                <ul class="submenu">
                    <li class="submenu-item"><a href="gerenciar-doadores.html" class="submenu-link">Doadores</a></li>
                    <li class="submenu-item"><a href="gerenciar-donatarios.html" class="submenu-link">Donat√°rios</a></li>
                    <li class="submenu-item"><a href="gerenciar-produtos.html" class="submenu-link">Produtos</a></li>
                    <li class="submenu-item"><a href="gerenciar-categorias.html" class="submenu-link">Categorias</a></li>
                    <li class="submenu-item"><a href="gerenciar-voluntarios.html" class="submenu-link">Volunt√°rios</a></li>
                    <li class="submenu-item"><a href="gerenciar-campanhas.html" class="submenu-link">Campanhas</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link">Doa√ß√µes</a>
                <ul class="submenu">
                    <li class="submenu-item"><a href="receber-doacoes.html" class="submenu-link">Receber Doa√ß√µes</a></li>
                    <li class="submenu-item"><a href="efetuar-doacoes.html" class="submenu-link">Efetuar Doa√ß√µes</a></li>
                    <li class="submenu-item"><a href="agendar-doacao.html" class="submenu-link">Agendar Doa√ß√£o</a></li>
                    <li class="submenu-item"><a href="agendar-retirada.html" class="submenu-link">Agendar Retirada</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link active">Estoque</a>
                <ul class="submenu">
                    <li class="submenu-item"><a href="visualizar-estoque.html" class="submenu-link">Visualizar Estoque</a></li>
                    <li class="submenu-item"><a href="registrar-acerto.html" class="submenu-link">Acerto de Estoque</a></li>
                    <li class="submenu-item"><a href="lancar-compra.html" class="submenu-link">Lan√ßar Compra/Arrecada√ß√£o</a></li>
                    <li class="submenu-item"><a href="agendar-higienizacao.html" class="submenu-link">Agendar Higieniza√ß√£o</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <a href="relatorios.html" class="nav-link">Relat√≥rios</a>
            </li>
        </ul>
    </nav>

    <!-- Main Content -->
    <main class="container">
        <div class="breadcrumb">
            <div class="breadcrumb-item"><a href="dashboard.html">Dashboard</a></div>
            <div class="breadcrumb-item">Estoque</div>
            <div class="breadcrumb-item active">Lan√ßar Compra/Arrecada√ß√£o</div>
        </div>

        <div class="card">
            <div class="card-header">
                <h1 class="card-title">Lan√ßar Compra/Arrecada√ß√£o</h1>
                <p class="card-subtitle">Registre compras ou arrecada√ß√µes de produtos para o estoque</p>
            </div>
            <div class="card-body">
                <form id="formLancamento">
                    <!-- Tipo de Lan√ßamento -->
                    <h3 style="color: var(--primary-color); margin-bottom: 1rem;">Tipo de Lan√ßamento</h3>

                    <div class="form-group">
                        <label for="tipoLancamento" class="form-label required">Tipo</label>
                        <select id="tipoLancamento" class="form-control form-select" required onchange="toggleTipoLancamento()">
                            <option value="">Selecione o tipo</option>
                            <option value="compra">Compra (com fornecedor e valor)</option>
                            <option value="arrecadacao">Arrecada√ß√£o (sem custo)</option>
                        </select>
                        <div class="form-error">Selecione o tipo de lan√ßamento</div>
                    </div>

                    <!-- Informa√ß√µes Gerais -->
                    <h3 style="color: var(--primary-color); margin: 2rem 0 1rem;">Informa√ß√µes Gerais</h3>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="dataLancamento" class="form-label required">Data</label>
                            <input type="date" id="dataLancamento" class="form-control" required max="">
                            <div class="form-error">Data √© obrigat√≥ria</div>
                        </div>

                        <div class="form-group">
                            <label for="numeroDocumento" class="form-label">N¬∫ Documento/Nota</label>
                            <input type="text" id="numeroDocumento" class="form-control" placeholder="Ex: NF 12345">
                            <div class="form-text">N√∫mero da nota fiscal ou comprovante (opcional)</div>
                        </div>
                    </div>

                    <!-- Se√ß√£o Arrecada√ß√£o -->
                    <div id="secaoArrecadacao" style="display: none;">
                        <h3 style="color: var(--primary-color); margin: 2rem 0 1rem;">Dados da Arrecada√ß√£o</h3>

                        <div class="form-group">
                            <label for="origemArrecadacao" class="form-label">Origem da Arrecada√ß√£o</label>
                            <input type="text" id="origemArrecadacao" class="form-control" placeholder="Ex: Campanha Natal 2025, Parceria com Empresa XYZ">
                            <div class="form-text">Descreva de onde vieram os produtos arrecadados</div>
                        </div>
                    </div>

                    <!-- Produtos -->
                    <h3 style="color: var(--primary-color); margin: 2rem 0 1rem;">Produtos</h3>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="categoria" class="form-label required">Categoria</label>
                            <select id="categoria" class="form-control form-select" onchange="carregarProdutos()">
                                <option value="">Selecione uma categoria</option>
                                <!-- Categorias carregadas dinamicamente -->
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="produto" class="form-label required">Produto</label>
                            <select id="produto" class="form-control form-select">
                                <option value="">Selecione um produto</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="quantidade" class="form-label required">Quantidade</label>
                            <input type="number" id="quantidade" class="form-control" min="0.01" step="0.01">
                        </div>

                        <div class="form-group">
                            <label for="unidadeMedida" class="form-label required">Unidade</label>
                            <select id="unidadeMedida" class="form-control form-select">
                                <option value="un">Unidade</option>
                                <option value="kg">Kg</option>
                                <option value="l">Litro</option>
                                <option value="cx">Caixa</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="valorUnitario" class="form-label">Valor Unit√°rio (R$)</label>
                            <input type="number" id="valorUnitario" class="form-control" step="0.01" min="0" placeholder="0,00">
                            <div class="form-text">Opcional - apenas para compras</div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="dataValidade" class="form-label">Data de Validade</label>
                        <input type="date" id="dataValidade" class="form-control">
                        <div class="form-text">Apenas para produtos perec√≠veis</div>
                    </div>

                    <button type="button" class="btn btn-secondary" onclick="adicionarProduto()">
                        ‚ûï Adicionar Produto
                    </button>

                    <!-- Lista de Produtos Adicionados -->
                    <div id="listaProdutos" style="margin-top: 2rem; display: none;">
                        <h4>Produtos Adicionados:</h4>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Produto</th>
                                        <th>Quantidade</th>
                                        <th>Valor Unit.</th>
                                        <th>Subtotal</th>
                                        <th>Validade</th>
                                        <th>A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelaProdutos"></tbody>
                            </table>
                        </div>
                        <div style="text-align: right; padding: 1rem; background: #f8f9fa; border-radius: 8px; margin-top: 1rem;">
                            <strong style="font-size: 1.2rem;">Total: R$ <span id="totalGeral">0,00</span></strong>
                        </div>
                    </div>

                    <!-- Se√ß√£o Compra (movida para o final) -->
                    <div id="secaoCompra" style="display: none;">
                        <h3 style="color: var(--primary-color); margin: 2rem 0 1rem;">Dados do Pagamento</h3>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="fornecedor" class="form-label required">Fornecedor</label>
                                <input type="text" id="fornecedor" class="form-control" placeholder="Nome do fornecedor">
                                <div class="form-error">Fornecedor √© obrigat√≥rio</div>
                            </div>

                            <div class="form-group">
                                <label for="formaPagamento" class="form-label">Forma de Pagamento</label>
                                <select id="formaPagamento" class="form-control form-select">
                                    <option value="dinheiro">Dinheiro</option>
                                    <option value="cartao">Cart√£o</option>
                                    <option value="pix">PIX</option>
                                    <option value="boleto">Boleto</option>
                                    <option value="transferencia">Transfer√™ncia</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="valorTotal" class="form-label required">Valor Total da Compra (R$)</label>
                                <input type="number" id="valorTotal" class="form-control" step="0.01" min="0" placeholder="0,00">
                                <div class="form-error">Valor total √© obrigat√≥rio</div>
                                <div class="form-text">Valor total da compra conforme nota fiscal</div>
                            </div>

                            <div class="form-group">
                                <label for="valorPago" class="form-label required">Valor Pago (R$)</label>
                                <input type="number" id="valorPago" class="form-control" step="0.01" min="0" placeholder="0,00">
                                <div class="form-error">Valor pago √© obrigat√≥rio</div>
                                <div class="form-text">Valor efetivamente pago</div>
                            </div>
                        </div>
                    </div>

                    <!-- Informa√ß√µes Adicionais -->
                    <h3 style="color: var(--primary-color); margin: 2rem 0 1rem;">Informa√ß√µes Adicionais</h3>

                    <div class="form-group">
                        <label for="campanha" class="form-label">Campanha Associada</label>
                        <select id="campanha" class="form-control form-select">
                            <option value="">Nenhuma campanha</option>
                            <option value="1">Campanha de Natal 2025</option>
                            <option value="2">P√°scoa Solid√°ria 2025</option>
                            <option value="3">Inverno Solid√°rio</option>
                        </select>
                        <div class="form-text">Opcional - associe a uma campanha</div>
                    </div>

                    <div class="form-group">
                        <label for="observacoes" class="form-label">Observa√ß√µes</label>
                        <textarea id="observacoes" class="form-control" rows="3" placeholder="Informa√ß√µes adicionais sobre o lan√ßamento..."></textarea>
                    </div>

                    <div class="card-footer">
                        <div class="btn-group">
                            <button type="button" class="btn btn-outline" onclick="window.location.href='visualizar-estoque.html'">
                                Cancelar
                            </button>
                            <button type="submit" class="btn btn-success">
                                ‚úì Registrar Lan√ßamento
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <script src="../js/app.js"></script>
    <script>
        // API Base URLs
        const API_COMPRA = 'http://localhost:8080/apis/compra';
        const API_PRODUTO = 'http://localhost:8080/apis/produto';
        const API_CATEGORIA = 'http://localhost:8080/apis/categoria';

        // Definir data de hoje como padr√£o e m√°ximo
        const hoje = new Date();
        const dataInput = document.getElementById('dataLancamento');
        dataInput.valueAsDate = hoje;
        dataInput.max = hoje.toISOString().split('T')[0];

        // Array para produtos adicionados
        let produtosAdicionados = [];
        let produtosCache = {}; // Cache de produtos por categoria

        // Carrega categorias ao iniciar
        document.addEventListener('DOMContentLoaded', function() {
            carregarCategorias();
        });

        async function carregarCategorias() {
            try {
                const response = await fetch(API_CATEGORIA);
                if (!response.ok) throw new Error('Erro ao buscar categorias');

                const categorias = await response.json();
                const categoriaSelect = document.getElementById('categoria');

                categorias.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.id;
                    option.textContent = cat.nome;
                    categoriaSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Erro ao carregar categorias:', error);
                alert('Erro ao carregar categorias. Verifique se o backend est√° rodando.');
            }
        }

        function toggleTipoLancamento() {
            const tipo = document.getElementById('tipoLancamento').value;
            const secaoCompra = document.getElementById('secaoCompra');
            const secaoArrecadacao = document.getElementById('secaoArrecadacao');

            secaoCompra.style.display = tipo === 'compra' ? 'block' : 'none';
            secaoArrecadacao.style.display = tipo === 'arrecadacao' ? 'block' : 'none';

            // Resetar campos
            if (tipo === 'arrecadacao') {
                document.getElementById('valorUnitario').value = '';
                document.getElementById('valorTotal').value = '';
                document.getElementById('valorPago').value = '';
                document.getElementById('fornecedor').value = '';
            }
        }

        async function carregarProdutos() {
            const categoriaId = document.getElementById('categoria').value;
            const selectProduto = document.getElementById('produto');

            selectProduto.innerHTML = '<option value="">Selecione um produto</option>';

            if (!categoriaId) return;

            try {
                const response = await fetch(`${API_PRODUTO}?categoria_id=${categoriaId}`);
                if (!response.ok) throw new Error('Erro ao buscar produtos');

                const produtos = await response.json();
                produtosCache = {}; // Limpa o cache

                produtos.forEach(prod => {
                    const option = document.createElement('option');
                    option.value = prod.id;
                    option.textContent = prod.nome;
                    selectProduto.appendChild(option);

                    // Armazena no cache para uso posterior
                    produtosCache[prod.id] = prod;
                });
            } catch (error) {
                console.error('Erro ao carregar produtos:', error);
                alert('Erro ao carregar produtos da categoria selecionada.');
            }
        }

        function adicionarProduto() {
            const produto = document.getElementById('produto');
            const quantidade = document.getElementById('quantidade');
            const valorUnitario = document.getElementById('valorUnitario');
            const dataValidade = document.getElementById('dataValidade');
            const dataLancamento = document.getElementById('dataLancamento');

            // Valida√ß√µes
            if (!produto.value || !quantidade.value) {
                alert('Selecione um produto e informe a quantidade');
                return;
            }

            const qtd = parseFloat(quantidade.value);
            if (qtd <= 0) {
                alert('A quantidade deve ser maior que zero');
                return;
            }

            // Validar data de validade se informada
            if (dataValidade.value && dataLancamento.value) {
                if (dataValidade.value < dataLancamento.value) {
                    alert('Data de validade n√£o pode ser anterior √† data da compra');
                    return;
                }
            }

            const produtoId = parseInt(produto.value);
            const produtoTexto = produto.options[produto.selectedIndex].text;
            const valorUnit = parseFloat(valorUnitario.value) || 0;
            const subtotal = valorUnit * qtd;
            const validade = dataValidade.value || null;

            // Verificar se j√° existe produto com mesmo ID e mesma validade
            const produtoExistente = produtosAdicionados.find(p =>
                p.prodId === produtoId && p.dataValidade === validade
            );

            if (produtoExistente) {
                // Somar quantidades ao inv√©s de criar novo item
                produtoExistente.qtde += qtd;
                produtoExistente.subtotal = produtoExistente.valorUnit * produtoExistente.qtde;
                alert(`Produto j√° adicionado. Quantidade atualizada para ${produtoExistente.qtde}`);
            } else {
                // Adicionar novo produto
                produtosAdicionados.push({
                    prodId: produtoId,
                    produto: produtoTexto,
                    qtde: qtd,
                    valorUnit: valorUnit,
                    subtotal: subtotal,
                    dataValidade: validade
                });
            }

            atualizarTabelaProdutos();

            // Limpar campos
            produto.value = '';
            quantidade.value = '';
            valorUnitario.value = '';
            dataValidade.value = '';
        }

        function atualizarTabelaProdutos() {
            const tbody = document.getElementById('tabelaProdutos');
            const lista = document.getElementById('listaProdutos');

            if (produtosAdicionados.length === 0) {
                lista.style.display = 'none';
                return;
            }

            lista.style.display = 'block';

            let totalGeral = 0;

            tbody.innerHTML = produtosAdicionados.map((item, index) => {
                totalGeral += item.subtotal;
                const validadeFormatada = item.dataValidade
                    ? new Date(item.dataValidade + 'T00:00:00').toLocaleDateString('pt-BR')
                    : '-';
                return `
                    <tr>
                        <td>${item.produto}</td>
                        <td>${item.qtde}</td>
                        <td>R$ ${item.valorUnit.toFixed(2)}</td>
                        <td>R$ ${item.subtotal.toFixed(2)}</td>
                        <td>${validadeFormatada}</td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="removerProduto(${index})">
                                üóëÔ∏è Remover
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            document.getElementById('totalGeral').textContent = totalGeral.toFixed(2);
        }

        function removerProduto(index) {
            produtosAdicionados.splice(index, 1);
            atualizarTabelaProdutos();
        }

        // Submiss√£o do formul√°rio
        document.getElementById('formLancamento').addEventListener('submit', async function(e) {
            e.preventDefault();

            const tipoLancamento = document.getElementById('tipoLancamento');
            const dataLancamento = document.getElementById('dataLancamento');

            Validator.clearAllErrors(this);
            let isValid = true;

            if (!tipoLancamento.value) {
                Validator.showError(tipoLancamento, 'Selecione o tipo');
                isValid = false;
            }

            if (!dataLancamento.value) {
                Validator.showError(dataLancamento, 'Informe a data');
                isValid = false;
            } else {
                // Validar se data n√£o √© futura
                const hoje = new Date();
                hoje.setHours(0, 0, 0, 0);
                const dataCompra = new Date(dataLancamento.value + 'T00:00:00');
                if (dataCompra > hoje) {
                    Validator.showError(dataLancamento, 'Data n√£o pode ser futura');
                    isValid = false;
                }
            }

            if (produtosAdicionados.length === 0) {
                alert('Adicione pelo menos um produto');
                isValid = false;
            }

            // Valida√ß√µes espec√≠ficas por tipo
            if (tipoLancamento.value === 'compra') {
                const fornecedor = document.getElementById('fornecedor');
                const valorTotal = document.getElementById('valorTotal');
                const valorPago = document.getElementById('valorPago');

                if (!fornecedor.value) {
                    Validator.showError(fornecedor, 'Fornecedor √© obrigat√≥rio');
                    isValid = false;
                }

                if (!valorTotal.value || parseFloat(valorTotal.value) <= 0) {
                    Validator.showError(valorTotal, 'Valor total √© obrigat√≥rio');
                    isValid = false;
                }

                if (!valorPago.value || parseFloat(valorPago.value) <= 0) {
                    Validator.showError(valorPago, 'Valor pago √© obrigat√≥rio');
                    isValid = false;
                }

                // Validar se valor pago √© diferente do total
                if (valorTotal.value && valorPago.value) {
                    const vTotal = parseFloat(valorTotal.value);
                    const vPago = parseFloat(valorPago.value);
                    if (Math.abs(vTotal - vPago) > 0.01) {
                        const confirmar = confirm(
                            `Aten√ß√£o: Valor pago (R$ ${vPago.toFixed(2)}) √© diferente do valor total (R$ ${vTotal.toFixed(2)}).\n\n` +
                            `Diferen√ßa: R$ ${Math.abs(vTotal - vPago).toFixed(2)}\n\n` +
                            `Deseja continuar mesmo assim?`
                        );
                        if (!confirmar) {
                            isValid = false;
                        }
                    }
                }
            }

            if (!isValid) return;

            try {
                // Monta os par√¢metros para o backend
                const fornecedor = tipoLancamento.value === 'compra' ? document.getElementById('fornecedor').value : '';
                const valorTotal = tipoLancamento.value === 'compra' ? parseFloat(document.getElementById('valorTotal').value) : 0;
                const observacoes = tipoLancamento.value === 'arrecadacao'
                    ? `Arrecada√ß√£o - ${document.getElementById('origemArrecadacao').value}`
                    : document.getElementById('observacoes').value;

                // Prepara os produtos para envio
                // IMPORTANTE: Mesclar produtos com mesmo ID (DB n√£o suporta duplicatas)
                const produtosMesclados = {};
                produtosAdicionados.forEach(p => {
                    if (produtosMesclados[p.prodId]) {
                        // Produto j√° existe, somar quantidade
                        produtosMesclados[p.prodId].qtde += p.qtde;
                        produtosMesclados[p.prodId].subtotal += p.subtotal;
                    } else {
                        // Novo produto
                        produtosMesclados[p.prodId] = {
                            prodId: p.prodId,
                            qtde: p.qtde,
                            valorUnit: p.valorUnit
                        };
                    }
                });

                // Converter objeto para array
                const produtosParaEnvio = Object.values(produtosMesclados);
                const produtosJSON = JSON.stringify(produtosParaEnvio);

                const params = new URLSearchParams();
                params.append('comp_data_compra', dataLancamento.value);
                params.append('comp_desc', observacoes || '');
                params.append('vol_id', '1'); // TODO: Usar ID do volunt√°rio logado
                params.append('com_valor_total', valorTotal);
                params.append('com_fornecedor', fornecedor);
                params.append('produtos', produtosJSON);

                const response = await fetch(`${API_COMPRA}?${params.toString()}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                });

                if (response.ok) {
                    alert('Lan√ßamento registrado com sucesso! Estoque atualizado.');
                    window.location.href = 'visualizar-estoque.html';
                } else {
                    const error = await response.json();
                    throw new Error(error.mensagem || 'Erro ao registrar lan√ßamento');
                }

            } catch (error) {
                console.error('Erro ao registrar lan√ßamento:', error);
                alert('Erro ao registrar lan√ßamento: ' + error.message);
            }
        });
    </script>
</body>
</html>
