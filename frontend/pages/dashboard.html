<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DOARC - Dashboard</title>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        /* Estilos para debug */
        .debug-alert {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: #ff4444;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 10000;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <!-- Sistema de Autentica√ß√£o -->
    <script>
        console.log('üöÄ Dashboard iniciando...');
        
        // Sistema de autentica√ß√£o
        const Auth = {
            isLoggedIn: () => {
                try {
                    const loggedIn = localStorage.getItem('loggedIn') === 'true';
                    const token = localStorage.getItem('token');
                    const loginTime = localStorage.getItem('loginTime');
                    const currentTime = new Date().getTime();

                    console.log('üîç Verificando autentica√ß√£o:', {
                        loggedIn,
                        token: token ? 'EXISTE' : 'N√ÉO EXISTE',
                        loginTime
                    });

                    // Verifica√ß√µes cr√≠ticas
                    if (!loggedIn || !token || token === 'undefined' || token === 'null' || token.trim() === '') {
                        console.log('‚ùå Token inv√°lido ou n√£o existe');
                        return false;
                    }

                    // Verificar expira√ß√£o (24 horas)
                    if (loginTime) {
                        const hoursSinceLogin = (currentTime - parseInt(loginTime)) / (1000 * 60 * 60);
                        console.log(`‚è∞ Horas desde login: ${hoursSinceLogin.toFixed(2)}`);
                        if (hoursSinceLogin > 24) {
                            console.log('‚ùå Login expirado');
                            return false;
                        }
                    }

                    console.log('‚úÖ Autentica√ß√£o v√°lida');
                    return true;
                } catch (error) {
                    console.error('üí• Erro na verifica√ß√£o:', error);
                    return false;
                }
            },

            getUser: () => {
                const user = localStorage.getItem('user');
                return user ? JSON.parse(user) : null;
            },

            logout: () => {
                console.log('üö™ Fazendo logout...');
                localStorage.removeItem('user');
                localStorage.removeItem('token');
                localStorage.removeItem('loggedIn');
                localStorage.removeItem('loginTime');
                window.location.href = '../index.html?logout=true';
            },

            // Verificar e redirecionar se n√£o estiver logado
            checkAndRedirect: () => {
                if (!Auth.isLoggedIn()) {
                    console.log('üîÑ Redirecionando para login...');
                    window.location.href = '../index.html';
                    return false;
                }
                return true;
            }
        };

        // Verifica√ß√£o IMEDIATA ao carregar a p√°gina
        console.log('üõ°Ô∏è Verificando autentica√ß√£o IMEDIATAMENTE...');
        if (!Auth.checkAndRedirect()) {
            // Para completamente a execu√ß√£o se n√£o estiver autenticado
            throw new Error('Usu√°rio n√£o autenticado');
        }

        console.log('‚úÖ Dashboard carregado para usu√°rio autenticado');
    </script>

    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <a href="dashboard.html" class="logo">DOARC</a>
            <div class="user-menu">
                <span class="user-name" id="userName">Volunt√°rio</span>
                <button class="btn-logout" id="logoutBtn">Sair</button>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="nav">
        <ul class="nav-list">
            <li class="nav-item">
                <a href="dashboard.html" class="nav-link active">Dashboard</a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link">Gerenciar</a>
                <ul class="submenu">
                    <li class="submenu-item"><a href="gerenciar-doadores.html" class="submenu-link">Doadores</a></li>
                    <li class="submenu-item"><a href="gerenciar-donatarios.html" class="submenu-link">Donat√°rios</a></li>
                    <li class="submenu-item"><a href="gerenciar-produtos.html" class="submenu-link">Produtos</a></li>
                    <li class="submenu-item"><a href="gerenciar-categorias.html" class="submenu-link">Categorias</a></li>
                    <li class="submenu-item"><a href="gerenciar-voluntarios.html" class="submenu-link">Volunt√°rios</a></li>
                    <li class="submenu-item"><a href="gerenciar-campanhas.html" class="submenu-link">Campanhas</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link">Doa√ß√µes</a>
                <ul class="submenu">
                    <li class="submenu-item"><a href="receber-doacoes.html" class="submenu-link">Receber Doa√ß√µes</a></li>
                    <li class="submenu-item"><a href="efetuar-doacoes.html" class="submenu-link">Efetuar Doa√ß√µes</a></li>
                    <li class="submenu-item"><a href="agendar-doacao.html" class="submenu-link">Agendar Doa√ß√£o</a></li>
                    <li class="submenu-item"><a href="agendar-retirada.html" class="submenu-link">Agendar Retirada</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link">Estoque</a>
                <ul class="submenu">
                    <li class="submenu-item"><a href="visualizar-estoque.html" class="submenu-link">Visualizar Estoque</a></li>
                    <li class="submenu-item"><a href="registrar-acerto.html" class="submenu-link">Acerto de Estoque</a></li>
                    <li class="submenu-item"><a href="lancar-compra.html" class="submenu-link">Lan√ßar Compra/Arrecada√ß√£o</a></li>
                    <li class="submenu-item"><a href="agendar-higienizacao.html" class="submenu-link">Agendar Higieniza√ß√£o</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <a href="relatorios.html" class="nav-link">Relat√≥rios</a>
            </li>
        </ul>
    </nav>

    <!-- Main Content -->
    <main class="container">
        <div class="breadcrumb">
            <div class="breadcrumb-item active">Dashboard</div>
        </div>

        <h1 style="margin-bottom: 2rem; color: var(--primary-color);">Dashboard</h1>

        <!-- Statistics Cards -->
        <div class="dashboard-grid">
            <div class="stat-card" style="background: linear-gradient(135deg, #3498db, #2980b9);">
                <div class="stat-icon">üì¶</div>
                <div class="stat-value" id="totalProdutos">0</div>
                <div class="stat-label">Produtos no Estoque</div>
            </div>

            <div class="stat-card" style="background: linear-gradient(135deg, #2ecc71, #27ae60);">
                <div class="stat-icon">‚¨áÔ∏è</div>
                <div class="stat-value" id="doacoesRecebidas">0</div>
                <div class="stat-label">Doa√ß√µes Recebidas (M√™s)</div>
            </div>

            <div class="stat-card" style="background: linear-gradient(135deg, #e74c3c, #c0392b);">
                <div class="stat-icon">‚¨ÜÔ∏è</div>
                <div class="stat-value" id="doacoesEfetuadas">0</div>
                <div class="stat-label">Doa√ß√µes Efetuadas (M√™s)</div>
            </div>

            <div class="stat-card" style="background: linear-gradient(135deg, #f39c12, #d68910);">
                <div class="stat-icon">ü§ù</div>
                <div class="stat-value" id="voluntariosAtivos">0</div>
                <div class="stat-label">Volunt√°rios Ativos</div>
            </div>

            <div class="stat-card" style="background: linear-gradient(135deg, #9b59b6, #8e44ad);">
                <div class="stat-icon">üìã</div>
                <div class="stat-value" id="campanhasAtivas">0</div>
                <div class="stat-label">Campanhas Ativas</div>
            </div>

            <div class="stat-card" style="background: linear-gradient(135deg, #1abc9c, #16a085);">
                <div class="stat-icon">üë•</div>
                <div class="stat-value" id="donatariosAtivos">0</div>
                <div class="stat-label">Donat√°rios Ativos</div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card mt-4">
            <div class="card-header">
                <h2 class="card-title">A√ß√µes R√°pidas</h2>
            </div>
            <div class="card-body">
                <div class="btn-group">
                    <a href="receber-doacoes.html" class="btn btn-success">
                        ‚¨áÔ∏è Receber Doa√ß√£o
                    </a>
                    <a href="efetuar-doacoes.html" class="btn btn-danger">
                        ‚¨ÜÔ∏è Efetuar Doa√ß√£o
                    </a>
                    <a href="agendar-doacao.html" class="btn btn-info">
                        üìÖ Agendar Doa√ß√£o
                    </a>
                    <a href="visualizar-estoque.html" class="btn btn-primary">
                        üì¶ Ver Estoque
                    </a>
                    <a href="relatorios.html" class="btn btn-warning">
                        üìä Relat√≥rios
                    </a>
                </div>
            </div>
        </div>

        <!-- Recent Activities -->
        <div class="card mt-4">
            <div class="card-header">
                <h2 class="card-title">Atividades Recentes</h2>
            </div>
            <div class="card-body">
                <div class="table-container">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Tipo</th>
                                <th>Descri√ß√£o</th>
                                <th>Volunt√°rio</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="atividadesRecentes">
                            <tr>
                                <td colspan="5" class="text-center" style="padding: 2rem; color: var(--text-light);">
                                    Nenhuma atividade recente
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Pending Schedules -->
        <div class="card mt-4">
            <div class="card-header">
                <h2 class="card-title">Agendamentos Pendentes</h2>
            </div>
            <div class="card-body">
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Data/Hora</th>
                                <th>Tipo</th>
                                <th>Pessoa</th>
                                <th>Respons√°vel</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="agendamentosPendentes">
                            <tr>
                                <td colspan="5" class="text-center" style="padding: 2rem; color: var(--text-light);">
                                    Nenhum agendamento pendente
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Sistema de gerenciamento de usu√°rio
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìÑ DOM carregado - inicializando dashboard...');
            
            // Verificar novamente (segunda camada de seguran√ßa)
            if (!Auth.isLoggedIn()) {
                console.log('‚ùå Segunda verifica√ß√£o falhou - redirecionando...');
                window.location.href = '../index.html';
                return;
            }

            // Carregar dados do usu√°rio
            const user = Auth.getUser();
            if (user && user.nome) {
                document.getElementById('userName').textContent = user.nome;
            }

            // Configurar logout
            document.getElementById('logoutBtn').addEventListener('click', function() {
                if (confirm('Deseja realmente sair?')) {
                    Auth.logout();
                }
            });

            // Carregar dados do dashboard
            loadDashboardData();

            // Verifica√ß√£o peri√≥dica a cada 30 segundos
            setInterval(() => {
                if (!Auth.isLoggedIn()) {
                    alert('Sua sess√£o expirou. Fa√ßa login novamente.');
                    window.location.href = '../index.html';
                }
            }, 30000);
        });

        // Carrega dados do dashboard
        async function loadDashboardData() {
            try {
                console.log('üìä Carregando dados do dashboard...');
                
                // TODO: Integrar com API real
                // const stats = await API.get('/dashboard/stats');

                // Dados simulados para desenvolvimento
                document.getElementById('totalProdutos').textContent = '150';
                document.getElementById('doacoesRecebidas').textContent = '45';
                document.getElementById('doacoesEfetuadas').textContent = '32';
                document.getElementById('voluntariosAtivos').textContent = '12';
                document.getElementById('campanhasAtivas').textContent = '3';
                document.getElementById('donatariosAtivos').textContent = '78';

                // Simula atividades recentes
                const atividades = [
                    {
                        data: '14/10/2025',
                        tipo: 'Doa√ß√£o Recebida',
                        descricao: 'Recebimento de 50kg de alimentos',
                        voluntario: 'Jo√£o Silva',
                        status: 'Conclu√≠do'
                    },
                    {
                        data: '13/10/2025',
                        tipo: 'Doa√ß√£o Efetuada',
                        descricao: 'Distribui√ß√£o de cestas b√°sicas',
                        voluntario: 'Maria Santos',
                        status: 'Conclu√≠do'
                    }
                ];

                const tbody = document.getElementById('atividadesRecentes');
                if (atividades.length > 0) {
                    tbody.innerHTML = atividades.map(ativ => `
                        <tr>
                            <td>${ativ.data}</td>
                            <td>${ativ.tipo}</td>
                            <td>${ativ.descricao}</td>
                            <td>${ativ.voluntario}</td>
                            <td><span class="badge badge-success">${ativ.status}</span></td>
                        </tr>
                    `).join('');
                }

                console.log('‚úÖ Dados do dashboard carregados com sucesso');

            } catch (error) {
                console.error('Erro ao carregar dados do dashboard:', error);
            }
        }
    </script>
</body>
</html>