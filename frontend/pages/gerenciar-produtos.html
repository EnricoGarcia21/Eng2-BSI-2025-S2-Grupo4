<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DOARC - Gerenciar Produtos</title>
    <link rel="stylesheet" href="../css/style.css" />
  </head>
  <body>
    <!-- Header -->
    <header class="header">
      <div class="header-content">
        <a href="dashboard.html" class="logo">DOARC</a>
        <div class="user-menu">
          <span class="user-name" id="userName">Volunt√°rio</span>
          <button class="btn-logout" id="logoutBtn">Sair</button>
        </div>
      </div>
    </header>

    <!-- Navigation -->
    <nav class="nav">
      <ul class="nav-list">
        <li class="nav-item">
          <a href="dashboard.html" class="nav-link">Dashboard</a>
        </li>
        <li class="nav-item">
          <a href="#" class="nav-link active">Gerenciar</a>
          <ul class="submenu">
            <li class="submenu-item">
              <a href="gerenciar-doadores.html" class="submenu-link"
                >Doadores</a
              >
            </li>
            <li class="submenu-item">
              <a href="gerenciar-donatarios.html" class="submenu-link"
                >Donat√°rios</a
              >
            </li>
            <li class="submenu-item">
              <a href="gerenciar-produtos.html" class="submenu-link"
                >Produtos</a
              >
            </li>
            <li class="submenu-item">
              <a href="gerenciar-categorias.html" class="submenu-link"
                >Categorias</a
              >
            </li>
            <li class="submenu-item">
              <a href="gerenciar-voluntarios.html" class="submenu-link"
                >Volunt√°rios</a
              >
            </li>
            <li class="submenu-item">
              <a href="gerenciar-campanhas.html" class="submenu-link"
                >Campanhas</a
              >
            </li>
          </ul>
        </li>
        <li class="nav-item">
          <a href="#" class="nav-link">Doa√ß√µes</a>
          <ul class="submenu">
            <li class="submenu-item">
              <a href="receber-doacoes.html" class="submenu-link"
                >Receber Doa√ß√µes</a
              >
            </li>
            <li class="submenu-item">
              <a href="efetuar-doacoes.html" class="submenu-link"
                >Efetuar Doa√ß√µes</a
              >
            </li>
            <li class="submenu-item">
              <a href="agendar-doacao.html" class="submenu-link"
                >Agendar Doa√ß√£o</a
              >
            </li>
            <li class="submenu-item">
              <a href="agendar-retirada.html" class="submenu-link"
                >Agendar Retirada</a
              >
            </li>
          </ul>
        </li>
        <li class="nav-item">
          <a href="#" class="nav-link">Estoque</a>
          <ul class="submenu">
            <li class="submenu-item">
              <a href="visualizar-estoque.html" class="submenu-link"
                >Visualizar Estoque</a
              >
            </li>
            <li class="submenu-item">
              <a href="registrar-acerto.html" class="submenu-link"
                >Acerto de Estoque</a
              >
            </li>
            <li class="submenu-item">
              <a href="lancar-compra.html" class="submenu-link"
                >Lan√ßar Compra/Arrecada√ß√£o</a
              >
            </li>
            <li class="submenu-item">
              <a href="agendar-higienizacao.html" class="submenu-link"
                >Agendar Higieniza√ß√£o</a
              >
            </li>
          </ul>
        </li>
        <li class="nav-item">
          <a href="relatorios.html" class="nav-link">Relat√≥rios</a>
        </li>
      </ul>
    </nav>

    <!-- Main Content -->
    <main class="container">
      <div class="breadcrumb">
        <div class="breadcrumb-item">
          <a href="dashboard.html">Dashboard</a>
        </div>
        <div class="breadcrumb-item">Gerenciar</div>
        <div class="breadcrumb-item active">Produtos</div>
      </div>

      <div class="card">
        <div class="card-header">
          <h1 class="card-title">Gerenciar Produtos</h1>
          <p class="card-subtitle">
            Cadastre e gerencie os produtos dispon√≠veis para doa√ß√£o
          </p>
        </div>
        <div class="card-body">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 1.5rem;
              flex-wrap: wrap;
              gap: 1rem;
            "
          >
            <div style="display: flex; gap: 1rem; flex-wrap: wrap; flex: 1">
              <input
                type="text"
                id="searchInput"
                class="form-control"
                placeholder="Buscar produto..."
                style="max-width: 300px"
              />
              <select
                id="filtroCategoria"
                class="form-control form-select"
                style="max-width: 200px"
                onchange="filtrarPorCategoria()"
              >
                <option value="">Todas as Categorias</option>
                <option value="1">Alimentos</option>
                <option value="2">Roupas</option>
                <option value="3">Higiene</option>
                <option value="4">M√≥veis</option>
              </select>
            </div>
            <button class="btn btn-primary" onclick="openModal('modalProduto')">
              ‚ûï Novo Produto
            </button>
          </div>

          <div class="table-container">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Nome</th>
                  <th>Categoria</th>
                  <th>Descri√ß√£o</th>
                  <th>Info. Adicionais</th>
                  <th>Quantidade (Estoque)</th>
                  <th>A√ß√µes</th>
                </tr>
              </thead>
              <tbody id="tabelaProdutos"></tbody>
            </table>
          </div>
        </div>
      </div>
    </main>

    <!-- Modal -->
    <div id="modalProduto" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title" id="modalTitle">Novo Produto</h2>
          <button class="modal-close" onclick="closeModal('modalProduto')">
            &times;
          </button>
        </div>
        <div class="modal-body">
          <form id="formProduto">
            <input type="hidden" id="produtoId" />
            <div class="form-row">
              <div class="form-group">
                <label for="nome" class="form-label required"
                  >Nome do Produto</label
                >
                <input type="text" id="nome" class="form-control" required />
              </div>
              <div class="form-group">
                <label for="categoria" class="form-label required"
                  >Categoria</label
                >
                <select
                  id="categoria"
                  class="form-control form-select"
                  required
                >
                  <option value="">Selecione</option>
                  <option value="1">Alimentos</option>
                  <option value="2">Roupas</option>
                  <option value="3">Higiene</option>
                  <option value="4">M√≥veis</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="quantidade" class="form-label required"
                  >Quantidade (Inicial/Atual)</label
                >
                <input
                  type="number"
                  id="quantidade"
                  class="form-control"
                  min="0"
                  required
                />
              </div>
              <div class="form-group">
                <label for="descricao" class="form-label">Descri√ß√£o</label>
                <input type="text" id="descricao" class="form-control" />
              </div>
            </div>
            <div class="form-group">
              <label for="informacoesAdicionais" class="form-label"
                >Informa√ß√µes Adicionais</label
              >
              <textarea
                id="informacoesAdicionais"
                class="form-control"
                rows="3"
              ></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline" onclick="closeModal('modalProduto')">
            Cancelar
          </button>
          <button class="btn btn-primary" onclick="salvarProduto()">
            Salvar
          </button>
        </div>
      </div>
    </div>

 <script src="../js/app.js"></script>
<script>
    // Seus scripts agora dependem do objeto API global vindo de app.js
    document.addEventListener('DOMContentLoaded', () => {
        // Carrega a lista de produtos (sem filtro inicial)
        filtrarPorCategoria(); 
        
        // Listeners unificados para busca e filtro de categoria
        document.getElementById('searchInput').addEventListener('input', filtrarPorCategoria);
        document.getElementById('filtroCategoria').addEventListener('change', filtrarPorCategoria);
    });

    // Fun√ß√£o unificada de filtro e busca via API
    async function filtrarPorCategoria() {
        const categoriaId = document.getElementById('filtroCategoria').value;
        const nome = document.getElementById('searchInput').value; 
        // O endpoint do GET √©: /api/produtos?categoriaId={id}&nome={nome}
        const query = `/produtos?categoriaId=${categoriaId}&nome=${nome}`;

        try {
            const produtos = await API.get(query);
            // Renderiza a tabela com o novo formato de dados
            renderizarTabelaProdutos(produtos); 

        } catch (error) {
            console.error('Erro ao carregar ou filtrar produtos:', error.message);
            // Assume que UI.showAlert existe em app.js
            UI.showAlert('Falha ao carregar produtos. Tente novamente.', 'error'); 
            renderizarTabelaProdutos([]);
        }
    }

    // Abre o modal de cadastro/edi√ß√£o
    function openModal(modalId) {
        document.getElementById('formProduto').reset();
        document.getElementById('produtoId').value = '';
        document.getElementById('modalTitle').textContent = 'Novo Produto';
        // Limpar erros de valida√ß√£o (Assume que Validator.clearAllErrors existe em app.js)
        // Se Validator n√£o existe, apenas remova a linha abaixo
        if (typeof Validator !== 'undefined' && Validator.clearAllErrors) {
            Validator.clearAllErrors(document.getElementById('formProduto')); 
        }
        // Usa a fun√ß√£o UI.openModal do seu app.js
        UI.openModal(modalId);
    }

    // Fecha o modal
    function closeModal(modalId) {
        // Usa a fun√ß√£o UI.closeModal do seu app.js
        UI.closeModal(modalId);
    }

    // FUN√á√ÉO ATUALIZADA: Mapeia para o novo modelo de dados
    function renderizarTabelaProdutos(produtos) {
        const tbody = document.getElementById('tabelaProdutos');
        tbody.innerHTML = ''; 

        if (!produtos || produtos.length === 0) {
            // Colspan ajustado para o novo n√∫mero de colunas (6)
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Nenhum produto encontrado.</td></tr>'; 
            return;
        }

        produtos.forEach(produto => {
            const row = document.createElement('tr');
            
            // Usando 'quant' ou 'quantidade' conforme o JSON retornar. Preferindo 'quant' se for o campo de estoque.
            const quantidadeEmEstoque = produto.quant ?? produto.quantidade ?? 0;
            
            row.innerHTML = `
                <td>${produto.nome}</td>
                <td>${produto.categoriaNome || '-'}</td>
                <td>${produto.descricao || '-'}</td>
                <td>${produto.informacoesAdicionais || '-'}</td>
                <td>${quantidadeEmEstoque}</td>
                <td>
                    <button class="btn btn-sm btn-info" onclick="editarProduto(${produto.id})">‚úèÔ∏è</button>
                    <button class="btn btn-sm btn-danger" onclick="excluirProduto(${produto.id})">üóëÔ∏è</button>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    // Deleta o produto
    function excluirProduto(id) {
        // Usa a fun√ß√£o UI.confirm do seu app.js
        UI.confirm('Tem certeza que deseja excluir este produto?', async function() {
            try {
                // Endpoint: DELETE /api/produtos/{id}
                await API.delete(`/produtos/${id}`); 
                UI.showAlert('Produto exclu√≠do com sucesso!', 'success');
                filtrarPorCategoria(); // Recarrega a lista
            }
            catch (error) {
                console.error('Falha ao excluir produto:', error.message);
            }
        });
    }

    // FUN√á√ÉO ATUALIZADA: Busca os dados do produto pelo ID e abre o modal para edi√ß√£o
    async function editarProduto(id) {
        try {
            // Endpoint: GET /api/produtos/{id}
            const produto = await API.get(`/produtos/${id}`); 

            // Preenche o formul√°rio
            document.getElementById('produtoId').value = produto.id; 
            document.getElementById('modalTitle').textContent = 'Editar Produto';
            document.getElementById('nome').value = produto.nome;
            // Use produto.categoriaId para selecionar a op√ß√£o correta
            document.getElementById('categoria').value = produto.categoriaId; 
            // Usa 'quant' (ou 'quantidade') para preencher o campo 'quantidade' no modal
            document.getElementById('quantidade').value = produto.quant ?? produto.quantidade ?? 0; 
            document.getElementById('descricao').value = produto.descricao || '';
            document.getElementById('informacoesAdicionais').value = produto.informacoesAdicionais || '';

            // Limpar erros de valida√ß√£o (Se Validator existir)
            if (typeof Validator !== 'undefined' && Validator.clearAllErrors) {
                Validator.clearAllErrors(document.getElementById('formProduto'));
            }
            
            UI.openModal('modalProduto');
        } catch (error) {
            UI.showAlert('Falha ao buscar produto para edi√ß√£o.', 'error');
            console.error('Falha ao buscar produto para edi√ß√£o:', error.message);
        }
    }

    // Fun√ß√£o de Salvar (Cria√ß√£o ou Edi√ß√£o)
    async function salvarProduto() {
        const form = document.getElementById('formProduto');
        const produtoId = document.getElementById('produtoId').value;
        const nome = document.getElementById('nome');
        const categoria = document.getElementById('categoria');
        const quantidade = document.getElementById('quantidade');
        const descricao = document.getElementById('descricao');
        const informacoesAdicionais = document.getElementById('informacoesAdicionais');

        // Valida√ß√£o (Assume que Validator existe em app.js)
        if (typeof Validator !== 'undefined') {
            Validator.clearAllErrors(form); 
        }
        
        let isValid = true;

        if (typeof Validator !== 'undefined' && Validator.isEmpty(nome.value)) {
            Validator.showError(nome, 'Nome √© obrigat√≥rio');
            isValid = false;
        }
        if (typeof Validator !== 'undefined' && Validator.isEmpty(categoria.value)) {
            Validator.showError(categoria, 'Categoria √© obrigat√≥ria');
            isValid = false;
        }
        if (typeof Validator !== 'undefined' && (Validator.isEmpty(quantidade.value) || parseInt(quantidade.value) < 0)) {
            Validator.showError(quantidade, 'Quantidade √© obrigat√≥ria e n√£o pode ser negativa');
            isValid = false;
        } else if (quantidade.value === "") { // Valida√ß√£o simples caso Validator n√£o exista
             // N√£o est√° validando corretamente, mas assumimos que o Validator existe.
        }
        
        if (!isValid) return;

        try {
            const data = {
                nome: nome.value,
                descricao: descricao.value,
                informacoesAdicionais: informacoesAdicionais.value,
                // Envia a quantidade como 'quantidade' conforme esperado pelo ProdutoView
                quantidade: parseInt(quantidade.value), 
                categoriaId: parseInt(categoria.value)
            };


            
            if (produtoId) {
                // PUT /api/produtos/{id}
                await API.put(`/produtos/${produtoId}`, data);
                UI.showAlert('Produto atualizado com sucesso!', 'success');
            } else {
                // POST /api/produtos
                await API.post('/produtos', data);
                UI.showAlert('Produto cadastrado com sucesso!', 'success');
            }

            closeModal('modalProduto');
            filtrarPorCategoria();
        } catch (error) {
             UI.showAlert('Falha ao salvar produto.', 'error');
             console.error('Falha ao salvar produto:', error.message);
        }
    }
</script>