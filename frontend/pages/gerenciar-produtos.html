<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DOARC - Gerenciar Produtos</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <a href="dashboard.html" class="logo">DOARC</a>
            <div class="user-menu">
                <span class="user-name" id="userName">Volunt√°rio</span>
                <button class="btn-logout" id="logoutBtn">Sair</button>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="nav">
        <ul class="nav-list">
            <li class="nav-item"><a href="dashboard.html" class="nav-link">Dashboard</a></li>
            <li class="nav-item">
                <a href="#" class="nav-link active">Gerenciar</a>
                <ul class="submenu">
                    <li class="submenu-item"><a href="gerenciar-doadores.html" class="submenu-link">Doadores</a></li>
                    <li class="submenu-item"><a href="gerenciar-donatarios.html" class="submenu-link">Donat√°rios</a></li>
                    <li class="submenu-item"><a href="gerenciar-produtos.html" class="submenu-link">Produtos</a></li>
                    <li class="submenu-item"><a href="gerenciar-categorias.html" class="submenu-link">Categorias</a></li>
                    <li class="submenu-item"><a href="gerenciar-voluntarios.html" class="submenu-link">Volunt√°rios</a></li>
                    <li class="submenu-item"><a href="gerenciar-campanhas.html" class="submenu-link">Campanhas</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link">Doa√ß√µes</a>
                <ul class="submenu">
                    <li class="submenu-item"><a href="receber-doacoes.html" class="submenu-link">Receber Doa√ß√µes</a></li>
                    <li class="submenu-item"><a href="efetuar-doacoes.html" class="submenu-link">Efetuar Doa√ß√µes</a></li>
                    <li class="submenu-item"><a href="agendar-doacao.html" class="submenu-link">Agendar Doa√ß√£o</a></li>
                    <li class="submenu-item"><a href="agendar-retirada.html" class="submenu-link">Agendar Retirada</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link">Estoque</a>
                <ul class="submenu">
                    <li class="submenu-item"><a href="visualizar-estoque.html" class="submenu-link">Visualizar Estoque</a></li>
                    <li class="submenu-item"><a href="registrar-acerto.html" class="submenu-link">Acerto de Estoque</a></li>
                    <li class="submenu-item"><a href="lancar-compra.html" class="submenu-link">Lan√ßar Compra/Arrecada√ß√£o</a></li>
                    <li class="submenu-item"><a href="agendar-higienizacao.html" class="submenu-link">Agendar Higieniza√ß√£o</a></li>
                </ul>
            </li>
            <li class="nav-item"><a href="relatorios.html" class="nav-link">Relat√≥rios</a></li>
        </ul>
    </nav>

    <!-- Main Content -->
    <main class="container">
        <div class="breadcrumb">
            <div class="breadcrumb-item"><a href="dashboard.html">Dashboard</a></div>
            <div class="breadcrumb-item">Gerenciar</div>
            <div class="breadcrumb-item active">Produtos</div>
        </div>

        <div class="card">
            <div class="card-header">
                <h1 class="card-title">Gerenciar Produtos</h1>
                <p class="card-subtitle">Cadastre e gerencie os produtos dispon√≠veis para doa√ß√£o</p>
            </div>
            <div class="card-body">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap; flex: 1;">
                        <input type="text" id="searchInput" class="form-control" placeholder="Buscar produto..." style="max-width: 300px;">
                        <select id="filtroCategoria" class="form-control form-select" style="max-width: 200px;" onchange="filtrarPorCategoria()">
                            <option value="">Todas as Categorias</option>
                            <!-- Categorias carregadas dinamicamente -->
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="openModal('modalProduto')">‚ûï Novo Produto</button>
                </div>

                <div class="table-container">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nome</th>
                                <th>Categoria</th>
                                <th>Descri√ß√£o</th>
                                <th>Quantidade</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaProdutos">
                            <!-- Dados carregados via API -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal -->
    <div id="modalProduto" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Novo Produto</h2>
                <button class="modal-close" onclick="closeModal('modalProduto')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="formProduto">
                    <input type="hidden" id="produtoId">
                    <div class="form-group">
                        <label for="nome" class="form-label required">Nome do Produto</label>
                        <input type="text" id="nome" class="form-control" required>
                        <div class="form-error">Nome √© obrigat√≥rio</div>
                    </div>
                    <div class="form-group">
                        <label for="categoria" class="form-label required">Categoria</label>
                        <select id="categoria" class="form-control form-select" required>
                            <option value="">Selecione uma categoria</option>
                            <!-- Categorias carregadas dinamicamente -->
                        </select>
                        <div class="form-error">Categoria √© obrigat√≥ria</div>
                    </div>
                    <div class="form-group">
                        <label for="descricao" class="form-label">Descri√ß√£o</label>
                        <textarea id="descricao" class="form-control" rows="3" placeholder="Descri√ß√£o do produto (opcional)" maxlength="150"></textarea>
                        <div class="form-error">Descri√ß√£o muito longa (m√°ximo 150 caracteres)</div>
                    </div>
                    <div class="form-group">
                        <label for="informacoesAdicionais" class="form-label">Informa√ß√µes Adicionais</label>
                        <textarea id="informacoesAdicionais" class="form-control" rows="3" placeholder="Informa√ß√µes adicionais (opcional)" maxlength="150"></textarea>
                        <div class="form-error">Informa√ß√µes adicionais muito longas (m√°ximo 150 caracteres)</div>
                    </div>
                    <div class="form-group">
                        <label for="quantidade" class="form-label required">Quantidade</label>
                        <input type="number" id="quantidade" class="form-control" min="0" value="0" required>
                        <div class="form-error">Quantidade √© obrigat√≥ria e n√£o pode ser negativa</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('modalProduto')">Cancelar</button>
                <button class="btn btn-primary" onclick="salvarProduto()">Salvar</button>
            </div>
        </div>
    </div>

    <script src="../js/app.js"></script>
    <script>
        // API Base URL - Backend Spring Boot
        const API_BASE = 'http://localhost:8080/apis/produto';
        const API_CATEGORIA = 'http://localhost:8080/apis/categoria';

        // Carrega produtos e categorias ao iniciar a p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            carregarCategorias();
            carregarProdutos();
        });

        // Busca em tempo real
        document.getElementById('searchInput').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('#tabelaProdutos tr');
            rows.forEach(row => {
                row.style.display = row.textContent.toLowerCase().includes(searchTerm) ? '' : 'none';
            });
        });

        async function carregarCategorias() {
            try {
                const response = await fetch(API_CATEGORIA);
                if (!response.ok) throw new Error('Erro ao buscar categorias');

                const categorias = await response.json();

                // Preenche o select do filtro
                const filtroSelect = document.getElementById('filtroCategoria');
                categorias.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.id;
                    option.textContent = cat.nome;
                    filtroSelect.appendChild(option);
                });

                // Preenche o select do modal
                const categoriaSelect = document.getElementById('categoria');
                categorias.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.id;
                    option.textContent = cat.nome;
                    categoriaSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Erro ao carregar categorias:', error);
            }
        }

        async function carregarProdutos(categoriaId = null) {
            try {
                let url = API_BASE;
                if (categoriaId) {
                    url += `?categoria_id=${categoriaId}`;
                }

                console.log('Carregando produtos de:', url);
                const response = await fetch(url);

                if (!response.ok) {
                    console.error('Status da resposta:', response.status);
                    throw new Error(`Erro HTTP: ${response.status}`);
                }

                const produtos = await response.json();
                console.log('Produtos recebidos:', produtos);

                const tbody = document.getElementById('tabelaProdutos');
                tbody.innerHTML = '';

                if (!produtos || produtos.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Nenhum produto cadastrado</td></tr>';
                    return;
                }

                produtos.forEach(prod => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${prod.id}</td>
                        <td>${prod.nome}</td>
                        <td>${prod.categoria_nome || '-'}</td>
                        <td>${prod.descricao || '-'}</td>
                        <td>${prod.quantidade}</td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="editarProduto(${prod.id})">‚úèÔ∏è</button>
                            <button class="btn btn-sm btn-danger" onclick="excluirProduto(${prod.id})">üóëÔ∏è</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (error) {
                console.error('Erro completo ao carregar:', error);
                alert('Erro ao carregar produtos. Verifique se o backend est√° rodando na porta 8080.');
            }
        }

        function filtrarPorCategoria() {
            const categoriaId = document.getElementById('filtroCategoria').value;
            if (categoriaId) {
                carregarProdutos(categoriaId);
            } else {
                carregarProdutos();
            }
        }

        function openModal(modalId) {
            document.getElementById('formProduto').reset();
            document.getElementById('produtoId').value = '';
            document.getElementById('modalTitle').textContent = 'Novo Produto';
            UI.openModal(modalId);
        }

        function closeModal(modalId) {
            UI.closeModal(modalId);
        }

        async function editarProduto(id) {
            try {
                const response = await fetch(`${API_BASE}/${id}`);

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('Erro na resposta:', errorData);
                    throw new Error(errorData.mensagem || errorData.erro || 'Erro ao buscar produto');
                }

                const produto = await response.json();
                console.log('Produto carregado:', produto);

                if (produto.erro) {
                    throw new Error(produto.erro);
                }

                document.getElementById('produtoId').value = produto.id;
                document.getElementById('modalTitle').textContent = 'Editar Produto';
                document.getElementById('nome').value = produto.nome || '';
                document.getElementById('categoria').value = produto.categoria_id || '';
                document.getElementById('descricao').value = produto.descricao || '';
                document.getElementById('informacoesAdicionais').value = produto.informacoes_adicionais || '';
                document.getElementById('quantidade').value = produto.quantidade || 0;
                UI.openModal('modalProduto');
            } catch (error) {
                console.error('Erro completo:', error);
                alert('Erro ao carregar produto: ' + error.message);
            }
        }

        function excluirProduto(id) {
            if (confirm('Tem certeza que deseja excluir este produto?')) {
                fetch(`${API_BASE}/${id}`, {
                    method: 'DELETE'
                })
                .then(response => {
                    if (response.ok) {
                        alert('Produto exclu√≠do com sucesso!');
                        carregarProdutos();
                    } else {
                        return response.json().then(data => {
                            throw new Error(data.mensagem || 'Erro ao excluir produto');
                        });
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                    alert('Erro ao excluir produto: ' + error.message);
                });
            }
        }

        async function salvarProduto() {
            const form = document.getElementById('formProduto');
            const nome = document.getElementById('nome');
            const categoria = document.getElementById('categoria');
            const descricao = document.getElementById('descricao');
            const informacoesAdicionais = document.getElementById('informacoesAdicionais');
            const quantidade = document.getElementById('quantidade');

            Validator.clearAllErrors(form);

            if (Validator.isEmpty(nome.value)) {
                Validator.showError(nome, 'Nome √© obrigat√≥rio');
                return;
            }

            if (Validator.isEmpty(categoria.value)) {
                Validator.showError(categoria, 'Categoria √© obrigat√≥ria');
                return;
            }

            if (descricao.value && descricao.value.length > 150) {
                Validator.showError(descricao, 'Descri√ß√£o muito longa (m√°ximo 150 caracteres)');
                return;
            }

            if (informacoesAdicionais.value && informacoesAdicionais.value.length > 150) {
                Validator.showError(informacoesAdicionais, 'Informa√ß√µes adicionais muito longas (m√°ximo 150 caracteres)');
                return;
            }

            if (quantidade.value < 0) {
                Validator.showError(quantidade, 'Quantidade n√£o pode ser negativa');
                return;
            }

            try {
                const produtoId = document.getElementById('produtoId').value;

                let url = API_BASE;
                let method = 'POST';
                let params = new URLSearchParams();
                params.append('prod_nome', nome.value);
                params.append('prod_descricao', descricao.value || '');
                params.append('prod_informacoes_adicionais', informacoesAdicionais.value || '');
                params.append('prod_quant', quantidade.value);
                params.append('cat_id', categoria.value);

                if (produtoId) {
                    method = 'PUT';
                    params.append('prod_id', produtoId);
                }

                const response = await fetch(`${url}?${params.toString()}`, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                });

                if (response.ok) {
                    alert(produtoId ? 'Produto atualizado com sucesso!' : 'Produto cadastrado com sucesso!');
                    closeModal('modalProduto');
                    carregarProdutos();
                } else {
                    const error = await response.json();
                    throw new Error(error.mensagem || 'Erro ao salvar produto');
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao salvar produto: ' + error.message);
            }
        }
    </script>
</body>
</html>
