<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DOARC - Gerenciar Volunt√°rios</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <header class="header">
        <div class="header-content">
            <a href="dashboard.html" class="logo">DOARC</a>
            <div class="user-menu">
                <span class="user-name" id="userName">Volunt√°rio</span>
                <button class="btn-logout" id="logoutBtn">Sair</button>
            </div>
        </div>
    </header>

    <nav class="nav">
        <ul class="nav-list">
            <li class="nav-item"><a href="dashboard.html" class="nav-link">Dashboard</a></li>
            <li class="nav-item">
                <a href="#" class="nav-link active">Gerenciar</a>
                <ul class="submenu">
                    <li class="submenu-item"><a href="gerenciar-doadores.html" class="submenu-link">Doadores</a></li>
                    <li class="submenu-item"><a href="gerenciar-donatarios.html" class="submenu-link">Donat√°rios</a></li>
                    <li class="submenu-item"><a href="gerenciar-produtos.html" class="submenu-link">Produtos</a></li>
                    <li class="submenu-item"><a href="gerenciar-categorias.html" class="submenu-link">Categorias</a></li>
                    <li class="submenu-item"><a href="gerenciar-voluntarios.html" class="submenu-link">Volunt√°rios</a></li>
                    <li class="submenu-item"><a href="gerenciar-campanhas.html" class="submenu-link">Campanhas</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link">Doa√ß√µes</a>
                <ul class="submenu">
                    <li class="submenu-item"><a href="receber-doacoes.html" class="submenu-link">Receber Doa√ß√µes</a></li>
                    <li class="submenu-item"><a href="efetuar-doacoes.html" class="submenu-link">Efetuar Doa√ß√µes</a></li>
                    <li class="submenu-item"><a href="agendar-doacao.html" class="submenu-link">Agendar Doa√ß√£o</a></li>
                    <li class="submenu-item"><a href="agendar-retirada.html" class="submenu-link">Agendar Retirada</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link">Estoque</a>
                <ul class="submenu">
                    <li class="submenu-item"><a href="visualizar-estoque.html" class="submenu-link">Visualizar Estoque</a></li>
                    <li class="submenu-item"><a href="registrar-acerto.html" class="submenu-link">Acerto de Estoque</a></li>
                    <li class="submenu-item"><a href="lancar-compra.html" class="submenu-link">Lan√ßar Compra/Arrecada√ß√£o</a></li>
                    <li class="submenu-item"><a href="agendar-higienizacao.html" class="submenu-link">Agendar Higieniza√ß√£o</a></li>
                </ul>
            </li>
            <li class="nav-item"><a href="relatorios.html" class="nav-link">Relat√≥rios</a></li>
        </ul>
    </nav>

    <main class="container">
        <div class="breadcrumb">
            <div class="breadcrumb-item"><a href="dashboard.html">Dashboard</a></div>
            <div class="breadcrumb-item">Gerenciar</div>
            <div class="breadcrumb-item active">Volunt√°rios</div>
        </div>

        <div class="card">
            <div class="card-header">
                <h1 class="card-title">Gerenciar Volunt√°rios</h1>
                <p class="card-subtitle">Cadastre e gerencie os volunt√°rios da organiza√ß√£o</p>
            </div>
            <div class="card-body">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        <input type="text" id="searchInput" class="form-control" placeholder="Buscar volunt√°rio..." style="max-width: 300px;">
                        <select id="filtroStatus" class="form-control form-select" style="max-width: 150px;" onchange="filtrarPorStatus()">
                            <option value="">Todos Status</option>
                            <option value="ativo">Ativo</option>
                            <option value="inativo">Inativo</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="openModal('modalVoluntario')">‚ûï Novo Volunt√°rio</button>
                </div>

                <div class="table-container">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>CPF</th>
                                <th>E-mail</th>
                                <th>Telefone</th>
                                <th>Cidade/UF</th>
                                <th>Doa√ß√µes</th>
                                <th>Status</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaVoluntarios">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <div id="modalVoluntario" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Novo Volunt√°rio</h2>
                <button class="modal-close" onclick="closeModal('modalVoluntario')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="formVoluntario">
                    <input type="hidden" id="voluntarioId">
                    
                    <h4 style="color: var(--primary-color); margin-bottom: 10px; font-size: 1.1rem;">Dados Pessoais</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="nome" class="form-label required">Nome Completo</label>
                            <input type="text" id="nome" class="form-control" required>
                            <div class="form-error">Nome √© obrigat√≥rio</div>
                        </div>
                        <div class="form-group">
                            <label for="cpf" class="form-label required">CPF</label>
                            <input type="text" id="cpf" class="form-control" data-mask="cpf" required>
                            <div class="form-error">CPF inv√°lido</div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="email" class="form-label required">E-mail</label>
                            <input type="email" id="email" class="form-control" required>
                            <div class="form-error">E-mail inv√°lido</div>
                        </div>
                        <div class="form-group">
                            <label for="telefone" class="form-label required">Telefone</label>
                            <input type="tel" id="telefone" class="form-control" data-mask="phone" required>
                            <div class="form-error">Telefone inv√°lido</div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="dataNascimento" class="form-label required">Data de Nascimento</label>
                            <input type="date" id="dataNascimento" class="form-control" required>
                            <div class="form-error">Data √© obrigat√≥ria</div>
                        </div>
                        <div class="form-group">
                            <label for="sexo" class="form-label required">Sexo</label>
                            <select id="sexo" class="form-control form-select" required>
                                <option value="">Selecione</option>
                                <option value="M">Masculino</option>
                                <option value="F">Feminino</option>
                                <option value="O">Outro</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="statusVoluntario" class="form-label required">Status</label>
                            <select id="statusVoluntario" class="form-control form-select" required>
                                <option value="ativo">Ativo</option>
                                <option value="inativo">Inativo</option>
                            </select>
                        </div>
                    </div>

                    <h4 style="color: var(--primary-color); margin: 15px 0 10px; font-size: 1.1rem;">Endere√ßo</h4>
                    <div class="form-row">
                        <div class="form-group" style="flex: 1;">
                            <label for="cep" class="form-label">CEP</label>
                            <input type="text" id="cep" class="form-control" data-mask="cep" onblur="buscarCep(this.value)">
                        </div>
                        <div class="form-group" style="flex: 2;">
                            <label for="endereco" class="form-label">Rua</label>
                            <input type="text" id="endereco" class="form-control">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label for="numero" class="form-label">N√∫mero</label>
                            <input type="text" id="numero" class="form-control">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="bairro" class="form-label">Bairro</label>
                            <input type="text" id="bairro" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="cidade" class="form-label">Cidade</label>
                            <input type="text" id="cidade" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="uf" class="form-label">UF</label>
                            <input type="text" id="uf" class="form-control" maxlength="2" style="text-transform: uppercase;">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="observacoes" class="form-label">Observa√ß√µes</label>
                        <textarea id="observacoes" class="form-control" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('modalVoluntario')">Cancelar</button>
                <button class="btn btn-primary" onclick="salvarVoluntario()">Salvar</button>
            </div>
        </div>
    </div>

    <div id="modalHistorico" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Hist√≥rico de Doa√ß√µes</h2>
                <button class="modal-close" onclick="closeModal('modalHistorico')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Tipo</th>
                                <th>Descri√ß√£o</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaHistorico">
                            <tr><td colspan="4" class="text-center">Carregando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('modalHistorico')">Fechar</button>
            </div>
        </div>
    </div>

    <script src="../js/app.js"></script>
<<<<<<< HEAD
    <script>
        // =======================================================================
        // Gerenciamento de Volunt√°rios - DOARC
        // =======================================================================

        const API_BASE = "http://localhost:8080/apis";
        const API_ADMIN = `${API_BASE}/admin`; 
        const API_CRIAR_VOLUNTARIO = `${API_BASE}/voluntario`; 

        let voluntarioEmEdicao = null;

        // Headers com Token JWT
        const getHeaders = () => {
            const headers = new Headers();
            headers.append("Content-Type", "application/json");
            const token = localStorage.getItem('token') || localStorage.getItem('jwtToken');
            if (token) {
                headers.append("Authorization", `Bearer ${token}`);
            } else {
                UI.showAlert('Sess√£o expirada. Fa√ßa login novamente.', 'danger');
            }
            return headers;
        };

        // --- Formatadores ---
        function formatarCPF(v){if(!v)return'';return String(v).replace(/(\d{3})(\d{3})(\d{3})(\d{2})/,'$1.$2.$3-$4');}
        function formatarTelefone(v){if(!v)return'';v=String(v).replace(/\D/g,'');if(v.length===11)return v.replace(/(\d{2})(\d{5})(\d{4})/,'($1) $2-$3');if(v.length===10)return v.replace(/(\d{2})(\d{4})(\d{4})/,'($1) $2-$3');return v;}
        function formatarData(v){if(!v)return'';if(v.includes('-')){const p=v.split('-');if(p.length===3)return`${p[2]}/${p[1]}/${p[0]}`;}return new Date(v).toLocaleDateString('pt-BR');}

        // --- Busca e Filtros ---
        function aplicarFiltros() {
            const termoBusca = document.getElementById('searchInput').value.toLowerCase();
            const statusFiltro = document.getElementById('filtroStatus').value.toLowerCase(); // '' (todos), 'ativo', 'inativo'
            
            const rows = document.querySelectorAll('#tabelaVoluntarios tr');

            rows.forEach(row => {
                // 1. Verifica Busca
                const textoLinha = row.textContent.toLowerCase();
                const correspondeBusca = textoLinha.includes(termoBusca);
                
                // 2. Verifica Status
                let correspondeStatus = true;
                if (statusFiltro) {
                    const badge = row.querySelector('.badge');
                    if (badge) {
                        const textoBadge = badge.textContent.trim().toLowerCase();
                        if (statusFiltro === 'ativo') {
                            correspondeStatus = (textoBadge === 'ativo');
                        } else {
                            correspondeStatus = (textoBadge !== 'ativo');
                        }
                    } else {
                        correspondeStatus = false;
                    }
                }

                row.style.display = (correspondeBusca && correspondeStatus) ? '' : 'none';
            });
        }

        function filtrarPorStatus() {
            aplicarFiltros();
        }

        // --- API CEP ---
        async function buscarCep(cep) {
            cep = cep.replace(/\D/g, '');
            if (cep.length !== 8) return;

            try {
                const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                const data = await response.json();
                if (!data.erro) {
                    document.getElementById('endereco').value = data.logradouro;
                    document.getElementById('bairro').value = data.bairro;
                    document.getElementById('cidade').value = data.localidade;
                    document.getElementById('uf').value = data.uf;
                    document.getElementById('numero').focus();
                }
            } catch (e) {
                console.error("Erro ao buscar CEP", e);
            }
        }

        // 1. CARREGAR LISTA
        async function carregarVoluntarios() {
            try {
                const response = await fetch(`${API_ADMIN}/voluntarios`, { headers: getHeaders() });
                if (!response.ok) throw new Error('Erro ao buscar lista de volunt√°rios');
                const lista = await response.json();
                preencherTabela(lista);
            } catch (error) {
                console.error(error);
                document.getElementById('tabelaVoluntarios').innerHTML = '<tr><td colspan="8" class="text-center text-danger">Erro ao carregar dados. Verifique o servidor.</td></tr>';
            }
        }

        function preencherTabela(lista) {
            const tbody = document.getElementById('tabelaVoluntarios');
            tbody.innerHTML = '';
            
            if (!lista || lista.length === 0) { 
                tbody.innerHTML = '<tr><td colspan="8" class="text-center">Nenhum volunt√°rio encontrado.</td></tr>'; 
                return; 
            }

            lista.forEach(vol => {
                const id = vol.vol_id || vol.id;
                const nome = vol.vol_nome || vol.nome || '';
                const cpf = vol.vol_cpf || vol.cpf || '';
                const email = vol.vol_email || vol.email || '';
                const telefone = vol.vol_telefone || vol.telefone || '';
                // Formata a data ou mostra tra√ßo
                const dataCadastro = vol.vol_datacadastro ? formatarData(vol.vol_datacadastro) : '-'; 
                const doacoes = vol.doacoes_realizadas || 0;
                const cidade = vol.vol_cidade || '';
                const uf = vol.vol_uf || '';

                // L√≥gica de Status
                const temLogin = (vol.status !== undefined && vol.status !== "N/A" && vol.status !== null);
                const isAtivo = (vol.status === 'A' || vol.status === 'Ativo');
                
                let badgeClass = 'secondary';
                let badgeText = 'Sem Acesso';
                
                if (temLogin) {
                    badgeClass = isAtivo ? 'success' : 'danger';
                    badgeText = isAtivo ? 'Ativo' : 'Inativo';
                }

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${nome}</td>
                    <td>${formatarCPF(cpf)}</td>
                    <td>${email}</td>
                    <td>${formatarTelefone(telefone)}</td>
                    <td>${cidade}/${uf}</td>
                    <td>${doacoes}</td>
                    <td><span class="badge badge-${badgeClass}">${badgeText}</span></td>
                    <td>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-info" onclick="editarVoluntario(${id})" title="Editar">‚úèÔ∏è</button>
                            <button class="btn btn-sm btn-warning" onclick="verHistorico(${id})" title="Hist√≥rico">üìã</button>
                            <button class="btn btn-sm btn-${isAtivo ? 'danger' : 'success'}" 
                                    onclick="toggleStatus(${id}, '${isAtivo ? 'ativo' : 'inativo'}', ${temLogin})" 
                                    title="${temLogin ? (isAtivo ? 'Desativar Acesso' : 'Ativar Acesso') : 'Usu√°rio sem login'}"
                                    ${!temLogin ? 'disabled style="opacity:0.6; cursor:not-allowed;"' : ''}>
                                ${isAtivo ? 'üîí' : 'üîì'}
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="excluirVoluntario(${id})" title="Excluir">üóëÔ∏è</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            aplicarFiltros();
        }

        // 2. PREPARAR EDI√á√ÉO
        async function editarVoluntario(id) {
            try {
                const response = await fetch(`${API_ADMIN}/voluntarios/${id}`, { headers: getHeaders() });
                if (!response.ok) throw new Error('Erro ao buscar volunt√°rio');
                
                const vol = await response.json();
                voluntarioEmEdicao = vol;

                Validator.clearAllErrors(document.getElementById('formVoluntario'));
                document.getElementById('voluntarioId').value = id;
                document.getElementById('modalTitle').textContent = 'Editar Volunt√°rio';
                
                // Preencher Campos
                document.getElementById('nome').value = vol.vol_nome || '';
                document.getElementById('cpf').value = vol.vol_cpf || ''; 
                document.getElementById('email').value = vol.vol_email || '';
                document.getElementById('telefone').value = vol.vol_telefone || '';
                document.getElementById('sexo').value = vol.vol_sexo || 'O'; // Novo campo
                
                if (vol.vol_datanasc) {
                    document.getElementById('dataNascimento').value = vol.vol_datanasc.split('T')[0];
                } else {
                    document.getElementById('dataNascimento').value = '';
                }

                // Endere√ßo completo
                document.getElementById('cep').value = vol.vol_cep || '';
                document.getElementById('endereco').value = vol.vol_rua || ''; // mapeia para von_rua
                document.getElementById('numero').value = vol.vol_numero || '';
                document.getElementById('bairro').value = vol.vol_bairro || '';
                document.getElementById('cidade').value = vol.vol_cidade || '';
                document.getElementById('uf').value = vol.vol_uf || '';

                const isAtivo = (vol.status === 'A' || vol.status === 'Ativo');
                const selectStatus = document.getElementById('statusVoluntario');
                selectStatus.value = isAtivo ? 'ativo' : 'inativo';
                
                const temLogin = (vol.status !== undefined && vol.status !== "N/A");
                selectStatus.disabled = !temLogin;

                UI.openModal('modalVoluntario');
            } catch (error) {
                console.error(error);
                UI.showAlert('Erro ao carregar edi√ß√£o.', 'danger');
            }
        }

        // 3. EXCLUIR VOLUNT√ÅRIO
        async function excluirVoluntario(id) {
            UI.confirm('‚ö†Ô∏è Tem certeza? Isso excluir√° o volunt√°rio e seu acesso permanentemente.', async () => {
                try {
                    const response = await fetch(`${API_ADMIN}/voluntarios/${id}`, { 
                        method: 'DELETE',
                        headers: getHeaders() 
                    });

                    if (!response.ok) {
                        const err = await response.json().catch(() => ({}));
                        throw new Error(err.erro || 'Erro ao excluir');
                    }

                    UI.showAlert('Volunt√°rio removido com sucesso!', 'success');
                    carregarVoluntarios();
                } catch (e) {
                    console.error(e);
                    UI.showAlert('Erro ao excluir: ' + e.message, 'danger');
                }
            });
        }

        // 4. SALVAR (Com novos campos)
        async function salvarVoluntario() {
            const id = document.getElementById('voluntarioId').value;
            const form = document.getElementById('formVoluntario');
            
            // Coletar Dados
            const nome = document.getElementById('nome').value;
            const cpf = document.getElementById('cpf').value;
            const email = document.getElementById('email').value;
            const telefone = document.getElementById('telefone').value;
            const dataNasc = document.getElementById('dataNascimento').value;
            const sexo = document.getElementById('sexo').value;
            
            // Endere√ßo
            const cep = document.getElementById('cep').value;
            const rua = document.getElementById('endereco').value;
            const numero = document.getElementById('numero').value;
            const bairro = document.getElementById('bairro').value;
            const cidade = document.getElementById('cidade').value;
            const uf = document.getElementById('uf').value;

            Validator.clearAllErrors(form);
            let isValid = true;

            if(Validator.isEmpty(nome)) { Validator.showError(document.getElementById('nome'), 'Obrigat√≥rio'); isValid=false; }
            if(Validator.isEmpty(email)) { Validator.showError(document.getElementById('email'), 'Obrigat√≥rio'); isValid=false; }
            if(Validator.isEmpty(cpf)) { Validator.showError(document.getElementById('cpf'), 'Obrigat√≥rio'); isValid=false; }
            
            if (dataNasc) {
                const d = new Date(dataNasc);
                const hoje = new Date();
                let idade = hoje.getFullYear() - d.getFullYear();
                if (hoje < new Date(hoje.getFullYear(), d.getMonth(), d.getDate())) idade--;
                if (idade < 18) {
                    Validator.showError(document.getElementById('dataNascimento'), 'M√≠nimo 18 anos.');
                    isValid = false;
                }
            } else {
                Validator.showError(document.getElementById('dataNascimento'), 'Obrigat√≥rio');
                isValid = false;
            }

            if (!isValid) { UI.showAlert('Verifique os erros.', 'danger'); return; }

            const payload = {
                vol_id: id ? parseInt(id) : 0,
                vol_nome: nome,
                vol_cpf: cpf.replace(/\D/g,''), // Limpa formata√ß√£o
                vol_email: email,
                vol_telefone: telefone.replace(/\D/g,''),
                vol_datanasc: dataNasc,
                vol_sexo: sexo,
                // Endere√ßo completo
                vol_cep: cep.replace(/\D/g,''),
                vol_rua: rua,
                vol_numero: numero,
                vol_bairro: bairro,
                vol_cidade: cidade,
                vol_uf: uf
            };

            try {
                let url, method;
                if (id) {
                    url = `${API_ADMIN}/voluntarios/${id}`;
                    method = 'PUT';
                } else {
                    url = API_CRIAR_VOLUNTARIO;
                    method = 'POST';
                }

                const res = await fetch(url, {
                    method: method,
                    headers: getHeaders(),
                    body: JSON.stringify(payload)
                });

                const json = await res.json();

                if (!res.ok) throw new Error(json.erro || 'Erro ao salvar');

                UI.showAlert(json.message || 'Salvo com sucesso!', 'success');
                UI.closeModal('modalVoluntario');
                carregarVoluntarios();

            } catch (e) {
                console.error(e);
                UI.showAlert('Erro: ' + e.message, 'danger');
            }
        }

        // 5. TOGGLE STATUS
        async function toggleStatus(id, statusAtual, temLogin) {
            if (!temLogin) {
                UI.showAlert('Este volunt√°rio n√£o possui Login.', 'warning');
                return;
            }

            const isAtivo = (statusAtual === 'ativo');
            const novoStatusChar = isAtivo ? 'I' : 'A';
            const acao = isAtivo ? 'desativar' : 'ativar';
            
            UI.confirm(`Deseja realmente ${acao} o acesso deste usu√°rio?`, async () => {
                try {
                    const res = await fetch(`${API_ADMIN}/logins/${id}/status`, {
                        method: 'PUT',
                        headers: getHeaders(),
                        body: JSON.stringify({ status: novoStatusChar })
                    });

                    if (!res.ok) {
                        const err = await res.json();
                        throw new Error(err.erro || 'Erro ao alterar status');
                    }

                    UI.showAlert('Status alterado com sucesso!', 'success');
                    carregarVoluntarios();
                } catch (e) {
                    UI.showAlert(e.message, 'danger');
                }
            });
        }

        // 6. HIST√ìRICO
        function verHistorico(id) {
            UI.showAlert('Funcionalidade de hist√≥rico em desenvolvimento.', 'warning');
            UI.openModal('modalHistorico');
        }

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', () => {
            // üîí PROTE√á√ÉO: Apenas Admin pode acessar esta p√°gina
            if (!Auth.guardAdminRoute()) {
                return; 
            }
            
            // Nome do usu√°rio no header
            const user = Auth.getUser();
            if(user) document.getElementById('userName').textContent = user.nome || "Volunt√°rio";

            carregarVoluntarios();
            
            // Event listener para a barra de pesquisa
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', aplicarFiltros);
            }
            
            const btnLogout = document.getElementById('logoutBtn');
            if(btnLogout) btnLogout.addEventListener('click', (e) => {
                e.preventDefault();
                if (confirm('Deseja realmente sair?')) Auth.logout();
            });
        });

        function openModal(id) { 
            if(id==='modalVoluntario') {
                document.getElementById('formVoluntario').reset();
                document.getElementById('voluntarioId').value = '';
                document.getElementById('modalTitle').textContent='Novo Volunt√°rio';
                voluntarioEmEdicao = null; 
                document.getElementById('statusVoluntario').disabled = true; 
            }
            UI.openModal(id); 
        }
        function closeModal(id) { UI.closeModal(id); }
    </script>
=======
<script>
// =======================================================================
// POLYFILLS/MOCKS para UI e Validator (Garantir que as fun√ß√µes chamadas existam)
// O seu arquivo '../js/app.js' deve conter implementa√ß√µes mais robustas.
// =======================================================================
const UI = window.UI || {
    showAlert: (message, type) => {
        const container = document.getElementById('api-messages');
        container.innerHTML = `<div class="alert ${type} fade show">${message}</div>`;
        setTimeout(() => container.innerHTML = '', 5000);
    },
    confirm: (message, callback) => {
        if (confirm(message)) {
            callback();
        }
    },
    openModal: (modalId) => {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = 'block';
            modal.classList.add('open');
        }
    },
    closeModal: (modalId) => {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = 'none';
            modal.classList.remove('open');
            // Limpa erros do modalVoluntario ao fechar
            if (modalId === 'modalVoluntario') {
                const form = document.getElementById('formVoluntario');
                if (form && window.Validator) Validator.clearAllErrors(form);
            }
        }
    }
};

const Validator = window.Validator || {
    isEmpty: value => !value || String(value).trim() === '',
    isValidEmail: email => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email),
    isValidCPF: cpf => /^\d{3}\.?\d{3}\.?\d{3}-?\d{2}$/.test(cpf) && cpf.replace(/[^\d]/g, '').length === 11,
    isValidPhone: phone => /[0-9]{2}[\s]?[9]?[0-9]{4}-?[0-9]{4}/.test(phone.replace(/[^\d]/g, '')),
    showError: (inputElement, message) => {
        inputElement.classList.add('error');
        const errorDiv = inputElement.nextElementSibling;
        if (errorDiv && errorDiv.classList.contains('form-error')) {
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }
    },
    clearError: (inputElement) => {
        inputElement.classList.remove('error');
        const errorDiv = inputElement.nextElementSibling;
        if (errorDiv && errorDiv.classList.contains('form-error')) {
            errorDiv.textContent = '';
            errorDiv.style.display = 'none';
        }
    },
    clearAllErrors: (formElement) => {
        formElement.querySelectorAll('.form-control.error').forEach(input => Validator.clearError(input));
    }
};
// =======================================================================


// Configura√ß√£o base da API
const API_BASE = "http://localhost:8080/apis";
const API_VOLUNTARIOS = `${API_BASE}/voluntario`;

/**
 * Headers padr√£o com autentica√ß√£o JWT.
 * Redireciona para login se o token n√£o existir.
 */
const getHeaders = () => {
    const headers = new Headers();
    headers.append("Content-Type", "application/json");
    
    // üîë JWT AUTHENTICATION
    const token = localStorage.getItem('jwtToken');
    if (token) {
        headers.append("Authorization", `Bearer ${token}`);
    } else {
        // Se n√£o houver token, for√ßa o logout e redireciona
        UI.showAlert('Sess√£o expirada. Fa√ßa login novamente.', 'danger');
        window.location.href = '../index.html'; 
    }
    return headers;
};

// Fun√ß√µes de formata√ß√£o
function formatarCPF(cpf) {
    if (!cpf) return '';
    return String(cpf).replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
}

function formatarTelefone(telefone) {
    if (!telefone) return '';
    // Formata para (XX) XXXXX-XXXX
    const digits = String(telefone).replace(/[^\d]/g, '');
    if (digits.length === 11) {
        return digits.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
    }
    // Formata para (XX) XXXX-XXXX (fixo)
    if (digits.length === 10) {
        return digits.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
    }
    return telefone;
}

function formatarData(data) {
    if (!data) return '';
    // Converte de YYYY-MM-DD para DD/MM/YYYY
    if (data.includes('-')) {
        const parts = data.split('-');
        // Tenta reverter de YYYY-MM-DD para o formato BR
        if (parts.length === 3) {
            return `${parts[2]}/${parts[1]}/${parts[0]}`;
        }
    }
    // Se for uma string de data completa (ISO), usa toLocaleDateString
    return new Date(data).toLocaleDateString('pt-BR');
}

// Fun√ß√£o para carregar volunt√°rios da API
async function carregarVoluntarios() {
    try {
        const response = await fetch(API_VOLUNTARIOS, { headers: getHeaders() });
        
        if (!response.ok) {
             // Tenta extrair a mensagem de erro do backend (ex: Acesso negado)
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.erro || `Erro de rede: ${response.status}`);
        }
        
        const voluntarios = await response.json();
        preencherTabela(voluntarios);
    } catch (error) {
        console.error('Erro ao carregar volunt√°rios:', error);
        UI.showAlert('‚ùå Erro ao carregar volunt√°rios. ' + (error.message || ''), 'danger');
        const tbody = document.getElementById('tabelaVoluntarios');
        tbody.innerHTML = '<tr><td colspan="8" class="text-center">N√£o foi poss√≠vel carregar os dados.</td></tr>';
    }
}

// Fun√ß√£o para preencher a tabela com dados da API
function preencherTabela(voluntarios) {
    const tbody = document.getElementById('tabelaVoluntarios');
    tbody.innerHTML = '';

    if (voluntarios.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center">Nenhum volunt√°rio encontrado.</td></tr>';
        return;
    }

    voluntarios.forEach(vol => {
        // Normaliza as chaves do objeto (supondo que a API retorne vol_id, vol_nome, etc.)
        const id = vol.vol_id || vol.id;
        const nome = vol.vol_nome || vol.nome || '';
        const cpf = vol.vol_cpf || vol.cpf || '';
        const email = vol.vol_email || vol.email || '';
        const telefone = vol.vol_telefone || vol.telefone || '';
        // Converte a data de 'YYYY-MM-DD' (ou similar) para 'DD/MM/YYYY'
        const dataCadastro = formatarData(vol.vol_datacadastro || vol.dataCadastro || '');
        const doacoesRealizadas = vol.doacoes_realizadas || vol.doacoesRealizadas || 0;
        const status = (vol.status || 'ativo').toLowerCase();

        const statusClass = status === 'ativo' ? 'success' : 'danger';
        const statusText = status === 'ativo' ? 'Ativo' : 'Inativo';
        const acaoIcone = status === 'ativo' ? 'üîí' : 'üîì';
        const acaoClass = status === 'ativo' ? 'danger' : 'success';

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${nome}</td>
            <td>${formatarCPF(cpf)}</td>
            <td>${email}</td>
            <td>${formatarTelefone(telefone)}</td>
            <td>${dataCadastro}</td>
            <td>${doacoesRealizadas}</td>
            <td><span class="badge badge-${statusClass}">${statusText}</span></td>
            <td>
                <button class="btn btn-sm btn-info" onclick="editarVoluntario(${id})">‚úèÔ∏è</button>
                <button class="btn btn-sm btn-warning" onclick="verHistorico(${id})">üìã</button>
                <button class="btn btn-sm btn-${acaoClass}" onclick="toggleStatus(${id}, '${status}')">
                    ${acaoIcone}
                </button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

// Fun√ß√£o para buscar volunt√°rio por ID
async function buscarVoluntarioPorId(id) {
    try {
        const response = await fetch(`${API_VOLUNTARIOS}/${id}`, { headers: getHeaders() });
        if (!response.ok) throw new Error('Volunt√°rio n√£o encontrado');
        return await response.json();
    } catch (error) {
        console.error('Erro:', error);
        UI.showAlert('Erro ao carregar dados do volunt√°rio', 'danger');
        return null;
    }
}

// Fun√ß√£o para salvar volunt√°rio (criar ou atualizar)
async function salvarVoluntario() {
    const form = document.getElementById('formVoluntario');
    const nome = document.getElementById('nome');
    const cpf = document.getElementById('cpf');
    const email = document.getElementById('email');
    const telefone = document.getElementById('telefone');
    const dataNascimento = document.getElementById('dataNascimento');
    const endereco = document.getElementById('endereco'); // Usado como placeholder para vol_rua
    const statusVoluntario = document.getElementById('statusVoluntario');

    Validator.clearAllErrors(form);
    let isValid = true;

    // Valida√ß√µes
    if (Validator.isEmpty(nome.value)) { Validator.showError(nome, 'Nome √© obrigat√≥rio'); isValid = false; }
    // A valida√ß√£o de CPF deve ser feita no formato puro (somente d√≠gitos)
    const cpfPuro = cpf.value.replace(/[^\d]/g, '');
    if (Validator.isEmpty(cpfPuro) || !Validator.isValidCPF(cpfPuro)) { Validator.showError(cpf, 'CPF inv√°lido'); isValid = false; }
    if (Validator.isEmpty(email.value) || !Validator.isValidEmail(email.value)) { Validator.showError(email, 'E-mail inv√°lido'); isValid = false; }
    // A valida√ß√£o de telefone deve ser feita no formato puro (somente d√≠gitos)
    const telefonePuro = telefone.value.replace(/[^\d]/g, '');
    if (Validator.isEmpty(telefonePuro) || !Validator.isValidPhone(telefonePuro)) { Validator.showError(telefone, 'Telefone inv√°lido'); isValid = false; }
    if (Validator.isEmpty(dataNascimento.value)) { Validator.showError(dataNascimento, 'Data √© obrigat√≥ria'); isValid = false; }

    if (!isValid) {
        UI.showAlert('Corrija os erros do formul√°rio.', 'danger');
        return;
    }

    try {
        const voluntarioId = document.getElementById('voluntarioId').value;
        
        // üõ†Ô∏è Mapeamento para o formato da API (utilizando as informa√ß√µes do form)
        // Valores default/hardcoded s√£o usados para campos n√£o presentes no modal
        const data = {
            vol_nome: nome.value,
            vol_cpf: cpfPuro,
            vol_email: email.value,
            vol_telefone: telefonePuro,
            vol_datanasc: dataNascimento.value,
            vol_rua: endereco.value || '', // Assumindo 'endereco' √© 'vol_rua'
            vol_bairro: "N√£o Informado", // Hardcoded
            vol_numero: "S/N", ¬† // Hardcoded
            vol_cidade: "N√£o Informado", // Hardcoded
            vol_cep: "00000000", // Hardcoded
            vol_uf: "ND", // Hardcoded
            vol_sexo: "N", // Hardcoded (Pode ser adicionado um campo 'Sexo' ao form)
            status: statusVoluntario.value // Adicionando status no payload
        };

        const requestOptions = {
            method: voluntarioId ? "PUT" : "POST",
            headers: getHeaders(),
            body: JSON.stringify(data)
        };

        const url = voluntarioId ? `${API_VOLUNTARIOS}/${voluntarioId}` : API_VOLUNTARIOS;

        const response = await fetch(url, requestOptions);
        
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.erro || `Erro de rede: ${response.status}`);
        }

        UI.showAlert(voluntarioId ? '‚úÖ Volunt√°rio atualizado!' : '‚úÖ Volunt√°rio cadastrado!', 'success');
        closeModal('modalVoluntario');
        carregarVoluntarios(); // Recarrega a lista
    } catch (error) {
        console.error('Erro:', error);
        UI.showAlert('‚ùå Erro ao salvar volunt√°rio: ' + (error.message || ''), 'danger');
    }
}

// Fun√ß√£o para editar volunt√°rio
async function editarVoluntario(id) {
    try {
        const voluntario = await buscarVoluntarioPorId(id);
        if (!voluntario) return;

        // Limpa erros antes de popular
        Validator.clearAllErrors(document.getElementById('formVoluntario'));

        document.getElementById('voluntarioId').value = id;
        document.getElementById('modalTitle').textContent = 'Editar Volunt√°rio';
        // Mapeamento das chaves da API para os campos do formul√°rio
        document.getElementById('nome').value = voluntario.vol_nome || voluntario.nome || '';
        document.getElementById('cpf').value = voluntario.vol_cpf || voluntario.cpf || '';
        document.getElementById('email').value = voluntario.vol_email || voluntario.email || '';
        document.getElementById('telefone').value = voluntario.vol_telefone || voluntario.telefone || '';
        document.getElementById('dataNascimento').value = (voluntario.vol_datanasc || voluntario.dataNascimento || '').split('T')[0]; // Pega apenas a data
        document.getElementById('endereco').value = voluntario.vol_rua || voluntario.endereco || ''; // Assumindo 'vol_rua'
        document.getElementById('statusVoluntario').value = (voluntario.status || 'ativo').toLowerCase();
        document.getElementById('observacoes').value = voluntario.observacoes || ''; // Se tiver campo de observacoes

        UI.openModal('modalVoluntario');
    } catch (error) {
        console.error('Erro:', error);
        UI.showAlert('‚ùå Erro ao carregar dados do volunt√°rio para edi√ß√£o', 'danger');
    }
}

// Fun√ß√£o para alternar status
async function toggleStatus(id, statusAtual) {
    const novoStatus = statusAtual === 'ativo' ? 'inativo' : 'ativo';
    const acao = novoStatus === 'ativo' ? 'ativar' : 'inativar';
    
    UI.confirm(`Deseja realmente ${acao} este volunt√°rio?`, async function() {
        try {
            const data = { status: novoStatus };
            
            const requestOptions = {
                method: "PUT",
                headers: getHeaders(),
                body: JSON.stringify(data)
            };
            // Endpoint de altera√ß√£o de status (PATCH √© mais semanticamente correto, mas PUT com corpo simplificado tamb√©m √© comum)
            const response = await fetch(`${API_VOLUNTARIOS}/${id}/status`, requestOptions);
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.erro || `Erro de rede: ${response.status}`);
            }

            UI.showAlert(`‚úÖ Status do volunt√°rio alterado para ${acao} com sucesso!`, 'success');
            carregarVoluntarios(); // Recarrega a lista
        } catch (error) {
            console.error('Erro:', error);
            UI.showAlert('‚ùå Erro ao alterar status: ' + (error.message || ''), 'danger');
        }
    });
}

// Fun√ß√£o para ver hist√≥rico (adaptar conforme sua API)
async function verHistorico(id) {
    try {
        const response = await fetch(`${API_VOLUNTARIOS}/${id}/historico`, { headers: getHeaders() });
        
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.erro || `Erro ao buscar hist√≥rico: ${response.status}`);
        }

        const historico = await response.json();
        const tbody = document.getElementById('tabelaHistorico');
        
        tbody.innerHTML = historico.length > 0 
            ? historico.map(item => {
                const statusClass = item.status === 'concluido' ? 'success' : 'warning';
                return `
                    <tr>
                        <td>${formatarData(item.data)}</td>
                        <td>${item.tipo}</td>
                        <td>${item.descricao}</td>
                        <td><span class="badge badge-${statusClass}">${item.status}</span></td>
                    </tr>
                `;
            }).join('')
            : '<tr><td colspan="4" class="text-center">Nenhum hist√≥rico de doa√ß√£o encontrado.</td></tr>';
            
        UI.openModal('modalHistorico');
    } catch (error) {
        console.error('Erro:', error);
        document.getElementById('tabelaHistorico').innerHTML = '<tr><td colspan="4" class="text-center">Erro ao carregar hist√≥rico</td></tr>';
        UI.showAlert('‚ùå ' + (error.message || 'Erro ao buscar hist√≥rico.'), 'danger');
        UI.openModal('modalHistorico'); // Abre o modal mesmo com erro para exibir a mensagem interna
    }
}


// ============== EVENT LISTENERS E INICIALIZA√á√ÉO ==============

document.addEventListener('DOMContentLoaded', function() {
    // 1. Carregar Volunt√°rios ao iniciar
    carregarVoluntarios();
    
    // 2. L√≥gica de Logout
    document.getElementById('logoutBtn').addEventListener('click', function() {
        localStorage.removeItem('jwtToken');
        window.location.href = '../index.html'; // Redireciona para a p√°gina de login
    });

    // 3. Event Listener para Busca
    document.getElementById('searchInput').addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase();
        const rows = document.querySelectorAll('#tabelaVoluntarios tr');
        rows.forEach(row => {
            // Verifica se o texto da linha inclui o termo de busca E se est√° vis√≠vel pelo filtro de status
            const statusFilter = document.getElementById('filtroStatus').value.toLowerCase();
            const matchesSearch = row.textContent.toLowerCase().includes(searchTerm);
            const matchesStatus = !statusFilter || row.textContent.toLowerCase().includes(statusFilter);
            
            row.style.display = (matchesSearch && matchesStatus) ? '' : 'none';
        });
    });
});

// Fun√ß√µes globais de UI (mantidas para compatibilidade com o HTML)

function filtrarPorStatus() {
    const status = document.getElementById('filtroStatus').value.toLowerCase();
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const rows = document.querySelectorAll('#tabelaVoluntarios tr');
    
    rows.forEach(row => {
        // Verifica se o texto da linha inclui o status filtrado E se est√° vis√≠vel pela busca
        const matchesStatus = !status || row.textContent.toLowerCase().includes(status);
        const matchesSearch = row.textContent.toLowerCase().includes(searchTerm);

        row.style.display = (matchesStatus && matchesSearch) ? '' : 'none';
    });
}

function openModal(modalId) {
    if (modalId === 'modalVoluntario') {
        // Limpa o formul√°rio e erros ao abrir para "Novo Volunt√°rio"
        document.getElementById('formVoluntario').reset();
        Validator.clearAllErrors(document.getElementById('formVoluntario'));
        document.getElementById('voluntarioId').value = '';
        document.getElementById('modalTitle').textContent = 'Novo Volunt√°rio';
    }
    UI.openModal(modalId);
}

function closeModal(modalId) { 
    UI.closeModal(modalId); 
}
</script>
>>>>>>> f920d7edf7db4e47bf74d5fa54468951ca65c13a
</body>
</html>