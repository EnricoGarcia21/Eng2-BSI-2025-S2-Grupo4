<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DOARC - Minha √Årea</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <header class="header">
        <div class="header-content">
            <a href="dashboard.html" class="logo">DOARC</a>
            <div class="user-menu">
                <span class="user-name" id="userName">Volunt√°rio</span>
                <button class="btn-logout" id="logoutBtn">Sair</button>
            </div>
        </div>
    </header>

    <nav class="nav">
        <ul class="nav-list">
            <li class="nav-item"><a href="dashboard.html" class="nav-link">Dashboard</a></li>
            <li class="nav-item"><a href="minha-area.html" class="nav-link active">Minha √Årea</a></li>
            
            <li class="nav-item">
                <a href="#" class="nav-link">Doa√ß√µes</a>
                <ul class="submenu">
                    <li class="submenu-item"><a href="receber-doacoes.html" class="submenu-link">Receber Doa√ß√µes</a></li>
                    <li class="submenu-item"><a href="efetuar-doacoes.html" class="submenu-link">Efetuar Doa√ß√µes</a></li>
                </ul>
            </li>
            <li class="nav-item"><a href="relatorios.html" class="nav-link">Relat√≥rios</a></li>
        </ul>
    </nav>

    <main class="container">
        <div class="breadcrumb">
            <div class="breadcrumb-item"><a href="dashboard.html">Dashboard</a></div>
            <div class="breadcrumb-item active">Minha √Årea</div>
        </div>

        <div class="card">
            <div class="card-header">
                <h1 class="card-title">üéØ Minhas Campanhas</h1>
                <p class="card-subtitle">Campanhas onde voc√™ est√° escalado como respons√°vel ou membro</p>
            </div>
            <div class="card-body">
                <div class="table-container">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Campanha</th>
                                <th>Per√≠odo</th>
                                <th>Meta</th>
                                <th>Progresso</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaMinhasCampanhas">
                            <tr><td colspan="5" class="text-center">Carregando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="card" style="margin-top: 2rem;">
            <div class="card-header">
                <h1 class="card-title">ü§ù Nossa Equipe</h1>
                <p class="card-subtitle">Lista de contato dos volunt√°rios ativos</p>
            </div>
            <div class="card-body">
                <div style="display: flex; justify-content: flex-end; margin-bottom: 1rem;">
                    <input type="text" id="buscaVoluntario" class="form-control" placeholder="Buscar colega..." style="max-width: 300px;">
                </div>
                <div class="table-container">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>E-mail</th>
                                <th>Telefone</th>
                                <th>A√ß√£o</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaEquipe">
                            <tr><td colspan="4" class="text-center">Carregando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <script src="../js/app.js"></script>
    <script>
        // Configura√ß√£o da API
        const API_BASE = "http://localhost:8080/apis";

        // Fun√ß√£o auxiliar de Headers
        const getHeaders = () => {
            const headers = new Headers();
            headers.append("Content-Type", "application/json");
            const token = localStorage.getItem('token');
            if (token) headers.append("Authorization", `Bearer ${token}`);
            return headers;
        };

        // Formatar Data
        function formatarData(data) {
            if(!data) return '-';
            return new Date(data).toLocaleDateString('pt-BR');
        }

        // --- CARREGAR MINHAS CAMPANHAS ---
        async function carregarMinhasCampanhas() {
            const user = JSON.parse(localStorage.getItem('user'));
            if (!user || !user.voluntarioId) {
                document.getElementById('tabelaMinhasCampanhas').innerHTML = '<tr><td colspan="5" class="text-center">Erro: Usu√°rio n√£o identificado.</td></tr>';
                return;
            }

            try {
                // Rota que busca campanhas do ID logado
                const response = await fetch(`${API_BASE}/campanha/voluntario/${user.voluntarioId}`, { headers: getHeaders() });
                const campanhas = await response.json();

                const tbody = document.getElementById('tabelaMinhasCampanhas');
                tbody.innerHTML = '';

                if (!campanhas || campanhas.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center">Voc√™ n√£o est√° vinculado a nenhuma campanha no momento.</td></tr>';
                    return;
                }

                campanhas.forEach(camp => {
                    const progresso = camp.cam_meta_arrecadacao > 0 
                        ? (camp.cam_valor_arrecadado / camp.cam_meta_arrecadacao) * 100 
                        : 0;
                    
                    const hoje = new Date();
                    const fim = new Date(camp.cam_data_fim);
                    const status = fim >= hoje ? 'Ativa' : 'Encerrada';
                    const badge = status === 'Ativa' ? 'success' : 'secondary';

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><strong>${camp.cam_desc}</strong></td>
                        <td>${formatarData(camp.cam_data_ini)} a ${formatarData(camp.cam_data_fim)}</td>
                        <td>R$ ${camp.cam_meta_arrecadacao?.toLocaleString('pt-BR')}</td>
                        <td style="width: 20%;">
                            <div style="background:#eee; border-radius:4px; height:8px; width:100%;">
                                <div style="background:var(--success-color); width:${Math.min(progresso, 100)}%; height:100%; border-radius:4px;"></div>
                            </div>
                            <small>${progresso.toFixed(1)}%</small>
                        </td>
                        <td><span class="badge badge-${badge}">${status}</span></td>
                    `;
                    tbody.appendChild(tr);
                });

            } catch (error) {
                console.error(error);
                document.getElementById('tabelaMinhasCampanhas').innerHTML = '<tr><td colspan="5" class="text-center text-danger">Erro ao carregar campanhas.</td></tr>';
            }
        }

        // --- CARREGAR EQUIPE (DADOS P√öBLICOS) ---
        async function carregarEquipe() {
            try {
                // Chama a nova rota p√∫blica da equipe
                const response = await fetch(`${API_BASE}/voluntario/equipe`, { headers: getHeaders() });
                const equipe = await response.json();

                const tbody = document.getElementById('tabelaEquipe');
                tbody.innerHTML = '';

                if (!equipe || equipe.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center">Nenhum volunt√°rio encontrado.</td></tr>';
                    return;
                }

                equipe.forEach(vol => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${vol.vol_nome}</td>
                        <td>${vol.vol_email}</td>
                        <td>${vol.vol_telefone}</td>
                        <td>
                            <a href="mailto:${vol.vol_email}" class="btn btn-sm btn-info" title="Enviar E-mail">‚úâÔ∏è</a>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });

                // Filtro de busca local
                document.getElementById('buscaVoluntario').addEventListener('input', (e) => {
                    const term = e.target.value.toLowerCase();
                    const rows = tbody.querySelectorAll('tr');
                    rows.forEach(row => {
                        const text = row.textContent.toLowerCase();
                        row.style.display = text.includes(term) ? '' : 'none';
                    });
                });

            } catch (error) {
                console.error(error);
                document.getElementById('tabelaEquipe').innerHTML = '<tr><td colspan="4" class="text-center text-danger">Erro ao carregar equipe.</td></tr>';
            }
        }

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', () => {
            // Atualiza nome do usu√°rio no header
            const user = JSON.parse(localStorage.getItem('user'));
            if(user && document.getElementById('userName')) {
                document.getElementById('userName').textContent = user.nome || "Volunt√°rio";
            }

            carregarMinhasCampanhas();
            carregarEquipe();

            // Logout
            document.getElementById('logoutBtn').addEventListener('click', () => {
                localStorage.removeItem('jwtToken');
                localStorage.removeItem('user');
                window.location.href = '../index.html';
            });
        });
    </script>
</body>
</html>