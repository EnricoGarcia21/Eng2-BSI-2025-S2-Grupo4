<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DOARC - Acerto de Estoque</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <a href="dashboard.html" class="logo">DOARC</a>
            <div class="user-menu">
                <span class="user-name" id="userName">Volunt√°rio</span>
                <button class="btn-logout" id="logoutBtn">Sair</button>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="nav">
        <ul class="nav-list">
            <li class="nav-item">
                <a href="dashboard.html" class="nav-link">Dashboard</a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link">Gerenciar</a>
                <ul class="submenu">
                    <li class="submenu-item"><a href="gerenciar-doadores.html" class="submenu-link">Doadores</a></li>
                    <li class="submenu-item"><a href="gerenciar-donatarios.html" class="submenu-link">Donat√°rios</a></li>
                    <li class="submenu-item"><a href="gerenciar-produtos.html" class="submenu-link">Produtos</a></li>
                    <li class="submenu-item"><a href="gerenciar-categorias.html" class="submenu-link">Categorias</a></li>
                    <li class="submenu-item"><a href="gerenciar-voluntarios.html" class="submenu-link">Volunt√°rios</a></li>
                    <li class="submenu-item"><a href="gerenciar-campanhas.html" class="submenu-link">Campanhas</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link">Doa√ß√µes</a>
                <ul class="submenu">
                    <li class="submenu-item"><a href="receber-doacoes.html" class="submenu-link">Receber Doa√ß√µes</a></li>
                    <li class="submenu-item"><a href="efetuar-doacoes.html" class="submenu-link">Efetuar Doa√ß√µes</a></li>
                    <li class="submenu-item"><a href="agendar-doacao.html" class="submenu-link">Agendar Doa√ß√£o</a></li>
                    <li class="submenu-item"><a href="agendar-retirada.html" class="submenu-link">Agendar Retirada</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link active">Estoque</a>
                <ul class="submenu">
                    <li class="submenu-item"><a href="visualizar-estoque.html" class="submenu-link">Visualizar Estoque</a></li>
                    <li class="submenu-item"><a href="registrar-acerto.html" class="submenu-link">Acerto de Estoque</a></li>
                    <li class="submenu-item"><a href="lancar-compra.html" class="submenu-link">Lan√ßar Compra/Arrecada√ß√£o</a></li>
                    <li class="submenu-item"><a href="agendar-higienizacao.html" class="submenu-link">Agendar Higieniza√ß√£o</a></li>
                </ul>
            </li>
            <li class="nav-item">
                <a href="relatorios.html" class="nav-link">Relat√≥rios</a>
            </li>
        </ul>
    </nav>

    <!-- Main Content -->
    <main class="container">
        <div class="breadcrumb">
            <div class="breadcrumb-item"><a href="dashboard.html">Dashboard</a></div>
            <div class="breadcrumb-item">Estoque</div>
            <div class="breadcrumb-item active">Acerto de Estoque</div>
        </div>

        <div class="card">
            <div class="card-header">
                <h1 class="card-title">Acerto de Estoque</h1>
                <p class="card-subtitle">Registre ajustes de invent√°rio e corre√ß√µes de estoque</p>
            </div>
            <div class="card-body">
                <form id="formAcertoEstoque">
                    <!-- Sele√ß√£o do Produto -->
                    <h3 style="color: var(--primary-color); margin-bottom: 1rem;">Identifica√ß√£o do Produto</h3>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="categoria" class="form-label required">Categoria</label>
                            <select id="categoria" class="form-control form-select" required onchange="carregarProdutos()">
                                <option value="">Selecione uma categoria</option>
                                <!-- Categorias carregadas dinamicamente -->
                            </select>
                            <div class="form-error">Selecione uma categoria</div>
                        </div>

                        <div class="form-group">
                            <label for="produto" class="form-label required">Produto</label>
                            <select id="produto" class="form-control form-select" required onchange="carregarEstoqueAtual()">
                                <option value="">Selecione um produto</option>
                            </select>
                            <div class="form-error">Selecione um produto</div>
                        </div>
                    </div>

                    <!-- Estoque Atual -->
                    <div id="infoEstoqueAtual" style="display: none; padding: 1rem; background: #e8f4f8; border-radius: 8px; margin-bottom: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>Estoque Atual no Sistema:</strong>
                                <span id="estoqueAtual" style="font-size: 1.5rem; color: var(--primary-color); margin-left: 1rem;">0</span>
                                <span id="unidadeEstoque"></span>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline" onclick="verHistoricoProduto()">
                                üìã Ver Hist√≥rico
                            </button>
                        </div>
                    </div>

                    <!-- Tipo de Acerto -->
                    <h3 style="color: var(--primary-color); margin: 2rem 0 1rem;">Tipo de Ajuste</h3>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="tipoAcerto" class="form-label required">Tipo de Acerto</label>
                            <select id="tipoAcerto" class="form-control form-select" required onchange="atualizarPrevisao()">
                                <option value="">Selecione o tipo</option>
                                <option value="adicao">Adi√ß√£o (+) - Adicionar ao estoque</option>
                                <option value="subtracao">Subtra√ß√£o (-) - Remover do estoque</option>
                                <option value="correcao">Corre√ß√£o (=) - Definir novo valor</option>
                            </select>
                            <div class="form-error">Selecione o tipo de acerto</div>
                        </div>

                        <div class="form-group">
                            <label for="quantidade" class="form-label required">Quantidade</label>
                            <input type="number" id="quantidade" class="form-control" min="0" step="0.01" required onchange="atualizarPrevisao()">
                            <div class="form-error">Informe a quantidade</div>
                        </div>
                    </div>

                    <!-- Previs√£o do Resultado -->
                    <div id="previsaoEstoque" style="display: none; padding: 1rem; background: #fff3cd; border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid var(--warning-color);">
                        <strong>Previs√£o ap√≥s acerto:</strong>
                        <span id="estoquePrevisao" style="font-size: 1.3rem; color: var(--primary-color); margin-left: 1rem; font-weight: bold;">0</span>
                        <span id="unidadePrevisao"></span>
                    </div>

                    <!-- Motivo do Acerto -->
                    <h3 style="color: var(--primary-color); margin: 2rem 0 1rem;">Justificativa (Obrigat√≥ria)</h3>

                    <div class="form-group">
                        <label for="motivoAcerto" class="form-label required">Motivo do Acerto</label>
                        <select id="motivoAcerto" class="form-control form-select" required onchange="toggleOutroMotivo()">
                            <option value="">Selecione um motivo</option>
                            <option value="inventario">Invent√°rio f√≠sico</option>
                            <option value="erro_lancamento">Erro de lan√ßamento anterior</option>
                            <option value="perda">Perda/Quebra de produto</option>
                            <option value="vencimento">Produto vencido/descartado</option>
                            <option value="dano">Produto danificado</option>
                            <option value="diferenca">Diferen√ßa na contagem</option>
                            <option value="outro">Outro motivo</option>
                        </select>
                        <div class="form-error">Selecione um motivo</div>
                    </div>

                    <div class="form-group" id="outroMotivoDiv" style="display: none;">
                        <label for="outroMotivo" class="form-label required">Especifique o Motivo</label>
                        <input type="text" id="outroMotivo" class="form-control" placeholder="Descreva o motivo do acerto">
                    </div>

                    <div class="form-group">
                        <label for="observacoes" class="form-label required">Observa√ß√µes Detalhadas</label>
                        <textarea id="observacoes" class="form-control" rows="4" required placeholder="Descreva em detalhes o motivo do acerto de estoque..."></textarea>
                        <div class="form-error">As observa√ß√µes s√£o obrigat√≥rias</div>
                        <div class="form-text">Descreva detalhadamente o motivo do ajuste para fins de auditoria</div>
                    </div>

                    <!-- Informa√ß√µes Adicionais -->
                    <h3 style="color: var(--primary-color); margin: 2rem 0 1rem;">Informa√ß√µes Complementares</h3>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="dataAcerto" class="form-label required">Data do Acerto</label>
                            <input type="date" id="dataAcerto" class="form-control" required>
                            <div class="form-error">Data √© obrigat√≥ria</div>
                        </div>

                        <div class="form-group">
                            <label for="voluntarioResponsavel" class="form-label required">Respons√°vel</label>
                            <select id="voluntarioResponsavel" class="form-control form-select" required>
                                <option value="">Selecione um volunt√°rio</option>
                                <option value="1">Jo√£o Silva</option>
                                <option value="2">Maria Santos</option>
                                <option value="3">Pedro Oliveira</option>
                                <option value="4">Ana Costa</option>
                            </select>
                            <div class="form-error">Selecione o respons√°vel</div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" id="confirmarAcerto">
                            Confirmo que verifiquei o estoque f√≠sico e as informa√ß√µes est√£o corretas
                        </label>
                    </div>

                    <div class="card-footer">
                        <div class="btn-group">
                            <button type="button" class="btn btn-outline" onclick="window.location.href='visualizar-estoque.html'">
                                Cancelar
                            </button>
                            <button type="submit" class="btn btn-success">
                                ‚úì Registrar Acerto
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Hist√≥rico de Acertos -->
        <div class="card" style="margin-top: 2rem;">
            <div class="card-header">
                <h2 class="card-title">Acertos Recentes</h2>
            </div>
            <div class="card-body">
                <div class="table-container">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Produto</th>
                                <th>Tipo</th>
                                <th>Quantidade</th>
                                <th>Motivo</th>
                                <th>Respons√°vel</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaAcertos">
                            <tr>
                                <td>13/10/2025</td>
                                <td>Arroz Tipo 1</td>
                                <td><span class="badge badge-success">Adi√ß√£o</span></td>
                                <td>+5 kg</td>
                                <td>Invent√°rio f√≠sico</td>
                                <td>Jo√£o Silva</td>
                                <td>
                                    <button class="btn btn-sm btn-info" onclick="verDetalhesAcerto(1)" title="Ver detalhes">üëÅÔ∏è</button>
                                </td>
                            </tr>
                            <tr>
                                <td>12/10/2025</td>
                                <td>Feij√£o Preto</td>
                                <td><span class="badge badge-danger">Subtra√ß√£o</span></td>
                                <td>-3 kg</td>
                                <td>Produto vencido</td>
                                <td>Maria Santos</td>
                                <td>
                                    <button class="btn btn-sm btn-info" onclick="verDetalhesAcerto(2)" title="Ver detalhes">üëÅÔ∏è</button>
                                </td>
                            </tr>
                            <tr>
                                <td>10/10/2025</td>
                                <td>Camisetas Tamanho M</td>
                                <td><span class="badge badge-warning">Corre√ß√£o</span></td>
                                <td>= 40 un</td>
                                <td>Diferen√ßa na contagem</td>
                                <td>Pedro Oliveira</td>
                                <td>
                                    <button class="btn btn-sm btn-info" onclick="verDetalhesAcerto(3)" title="Ver detalhes">üëÅÔ∏è</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <script src="../js/app.js"></script>
    <script>
        // API Base URLs
        const API_ACERTO = 'http://localhost:8080/apis/acerto-estoque';
        const API_PRODUTO = 'http://localhost:8080/apis/produto';
        const API_CATEGORIA = 'http://localhost:8080/apis/categoria';

        // Definir data de hoje como padr√£o
        document.getElementById('dataAcerto').valueAsDate = new Date();

        // Cache de produtos
        let produtosCache = {};

        // Carrega categorias ao iniciar
        document.addEventListener('DOMContentLoaded', function() {
            carregarCategorias();
            carregarAcertosRecentes();
        });

        async function carregarCategorias() {
            try {
                const response = await fetch(API_CATEGORIA);
                if (!response.ok) throw new Error('Erro ao buscar categorias');

                const categorias = await response.json();
                const categoriaSelect = document.getElementById('categoria');

                categorias.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.id;
                    option.textContent = cat.nome;
                    categoriaSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Erro ao carregar categorias:', error);
                alert('Erro ao carregar categorias. Verifique se o backend est√° rodando.');
            }
        }

        async function carregarProdutos() {
            const categoriaId = document.getElementById('categoria').value;
            const selectProduto = document.getElementById('produto');

            selectProduto.innerHTML = '<option value="">Selecione um produto</option>';
            document.getElementById('infoEstoqueAtual').style.display = 'none';
            document.getElementById('previsaoEstoque').style.display = 'none';

            if (!categoriaId) return;

            try {
                const response = await fetch(`${API_PRODUTO}?categoria_id=${categoriaId}`);
                if (!response.ok) throw new Error('Erro ao buscar produtos');

                const produtos = await response.json();
                produtosCache = {}; // Limpa o cache

                produtos.forEach(prod => {
                    const option = document.createElement('option');
                    option.value = prod.id;
                    option.textContent = prod.nome;
                    selectProduto.appendChild(option);

                    // Armazena no cache para uso posterior
                    produtosCache[prod.id] = prod;
                });
            } catch (error) {
                console.error('Erro ao carregar produtos:', error);
                alert('Erro ao carregar produtos da categoria selecionada.');
            }
        }

        function carregarEstoqueAtual() {
            const produtoId = document.getElementById('produto').value;

            if (!produtoId) {
                document.getElementById('infoEstoqueAtual').style.display = 'none';
                return;
            }

            const produto = produtosCache[produtoId];
            if (produto) {
                document.getElementById('estoqueAtual').textContent = produto.quantidade;
                document.getElementById('unidadeEstoque').textContent = 'un';
                document.getElementById('infoEstoqueAtual').style.display = 'block';
            }
        }

        function atualizarPrevisao() {
            const produtoId = document.getElementById('produto').value;
            const tipoAcerto = document.getElementById('tipoAcerto').value;
            const quantidade = parseFloat(document.getElementById('quantidade').value) || 0;

            if (!produtoId || !tipoAcerto || quantidade <= 0) {
                document.getElementById('previsaoEstoque').style.display = 'none';
                return;
            }

            const produto = produtosCache[produtoId];
            if (!produto) return;

            let novoEstoque = produto.quantidade;

            if (tipoAcerto === 'adicao') {
                novoEstoque = produto.quantidade + quantidade;
            } else if (tipoAcerto === 'subtracao') {
                novoEstoque = produto.quantidade - quantidade;
            } else if (tipoAcerto === 'correcao') {
                novoEstoque = quantidade;
            }

            document.getElementById('estoquePrevisao').textContent = novoEstoque;
            document.getElementById('unidadePrevisao').textContent = 'un';
            document.getElementById('previsaoEstoque').style.display = 'block';

            // Alerta se o estoque ficar√° negativo
            if (novoEstoque < 0) {
                document.getElementById('previsaoEstoque').style.background = '#f8d7da';
                document.getElementById('previsaoEstoque').style.borderColor = 'var(--danger-color)';
            } else {
                document.getElementById('previsaoEstoque').style.background = '#fff3cd';
                document.getElementById('previsaoEstoque').style.borderColor = 'var(--warning-color)';
            }
        }

        function toggleOutroMotivo() {
            const motivo = document.getElementById('motivoAcerto').value;
            const outroMotivoDiv = document.getElementById('outroMotivoDiv');
            outroMotivoDiv.style.display = motivo === 'outro' ? 'block' : 'none';
        }

        function verHistoricoProduto() {
            alert('Funcionalidade em desenvolvimento');
        }

        function verDetalhesAcerto(id) {
            alert('Funcionalidade em desenvolvimento');
        }

        async function carregarAcertosRecentes() {
            try {
                const response = await fetch(API_ACERTO);
                if (!response.ok) return;

                const acertos = await response.json();
                const tbody = document.getElementById('tabelaAcertos');
                tbody.innerHTML = '';

                acertos.slice(0, 10).forEach(acerto => {
                    const tr = document.createElement('tr');
                    const badgeClass = acerto.tipo === 'Entrada' ? 'badge-success' : 'badge-danger';
                    const sinalQtd = acerto.tipo === 'Entrada' ? '+' : '-';

                    tr.innerHTML = `
                        <td>${acerto.data}</td>
                        <td>${acerto.produto_nome || 'N/A'}</td>
                        <td><span class="badge ${badgeClass}">${acerto.tipo}</span></td>
                        <td>${sinalQtd}${acerto.quantidade}</td>
                        <td>${acerto.motivo}</td>
                        <td>Vol. ${acerto.voluntario_id}</td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="verDetalhesAcerto(${acerto.id})" title="Ver detalhes">üëÅÔ∏è</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (error) {
                console.error('Erro ao carregar acertos recentes:', error);
            }
        }

        // Submiss√£o do formul√°rio
        document.getElementById('formAcertoEstoque').addEventListener('submit', async function(e) {
            e.preventDefault();

            const categoria = document.getElementById('categoria');
            const produto = document.getElementById('produto');
            const tipoAcerto = document.getElementById('tipoAcerto');
            const quantidade = document.getElementById('quantidade');
            const motivoAcerto = document.getElementById('motivoAcerto');
            const observacoes = document.getElementById('observacoes');
            const dataAcerto = document.getElementById('dataAcerto');
            const voluntarioResponsavel = document.getElementById('voluntarioResponsavel');
            const confirmarAcerto = document.getElementById('confirmarAcerto');

            Validator.clearAllErrors(this);
            let isValid = true;

            if (!categoria.value) {
                Validator.showError(categoria, 'Selecione uma categoria');
                isValid = false;
            }

            if (!produto.value) {
                Validator.showError(produto, 'Selecione um produto');
                isValid = false;
            }

            if (!tipoAcerto.value) {
                Validator.showError(tipoAcerto, 'Selecione o tipo de acerto');
                isValid = false;
            }

            if (!quantidade.value || parseFloat(quantidade.value) <= 0) {
                Validator.showError(quantidade, 'Informe uma quantidade v√°lida');
                isValid = false;
            }

            if (!motivoAcerto.value) {
                Validator.showError(motivoAcerto, 'Selecione um motivo');
                isValid = false;
            }

            if (motivoAcerto.value === 'outro') {
                const outroMotivo = document.getElementById('outroMotivo');
                if (!outroMotivo.value) {
                    Validator.showError(outroMotivo, 'Especifique o motivo');
                    isValid = false;
                }
            }

            if (!observacoes.value || observacoes.value.trim().length < 10) {
                Validator.showError(observacoes, 'As observa√ß√µes devem ter pelo menos 10 caracteres');
                isValid = false;
            }

            if (!dataAcerto.value) {
                Validator.showError(dataAcerto, 'Informe a data');
                isValid = false;
            }

            if (!voluntarioResponsavel.value) {
                Validator.showError(voluntarioResponsavel, 'Selecione o respons√°vel');
                isValid = false;
            }

            if (!confirmarAcerto.checked) {
                UI.showAlert('Voc√™ precisa confirmar que verificou o estoque f√≠sico', 'warning');
                isValid = false;
            }

            if (!isValid) return;

            try {
                // Mapeamento dos motivos do frontend para o backend
                const motivosMap = {
                    'inventario': 'Ajuste',
                    'erro_lancamento': 'Ajuste',
                    'perda': 'Perda',
                    'vencimento': 'Vencimento',
                    'dano': 'Perda',
                    'diferenca': 'Ajuste',
                    'outro': 'Outro'
                };

                // Mapeamento dos tipos (frontend usa adicao/subtracao/correcao, backend usa Entrada/Sa√≠da)
                let tipo, qtd;
                const tipoFrontend = tipoAcerto.value;
                const quantidade = parseFloat(document.getElementById('quantidade').value);
                const produto = produtosCache[document.getElementById('produto').value];

                if (tipoFrontend === 'adicao') {
                    tipo = 'Entrada';
                    qtd = quantidade;
                } else if (tipoFrontend === 'subtracao') {
                    tipo = 'Sa√≠da';
                    qtd = quantidade;
                } else if (tipoFrontend === 'correcao') {
                    // Corre√ß√£o: calcula se √© entrada ou sa√≠da baseado no estoque atual
                    const estoqueAtual = produto.quantidade;
                    if (quantidade > estoqueAtual) {
                        tipo = 'Entrada';
                        qtd = quantidade - estoqueAtual;
                    } else {
                        tipo = 'Sa√≠da';
                        qtd = estoqueAtual - quantidade;
                    }
                }

                const motivoValue = motivoAcerto.value === 'outro'
                    ? document.getElementById('outroMotivo').value
                    : motivosMap[motivoAcerto.value] || 'Ajuste';

                const params = new URLSearchParams();
                params.append('ac_data', dataAcerto.value);
                params.append('ac_motivo', motivoValue);
                params.append('ac_obs', observacoes.value);
                params.append('ac_tipo', tipo);
                params.append('ac_quantidade', qtd);
                params.append('vol_id', voluntarioResponsavel.value || '1');
                params.append('prod_id', document.getElementById('produto').value);

                const response = await fetch(`${API_ACERTO}?${params.toString()}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                });

                if (response.ok) {
                    alert('Acerto de estoque registrado com sucesso!');
                    window.location.href = 'visualizar-estoque.html';
                } else {
                    const error = await response.json();
                    throw new Error(error.mensagem || 'Erro ao registrar acerto');
                }

            } catch (error) {
                console.error('Erro ao registrar acerto:', error);
                alert('Erro ao registrar acerto: ' + error.message);
            }
        });
    </script>
</body>
</html>
